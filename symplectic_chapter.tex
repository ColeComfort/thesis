
In this chapter, we will give a relational account of stabilizer codes/mixed stabilizer circuits using linear and affine symplectic geometry.
The objects of study are symplectic vector spaces: capturing the possible configurations of position and momentum, along with a symplectic form which determines their commutation. The morphisms of study  are categories of (affine) (co)isotropic relations: capturing the possibilistic evolution of the mechanical system in a way that preserves the commutation relation between position and momentum.

In Section \ref{sec:sym}, we give an overview of the theory of linear Lagrangian relations using the language of graphical linear algebra. In Section \ref{sec:univ}, we give generators for Lagrangian relations; showing that for prime fields, Lagrangian relations can be presented as a CPM construction over linear relations with respect to the orthogonal complement.
In Section \ref{sec:aff} we show that only one more generator is needed to obtain {\em affine} Lagrangian relations.  In the case of odd prime fields, we show in Theorem \ref{theorem:spekkens} that affine Lagrangian relations are prime-dimensional qudit stabilizer circuits, modulo invertible scalars.  This give a graphical calculus extends to previous work on the qubit \cite{backensspek}, and qutrit \cite{qutrit} cases.  We also discuss the relation to electrical circuits.
In Section \ref{sec:coisot} we add discarding to (affine) Lagrangian relations.  We show that this gives a semantics for stabilizer codes.  By splitting decoherence maps, we get another category of affine/linear relations.  We show that this gives semantics for state preparation and measurement of stabilizer codes, as well as electrical circuits with controlled voltage and current sources.

\section{Linear symplectic geometry}
\label{sec:sym}

We first develop the basic theory of linear symplectic geometry, then we give compositional account of this theory in terms of linear relations and graphical linear algebra. This will allow us to capture even larger fragments of quantum theory with this semantics of  $\F_p$ linear/affine subspaces. 


\subsection{Linear symplectic geometry}
We briefly overview linear symplectic geomety.  A more detailed introduction can be found in \cite{weinsteinsymplectic}.
\begin{definition}
  Given a field  $k$ and a $k$-vector space $V$, a {\bf symplectic form} on $V$ is a bilinear map $\omega:V\times V\to k$ which is:
\begin{description}
 \item[\ \ Alternating] $\forall v \in V$, $\omega(v,v)=0$.
 \item[\ \ Non-degenerate] if $\exists v \in V: \forall w \in V: \omega(v,w)=0$, then $v=0$.
\end{description}
  A {\bf symplectic vector space} is a vector space equipped with a symplectic form. A (linear) {\bf symplectomorphism} is a linear isomorphism between symplectic vector spaces that preserves the symplectic form.
\end{definition}


\begin{lemma}
\label{lemma:sform}
Every vector space $k^{2n}$ with a chosen basis is equipped with a bilinear form given by the following block matrix:
$$
\omega:=
\begin{bmatrix}
0_n & I_n\\
-I_n & 0_n
\end{bmatrix}
$$
so that $\omega(v,w) := v \omega w^T$.
Moreover, every finite dimensional symplectic vector space over $k$ is symplectomorphic to one of the form $k^{2n}$ with such a symplectic form.
\end{lemma}


\begin{definition}

Let $W \subseteq V$ be a linear subspace of a symplectic space $V$.
The {\bf symplectic dual} of the subspace $W$ is defined to be
$
W^\omega:= \{v \in V : \forall w \in W, \omega(v,w)=0 \}
$.
A linear subspace  $W$ of a symplectic vector space $V$ is {\bf isotropic} when $W^\omega \supseteq W$, {\bf coisotropic} when $W^\omega \subseteq W$ and {\bf Lagrangian} when $W^\omega=W$.
\end{definition}
Notice that the symplectic complement reverses the order of inclusion, so that coisotropic subspaces are turned into isotropic subspaces and vice versa.  All of these subspaces generalize the notion of symplectomorphism:

\begin{lemma}
Every symplectomorphism $f:V\to V$ induces a Lagrangian subspace $\Gamma_f:=\{ (fv, v) | v \in V \}$.
\end{lemma}

As a matter of convention, we consider linear subspaces as being represented as the row space of a matrix.
An isotropic subspace can equivalently be characterized as the $k$-linear row space of a matrix $[Z|X]$ so that $[Z|X] \omega [Z|X]^T = 0$.
Moreover, a Lagrangian subspace can be described as a matrix satisfying this equation which additionally has rank $n$.

In linear mechanical systems, symplectic vector spaces over $\R$ are interpreted as  the phase space: ie the space of all allowable configurations of position and momentum.  The Lagrangian subspaces are interpreted as the initial configurations of the mechanical system, and the symplectomorphisms describe the reversible evolution of the system. 

 The following  categories of isotropic/coisotropic/Lagrangian relations generalizes symplectomorphisms in a way that allows possibilistic evolution:

\begin{definition}
Given a field $k$, the prop of {\bf Lagrangian relations},  $\Lag\Rel_k$ has morphisms $n\to m$ being Lagrangian subspaces of the symplectic vector space $k^{n+m} \oplus k^{n+m}$ with respect to the symplectic form given above.  Composition is given by relational composition. The tensor product is given by the direct sum, where the $Z$ and $X$ gradients are grouped together as follows:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (616) at (272, 0) {$V$};
		\node [style=none] (617) at (271.75, 1) {};
		\node [style=none] (618) at (272.25, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=60] (616) to (618.center);
		\draw [in=-90, out=120] (616) to (617.center);
	\end{pgfonlayer}
\end{tikzpicture}
\oplus
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (616) at (272, 0) {$W$};
		\node [style=none] (617) at (271.75, 1) {};
		\node [style=none] (618) at (272.25, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=60] (616) to (618.center);
		\draw [in=-90, out=120] (616) to (617.center);
	\end{pgfonlayer}
\end{tikzpicture}
:=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (616) at (272, 0) {$V$};
		\node [style=none] (617) at (271.75, 1) {};
		\node [style=none] (618) at (272.75, 1) {};
		\node [style=map] (619) at (272.75, 0) {$W$};
		\node [style=none] (620) at (272, 1) {};
		\node [style=none] (621) at (273, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=60] (616) to (618.center);
		\draw [in=-90, out=120] (616) to (617.center);
		\draw [in=-90, out=60] (619) to (621.center);
		\draw [in=-90, out=120] (619) to (620.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

The props of {\bf isotropic relations} and {\bf coisotropic relations}, $\Isot\Rel_{k}$ and $\Co\Isot\Rel_{k}$ are defined in the obvious analogous ways.
\end{definition}

%For the purposes of this paper, because it is so much easier to work in a prop, we will draw string diagram in the skeleton of $\Lag\Rel_k$ whose objects are all of the form $k^{2n}$ equipped with the symplectic form of Lemma \ref{lemma:sform}.

The direct sum of of such subspaces is graphically depicted as follows:

%Where we are grouping the $X$ gradings together on the left and the $Z$ gradings together on the right. Note that this means the embedding of $\Lag\Rel_k$ into $\LinRel_k$ preserves the monoidal product only up to isomorphism. More precisely, we have the following fact.

\begin{lemma}
\label{lemma:strong}
The forgetful functors fom Lagrangian/isotropic/cosisotropic relations  are faithful, strong symmetric monoidal.
\end{lemma}

\begin{proof}
Take $E$ to be one of the three forgetful functors.
  Functoriality and faithfulness is immediate. The strong monoidal structure is given by $E(I) = I$ and
  \[ E(A) \oplus E(B) := A \oplus A \oplus B \oplus B \xrightarrow{1 \oplus \sigma \oplus 1} A \oplus B \oplus A \oplus B =: E(A \oplus B). \]
\end{proof}


Due to the above lemma, we will regard $\Lag\Rel_k$, $\Isot\Rel_k$, $\Co\Isot\Rel_k$ as symmetric monoidal subcategories of $\LinRel_k$.

As such, we can ask what the generators of $\Lag\Rel_k$, $\Isot\Rel_k$ and $\Co\Isot\Rel_k$ look like in terms of string diagrams of linear relations. We first describe what it means to be a Lagrangian relation in pictures.

Concretely, the symplectic dual of a linear subspace $W \subseteq V$ is:
\begin{align*}
W^\omega :&= \{(v_1,v_2) \in V : \forall (w_1,w_2) \in W, \omega((v_1,v_2),(w_1,w_2))=0 \}\\
                    &= \{(v_1,v_2) \in V : \forall (w_1,w_2) \in W,  \langle (v_2,-v_1) ,(w_1,w_2)\rangle =0 \}\\
                    &= \{(v_2,-v_1) \in V : \forall (w_1,w_2) \in W,  \langle (v_1,v_2) ,(w_1,w_2)\rangle =0 \}
\end{align*}

Therefore, the condition asking that $W=W^\omega$ is graphically:

\begin{equation}
\label{eq:lag}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.75, -1) {$W$};
		\node [style=none] (1) at (0.5, 0) {};
		\node [style=none] (2) at (1, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.75, -1.75) {$W^\perp$};
		\node [style=none] (1) at (0.5, -1) {};
		\node [style=none] (2) at (1, -1) {};
		\node [style=none] (3) at (1, 0) {};
		\node [style=none] (4) at (0.5, 0) {};
		\node [style=s] (5) at (1, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-90, out=90] (2.center) to (4.center);
		\draw [in=-270, out=-90] (3.center) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{equation}


The category of Lagrangian relations is compact closed.  Given a relation $V$ between symplectic vector spaces, we can curry it into a state $\hat V$; and similarily, we can uncurry a state $W$ into a process $\widecheck W$,
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.75, -1.75) {$V$};
		\node [style=none] (1) at (0.5, -1) {};
		\node [style=none] (2) at (1, -1) {};
		\node [style=none] (3) at (0.5, -2.5) {};
		\node [style=none] (4) at (1, -2.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-60, out=90] (4.center) to (0);
		\draw [in=90, out=-120] (0) to (3.center);
	\end{pgfonlayer}
\end{tikzpicture}
\xmapsto{\hat{(\_)} }
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.75, -1.75) {$V$};
		\node [style=none] (1) at (0, -1) {};
		\node [style=none] (2) at (1.25, -1) {};
		\node [style=none] (4) at (1.25, -2.5) {};
		\node [style=X] (5) at (0, -3) {};
		\node [style=Z] (6) at (0.75, -3) {};
		\node [style=none] (7) at (0.75, -1) {};
		\node [style=none] (8) at (-0.5, -1) {};
		\node [style=none] (9) at (0, -2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-45, out=90] (4.center) to (0);
		\draw [in=-90, out=135, looseness=0.75] (5) to (8.center);
		\draw [in=30, out=-90] (4.center) to (6);
		\draw [in=90, out=-90] (7.center) to (9.center);
		\draw [in=150, out=-90] (9.center) to (6);
		\draw [in=45, out=-135] (0) to (5);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{1cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (1.5, -2) {$W$};
		\node [style=none] (1) at (1.25, -1) {};
		\node [style=none] (2) at (2.25, -1) {};
		\node [style=none] (6) at (1.75, -1) {};
		\node [style=none] (7) at (0.75, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=105, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=120, out=-90] (7.center) to (0);
		\draw [in=-90, out=75] (0) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
\xmapsto{\widecheck{(\_)} }
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (1.75, -2.25) {$W$};
		\node [style=none] (1) at (1, -0.75) {};
		\node [style=none] (2) at (2, -0.75) {};
		\node [style=none] (6) at (1.5, -1.25) {};
		\node [style=none] (7) at (0.75, -1.25) {};
		\node [style=Z] (8) at (1.5, -1.25) {};
		\node [style=X] (9) at (0.75, -1.25) {};
		\node [style=none] (10) at (0.25, -2.5) {};
		\node [style=none] (11) at (1, -2.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=105, out=-90, looseness=1.25] (1.center) to (0);
		\draw [in=-90, out=45, looseness=0.75] (0) to (2.center);
		\draw [in=135, out=-30] (7.center) to (0);
		\draw [in=-45, out=75] (0) to (6.center);
		\draw [in=-135, out=90] (10.center) to (9);
		\draw [in=-135, out=90] (11.center) to (8);
	\end{pgfonlayer}
\end{tikzpicture}
$$
It is easy to see that these two constructions are inverse to each other.
This allows us to derive a graphical criteria for abitrary Lagrangian relations, generalizing Equation \ref{eq:lag}:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.75, -1.75) {$V$};
		\node [style=none] (1) at (0, -0.75) {};
		\node [style=none] (2) at (1.25, -0.75) {};
		\node [style=none] (4) at (1.25, -2.5) {};
		\node [style=X] (5) at (0, -3) {};
		\node [style=Z] (6) at (0.75, -3) {};
		\node [style=none] (7) at (0.75, -0.75) {};
		\node [style=none] (8) at (-0.5, -0.75) {};
		\node [style=none] (9) at (0, -2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-45, out=90] (4.center) to (0);
		\draw [in=-90, out=135, looseness=0.75] (5) to (8.center);
		\draw [in=30, out=-90] (4.center) to (6);
		\draw [in=90, out=-90] (7.center) to (9.center);
		\draw [in=150, out=-90] (9.center) to (6);
		\draw [in=45, out=-135] (0) to (5);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (43) at (13.5, -1.75) {$V^\perp$};
		\node [style=none] (44) at (12.75, -0.75) {};
		\node [style=none] (45) at (14, -0.75) {};
		\node [style=none] (46) at (14, -2.5) {};
		\node [style=Z] (47) at (12.75, -3) {};
		\node [style=X] (48) at (13.5, -3) {};
		\node [style=none] (49) at (13.5, -0.75) {};
		\node [style=none] (50) at (12.25, -0.75) {};
		\node [style=none] (51) at (12.75, -2) {};
		\node [style=none] (52) at (13.5, 0.75) {};
		\node [style=none] (53) at (14, 0.75) {};
		\node [style=none] (54) at (12.25, 0.75) {};
		\node [style=none] (55) at (12.75, 0.75) {};
		\node [style=s] (56) at (14, -0.75) {};
		\node [style=s] (57) at (13.5, -0.75) {};
		\node [style=none] (58) at (13.25, -3.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (44.center) to (43);
		\draw [in=-90, out=60] (43) to (45.center);
		\draw [in=-45, out=90] (46.center) to (43);
		\draw [in=-90, out=135, looseness=0.75] (47) to (50.center);
		\draw [in=30, out=-90] (46.center) to (48);
		\draw [in=90, out=-90] (49.center) to (51.center);
		\draw [in=150, out=-90] (51.center) to (48);
		\draw [in=45, out=-135] (43) to (47);
		\draw [in=270, out=90] (45.center) to (55.center);
		\draw [in=270, out=90] (49.center) to (54.center);
		\draw [in=270, out=90] (44.center) to (53.center);
		\draw [in=270, out=90] (50.center) to (52.center);
	\end{pgfonlayer}
\end{tikzpicture}
\iff
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2, -2) {$V$};
		\node [style=none] (1) at (1.75, -1.25) {};
		\node [style=none] (2) at (2.25, -1.25) {};
		\node [style=none] (3) at (1.75, -2.75) {};
		\node [style=none] (4) at (2.25, -2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-60, out=90] (4.center) to (0);
		\draw [in=90, out=-120] (0) to (3.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, -1.75) {$V$};
		\node [style=none] (1) at (2, -0.5) {};
		\node [style=none] (2) at (3, -0.5) {};
		\node [style=none] (3) at (3, -2.5) {};
		\node [style=X] (4) at (1.75, -3) {};
		\node [style=Z] (5) at (2.5, -3) {};
		\node [style=none] (6) at (2.5, -0.75) {};
		\node [style=none] (7) at (1.5, -0.75) {};
		\node [style=none] (8) at (1.75, -2) {};
		\node [style=X] (9) at (1.5, -0.75) {};
		\node [style=Z] (10) at (2.5, -0.75) {};
		\node [style=none] (11) at (0.5, -3.25) {};
		\node [style=none] (12) at (1, -3.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-45, out=90] (3.center) to (0);
		\draw [in=-45, out=150] (4) to (7.center);
		\draw [in=30, out=-90] (3.center) to (5);
		\draw [in=90, out=-45, looseness=1.25] (6.center) to (8.center);
		\draw [in=150, out=-90] (8.center) to (5);
		\draw [in=45, out=-135] (0) to (4);
		\draw [in=90, out=-150] (10) to (12.center);
		\draw [in=90, out=-120] (9) to (11.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (59) at (17, -1.75) {$V^\perp$};
		\node [style=none] (60) at (16.25, -0.75) {};
		\node [style=none] (61) at (17.5, -0.75) {};
		\node [style=none] (62) at (17.5, -2.5) {};
		\node [style=Z] (63) at (16.25, -3) {};
		\node [style=X] (64) at (17, -3) {};
		\node [style=none] (65) at (17, -0.75) {};
		\node [style=none] (66) at (15.75, -0.75) {};
		\node [style=none] (67) at (16.25, -2) {};
		\node [style=none] (68) at (16.5, 0.75) {};
		\node [style=none] (69) at (17.5, 1) {};
		\node [style=none] (70) at (15.5, 0.75) {};
		\node [style=none] (71) at (16, 1) {};
		\node [style=s] (72) at (17.5, -0.75) {};
		\node [style=s] (73) at (17, -0.75) {};
		\node [style=X] (74) at (15.5, 0.75) {};
		\node [style=Z] (75) at (16.5, 0.75) {};
		\node [style=none] (76) at (15, -3.25) {};
		\node [style=none] (77) at (15.5, -3.25) {};
		\node [style=none] (78) at (16.5, 1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (60.center) to (59);
		\draw [in=-90, out=60] (59) to (61.center);
		\draw [in=-45, out=90] (62.center) to (59);
		\draw [in=-90, out=135, looseness=0.75] (63) to (66.center);
		\draw [in=30, out=-90] (62.center) to (64);
		\draw [in=90, out=-90] (65.center) to (67.center);
		\draw [in=150, out=-90] (67.center) to (64);
		\draw [in=45, out=-135] (59) to (63);
		\draw [in=-90, out=90, looseness=1.25] (61.center) to (71.center);
		\draw [in=-60, out=90] (65.center) to (70.center);
		\draw [in=270, out=90] (60.center) to (69.center);
		\draw [in=-45, out=90, looseness=1.25] (66.center) to (68.center);
		\draw [in=-135, out=90, looseness=0.50] (76.center) to (74);
		\draw [in=-150, out=90] (77.center) to (75);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (4.5, -1.75) {$V^\perp$};
		\node [style=none] (1) at (4, -1) {};
		\node [style=none] (2) at (5, -1) {};
		\node [style=none] (3) at (5, -2.5) {};
		\node [style=X] (4) at (4.75, -3) {};
		\node [style=none] (5) at (3.75, -2.25) {};
		\node [style=none] (6) at (5, 0) {};
		\node [style=none] (7) at (4, 0) {};
		\node [style=s] (8) at (5, -1) {};
		\node [style=none] (9) at (3.25, -3.25) {};
		\node [style=none] (10) at (4, -3.25) {};
		\node [style=Z] (11) at (3.75, -2.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-45, out=90] (3.center) to (0);
		\draw [in=30, out=-90] (3.center) to (4);
		\draw [in=165, out=-15, looseness=1.25] (5.center) to (4);
		\draw [in=-90, out=90, looseness=1.25] (2.center) to (7.center);
		\draw [in=270, out=90] (1.center) to (6.center);
		\draw [in=240, out=90] (10.center) to (0);
		\draw [in=90, out=-150] (11) to (9.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2, -2) {$V^\perp$};
		\node [style=none] (1) at (1.75, -1.25) {};
		\node [style=none] (2) at (2.25, -1.25) {};
		\node [style=none] (3) at (1.75, -2.75) {};
		\node [style=none] (4) at (2.25, -2.75) {};
		\node [style=none] (5) at (2.25, -0.5) {};
		\node [style=none] (6) at (1.75, -0.5) {};
		\node [style=none] (7) at (2.25, -3.5) {};
		\node [style=none] (8) at (1.75, -3.5) {};
		\node [style=s] (9) at (2.25, -1.25) {};
		\node [style=s] (10) at (2.25, -2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-60, out=90] (4.center) to (0);
		\draw [in=90, out=-120] (0) to (3.center);
		\draw [in=90, out=-90] (6.center) to (2.center);
		\draw [in=270, out=90] (1.center) to (5.center);
		\draw [in=270, out=90] (7.center) to (3.center);
		\draw [in=270, out=90] (8.center) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
For this reason, we will depict Lagrangian relations as processes, where the input wires are on the bottom and output wires on on the top.

\begin{lemma}
There is a faithful, strong symmetric monoidal functor $L:\LinRel_k\to\Lag\Rel_k$ given by the following action on the generators of $\ih_k$; doubling, and then changing the colours of one of the copies:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (-3, -1) {$V$};
		\node [style=none] (1) at (-3, -0.25) {};
		\node [style=none] (2) at (-3, -1.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (0);
		\draw (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (0.5, -1) {$V^\perp$};
		\node [style=none] (1) at (0.5, -0.25) {};
		\node [style=none] (2) at (0.5, -1.75) {};
		\node [style=map] (3) at (1.5, -1) {$V$};
		\node [style=none] (4) at (1.5, -0.25) {};
		\node [style=none] (5) at (1.5, -1.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (0);
		\draw (0) to (2.center);
		\draw (4.center) to (3);
		\draw (3) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
%
%$$
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=map] (0) at (-3, -1) {$V^\perp$};
%		\node [style=none] (1) at (-3, -0.25) {};
%		\node [style=none] (2) at (-3, -1.75) {};
%		\node [style=map] (3) at (-2.25, -1) {$V$};
%		\node [style=none] (4) at (-2.25, -0.25) {};
%		\node [style=none] (5) at (-2.25, -1.75) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (1.center) to (0);
%		\draw (0) to (2.center);
%		\draw (4.center) to (3);
%		\draw (3) to (5.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%=
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=map] (0) at (-3, -1) {$V$};
%		\node [style=none] (1) at (-3, -0.25) {};
%		\node [style=none] (2) at (-3, -1.75) {};
%		\node [style=map] (3) at (-2.25, -1) {$V^\perp$};
%		\node [style=none] (4) at (-2.25, -0.25) {};
%		\node [style=none] (5) at (-2.25, -1.75) {};
%		\node [style=none] (6) at (-2.25, 0.75) {};
%		\node [style=none] (7) at (-3, 0.75) {};
%		\node [style=none] (8) at (-2.25, -2.75) {};
%		\node [style=none] (9) at (-3, -2.75) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (1.center) to (0);
%		\draw (0) to (2.center);
%		\draw (4.center) to (3);
%		\draw (3) to (5.center);
%		\draw [in=270, out=90] (1.center) to (6.center);
%		\draw [in=270, out=90] (4.center) to (7.center);
%		\draw [in=270, out=90] (8.center) to (2.center);
%		\draw [in=270, out=90] (9.center) to (5.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%=
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=map] (0) at (0.5, -1) {$V$};
%		\node [style=none] (1) at (0.5, 0.25) {};
%		\node [style=none] (2) at (0.5, -1.75) {};
%		\node [style=map] (3) at (1.25, -1) {$V^\perp$};
%		\node [style=none] (4) at (1.25, 0.25) {};
%		\node [style=none] (5) at (1.25, -1.75) {};
%		\node [style=none] (6) at (1.25, 1.25) {};
%		\node [style=none] (7) at (0.5, 1.25) {};
%		\node [style=none] (8) at (1.25, -2.75) {};
%		\node [style=none] (9) at (0.5, -2.75) {};
%		\node [style=s] (10) at (1.25, 0.25) {};
%		\node [style=s] (11) at (1.25, -0.25) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (1.center) to (0);
%		\draw (0) to (2.center);
%		\draw (4.center) to (3);
%		\draw (3) to (5.center);
%		\draw [in=270, out=90] (1.center) to (6.center);
%		\draw [in=270, out=90] (4.center) to (7.center);
%		\draw [in=270, out=90] (8.center) to (2.center);
%		\draw [in=270, out=90] (9.center) to (5.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%=
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=map] (0) at (-3, -1) {$V$};
%		\node [style=none] (1) at (-3, -0.25) {};
%		\node [style=none] (2) at (-3, -1.75) {};
%		\node [style=map] (3) at (-2.25, -1) {$V^\perp$};
%		\node [style=none] (4) at (-2.25, -0.25) {};
%		\node [style=none] (5) at (-2.25, -1.75) {};
%		\node [style=none] (6) at (-2.25, 0.75) {};
%		\node [style=none] (7) at (-3, 0.75) {};
%		\node [style=none] (8) at (-2.25, -2.75) {};
%		\node [style=none] (9) at (-3, -2.75) {};
%		\node [style=s] (10) at (-2.25, -0.25) {};
%		\node [style=s] (11) at (-2.25, -1.75) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (1.center) to (0);
%		\draw (0) to (2.center);
%		\draw (4.center) to (3);
%		\draw (3) to (5.center);
%		\draw [in=270, out=90] (1.center) to (6.center);
%		\draw [in=270, out=90] (4.center) to (7.center);
%		\draw [in=270, out=90] (8.center) to (2.center);
%		\draw [in=270, out=90] (9.center) to (5.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%$$
\end{lemma}


To check this is a functor, all we have to show is that it produces Lagrangian relations. This follows immediately from the naturality of $-1$.
This functor is symmetric monoidal and faithful but not full, as for example, the following Lagrangian relation is not in the image of $L$:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (0.5, 0) {};
		\node [style=none] (1) at (0.5, 1) {};
		\node [style=none] (2) at (0.5, -1) {};
		\node [style=X] (3) at (1.5, 0) {};
		\node [style=X] (4) at (1, 0.5) {};
		\node [style=none] (5) at (1.5, 1) {};
		\node [style=none] (6) at (1.5, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (0);
		\draw (0) to (1.center);
		\draw (6.center) to (3);
		\draw (3) to (5.center);
		\draw (3) to (4);
		\draw (4) to (0);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (14) at (4.5, -0.25) {};
		\node [style=none] (15) at (4.5, 0.5) {};
		\node [style=none] (16) at (4.5, -0.75) {};
		\node [style=X] (17) at (3.5, -0.25) {};
		\node [style=none] (18) at (3.5, 0.5) {};
		\node [style=none] (19) at (3.5, -0.75) {};
		\node [style=none] (21) at (3.5, 1.5) {};
		\node [style=none] (22) at (4.5, 1.5) {};
		\node [style=none] (23) at (3.5, -1.75) {};
		\node [style=none] (24) at (4.5, -1.75) {};
		\node [style=X] (25) at (4, 0.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (16.center) to (14);
		\draw (14) to (15.center);
		\draw (19.center) to (17);
		\draw (17) to (18.center);
		\draw [in=270, out=90] (18.center) to (22.center);
		\draw [in=270, out=90] (15.center) to (21.center);
		\draw [in=270, out=90] (23.center) to (16.center);
		\draw [in=270, out=90] (24.center) to (19.center);
		\draw (17) to (25);
		\draw (14) to (25);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (96) at (21.5, -0.25) {};
		\node [style=none] (97) at (21.5, 0.75) {};
		\node [style=none] (98) at (21.5, -0.75) {};
		\node [style=X] (99) at (20.5, -0.25) {};
		\node [style=none] (100) at (20.5, 0.75) {};
		\node [style=none] (101) at (20.5, -0.75) {};
		\node [style=Z] (102) at (21, 0.75) {};
		\node [style=none] (103) at (20.5, 1.75) {};
		\node [style=none] (104) at (21.5, 1.75) {};
		\node [style=none] (105) at (20.5, -1.75) {};
		\node [style=none] (106) at (21.5, -1.75) {};
		\node [style=s] (107) at (21.25, 0.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (98.center) to (96);
		\draw (96) to (97.center);
		\draw (101.center) to (99);
		\draw (99) to (100.center);
		\draw [in=-135, out=60] (99) to (102);
		\draw [in=270, out=90] (100.center) to (104.center);
		\draw [in=270, out=90] (97.center) to (103.center);
		\draw [in=270, out=90] (105.center) to (98.center);
		\draw [in=270, out=90] (106.center) to (101.center);
		\draw [in=-90, out=120] (96) to (107);
		\draw [in=-45, out=90] (107) to (102);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (2.5, 0) {};
		\node [style=none] (1) at (2.5, 0.75) {};
		\node [style=none] (2) at (2.5, -0.75) {};
		\node [style=X] (3) at (1.5, 0) {};
		\node [style=none] (5) at (1.5, 0.75) {};
		\node [style=none] (6) at (1.5, -0.75) {};
		\node [style=Z] (7) at (2, 0.5) {};
		\node [style=none] (8) at (1.5, 1.75) {};
		\node [style=none] (9) at (2.5, 1.75) {};
		\node [style=none] (10) at (1.5, -1.75) {};
		\node [style=none] (11) at (2.5, -1.75) {};
		\node [style=s] (12) at (2.5, -0.75) {};
		\node [style=s] (13) at (2.5, 0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (0);
		\draw (0) to (1.center);
		\draw (6.center) to (3);
		\draw (3) to (5.center);
		\draw (3) to (7);
		\draw (0) to (7);
		\draw [in=270, out=90] (5.center) to (9.center);
		\draw [in=270, out=90] (1.center) to (8.center);
		\draw [in=270, out=90] (10.center) to (2.center);
		\draw [in=270, out=90] (11.center) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
%
%And similarly, we also have:
%
%
%$$
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=Z] (0) at (0.5, 0) {};
%		\node [style=none] (1) at (0.5, 1) {};
%		\node [style=none] (2) at (0.5, -1) {};
%		\node [style=X] (3) at (1.5, 0) {};
%		\node [style=Z] (4) at (1, 0.5) {};
%		\node [style=none] (5) at (1.5, 1) {};
%		\node [style=none] (6) at (1.5, -1) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (2.center) to (0);
%		\draw (0) to (1.center);
%		\draw (6.center) to (3);
%		\draw (3) to (5.center);
%		\draw (3) to (4);
%		\draw (4) to (0);
%	\end{pgfonlayer}
%\end{tikzpicture}
%=
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=Z] (0) at (2.5, 0) {};
%		\node [style=none] (1) at (2.5, 0.75) {};
%		\node [style=none] (2) at (2.5, -0.75) {};
%		\node [style=X] (3) at (1.5, 0) {};
%		\node [style=none] (5) at (1.5, 0.75) {};
%		\node [style=none] (6) at (1.5, -0.75) {};
%		\node [style=X] (7) at (2, 0.5) {};
%		\node [style=none] (8) at (1.5, 1.75) {};
%		\node [style=none] (9) at (2.5, 1.75) {};
%		\node [style=none] (10) at (1.5, -1.75) {};
%		\node [style=none] (11) at (2.5, -1.75) {};
%		\node [style=s] (12) at (2.5, -0.75) {};
%		\node [style=s] (13) at (2.5, 0.75) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (2.center) to (0);
%		\draw (0) to (1.center);
%		\draw (6.center) to (3);
%		\draw (3) to (5.center);
%		\draw (3) to (7);
%		\draw (0) to (7);
%		\draw [in=270, out=90] (5.center) to (9.center);
%		\draw [in=270, out=90] (1.center) to (8.center);
%		\draw [in=270, out=90] (10.center) to (2.center);
%		\draw [in=270, out=90] (11.center) to (6.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%$$
%
%
%\begin{theorem}
%These two extra generators, along with the image of the $L$ generate $\Lag\Rel(\F_p)$, for any prime $p$.
%\end{theorem}
%
%In other words, $\Lag\Rel(\F_p)$ arises as ${\sf CPM}(\Rel(\F_p), \perp,\{\Zdot, \Xdot\})$. The category of completely positive maps with respect to the conjugation functor $\perp$ and the two compact structures of linear relations induced by (co)addition and (co)copying.
%
%It is useful to realise, that by Euler decomposition, the Hadamard gate is derived from these generators:
%
%$$
%\begin{tikzpicture}[xscale=-1]
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=none] (0) at (0, 0) {};
%		\node [style=none] (1) at (0.75, 0) {};
%		\node [style=s] (2) at (0.75, -0.5) {};
%		\node [style=none] (3) at (0.75, -1.5) {};
%		\node [style=none] (4) at (0, -1.5) {};
%		\node [style=none] (5) at (0, -0.5) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw [in=270, out=90] (3.center) to (5.center);
%		\draw (5.center) to (0.center);
%		\draw (1.center) to (2);
%		\draw [in=90, out=-90] (2) to (4.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%$$
%
%And interpreted as a matrix, this is the symplectic form.
%
%
%
%\begin{definition}
%Let $\Aff\Lag\Rel(k)$, denote the affinization of Lagrangian relations.  That is to say, the following pushout of props:
%
%$$
%\Lag\Rel(k) \xleftarrow{S} \Rel(\Mat(k)) \xrightarrow{S} \Lag\Rel(k)  \xrightarrow{G} \Rel(\Mat(k)) \xrightarrow{F} \Rel(\Aff\Mat(k))
%$$
%
%DRAW DISGUSTING PUSHOUT CUBE
%
%
%Where $ G:\Lag\Rel(k)  \rightarrow \Rel(\Mat(k))$ is the forgetful functor and $F: \Rel(\Mat(k))\to  \Rel(\Aff\Mat(k))$ is the free functor.
%\end{definition}
%
%
%This is just a formal way of saying that we are adding an affine shift for each of the gradations of Lagrangian relations.
%
%Notice that this defines another functor $\Aff\Mat(k) \to \Aff\Lag\Rel(k)$ extending the $L$.



%\newpage
%
%
%SYMPLECTOMORPHISMS
%  GENERATED BY FOURIER, PHASE SHIFT, CNOT
%
%
%DEFINE TABLEAU FOR LAGRANGIAN RELATION
%
%
%Just as relations can be represented by matrices over the Boolean semiring, linear relations over $k$ can be represented by matrices over $\F_p$.
%For the sake of simplicity, let us only consider linear relations which are states, as processes can be obtained from currying.
%
%
%Recall that $k$-linear relations $0\to n$ are in one-to-one correspondance with linear subspaces of $k^n$.
%In particular, a linear subspace generated by $m$ column vectors, $v_1,\cdots, v_m$, in $k^n$ is represented by an $n\times m$ matrix.
%
%Recall that a Lagrangian relation $0 \to k^{2n}$ can be characterized as an isotropic subspace of dimension $n$,
%This can be recast in terms of this matrix representation.  In particular $n$-dimensional Lagrangian relations are in one-to-one correspondance with $n\times 2n$ dimensional matrix $M$ with rank $n$  when all rows are orthogonal with respect to the symplectic form.  Take $v_i = z_i x_i$, then for all $1 \leq i,j \leq n$,
%then this symplectic orthogonality is restated as $0=\omega(v_i,v_j) = \langle x_i, z_j \rangle - \langle z_i, x_j \rangle $ which holds if and only if $\langle x_i, z_j \rangle = \langle z_i, x_j \rangle $.
%Similarly, the dimension $n$ condition is equivalent to asking that $\langle v_i,v_j \rangle = 0$ for all $i,j$.


\section{Generators for Lagrangian relations}
\label{sec:univ}

%
%Linear subspaces can be represented in terms of the row space of a matrix.
%In particular, an $n$-dimensional Lagrangian subspace is represented by a block diagonal matrix of the form $[X|Z]$ for $X,Z$ both $n\times n$ matrices.
%This correspondance is made one to one, when the symplectic form is required to vanish, so that $[X|Z] w [X|Z]^n =0$ as well as  $[X|Z]$  having dimension $n$.

In this section, we shall give a universal set of generators for $\Lag\Rel_k$; although, we do not directly give a complete set of identities.  Instead we defer to the completeness of themonoidal presentation of $\LinRel_k$.


Consider the following symplectomorphisms; the discrete Fourier transform $F$,  the $a$-shift gate $S_a$ and the controlled-$a$ gate $C_a$:
$$
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0.5, 1) {};
		\node [style=none] (1) at (0.5, -0.25) {};
		\node [style=none] (2) at (1, -0.25) {};
		\node [style=none] (3) at (1, 1) {};
		\node [style=s] (4) at (1, 0.5) {};
		\node [style=none] (5) at (0.5, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (4) to (3.center);
		\draw [in=90, out=-90] (4) to (1.center);
		\draw [in=-90, out=90] (2.center) to (5.center);
		\draw (5.center) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{bmatrix}
0   & 1 \\
-1  & 0
\end{bmatrix}
\hspace*{.2cm}
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 1.25) {};
		\node [style=Z] (1) at (1.5, -0.25) {};
		\node [style=scalar] (2) at (1, 0.5) {$a$};
		\node [style=none] (3) at (0.5, 1.75) {};
		\node [style=none] (4) at (1.5, 1.75) {};
		\node [style=none] (5) at (1.5, -0.75) {};
		\node [style=none] (6) at (0.5, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (1);
		\draw (1) to (4.center);
		\draw [in=-90, out=135] (1) to (2);
		\draw [in=-45, out=90] (2) to (0);
		\draw (3.center) to (0);
		\draw (0) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{bmatrix}
1 &a\\
0 & 1
\end{bmatrix}
\hspace*{.2cm}
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (430) at (219.75, 0) {};
		\node [style=X] (431) at (220.75, 1.5) {};
		\node [style=none] (432) at (219.75, 0) {};
		\node [style=none] (433) at (221.25, -0.75) {};
		\node [style=none] (434) at (219.25, 2.25) {};
		\node [style=none] (435) at (220.75, 2.25) {};
		\node [style=scalar] (436) at (220.25, 0.75) {$a$};
		\node [style=X] (437) at (217.5, 0) {};
		\node [style=Z] (438) at (218.5, 1.5) {};
		\node [style=none] (439) at (217.5, -0.75) {};
		\node [style=none] (440) at (219, -0.75) {};
		\node [style=none] (441) at (217.25, 2.25) {};
		\node [style=none] (442) at (218.5, 1.5) {};
		\node [style=scalarop] (443) at (218, 0.75) {$a$};
		\node [style=none] (445) at (219.75, -0.75) {};
		\node [style=none] (446) at (218.5, 2.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-105, out=30] (430) to (436);
		\draw [in=-150, out=90] (436) to (431);
		\draw [in=90, out=-60] (431) to (433.center);
		\draw (431) to (435.center);
		\draw [in=135, out=-90, looseness=0.75] (434.center) to (430);
		\draw (439.center) to (437);
		\draw [in=-105, out=30] (437) to (443);
		\draw [in=-150, out=90] (443) to (438);
		\draw [in=90, out=-45, looseness=0.75] (438) to (440.center);
		\draw [in=120, out=-90] (441.center) to (437);
		\draw [in=270, out=90] (442.center) to (446.center);
		\draw [in=270, out=90] (445.center) to (432.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{bmatrix}
1 & -a & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & a & 1
\end{bmatrix}
%\begin{bmatrix}
%1 & -a & 0 & 0 \\
%0 & 1 & 0 & 0 \\
%0 & 0 & 1 & 0 \\
%0 & 0 & a & 0
%\end{bmatrix}
$$


%When composed with identities, these have having the following action on Lagrangian subspaces when applied to certain wires:

Use the notation $G^{(j)}$ to denote a gate $G$ being applied to wire $j$; and the notation $C_a^{(i,j)}$ to denote the controlled-$a$ gate controlling on wire $i$ targetting wire $j$.

Note the right action of these gates in terms of matrix multiplication of Lagrangian subspaces for any nonzero $a \in k$ (as observed in \cite[p. 4]{aaronson}):

\begin{itemize}
\item
$F^{(i)}$ sets columns $x_i$ to $-z_i$ and $z_i$ to $x_i$.

\item
$S_a^{(i)}$ sets $z_i$ to $z_i+a\cdot x_i$.

%\item
%$M_a^{(i)}$ sets $x_i$ to $a\cdot x_i$ and $z_i$ to $a^{-1}\cdot x_i$.

\item
$C_a^{(i,j)}$ sets $x_j$ to $x_j- a \cdot x_i$ and $z_i$ to $z_i+a\cdot z_j$.

\end{itemize}

Using these symplectomorphisms regarded as Lagrangian relations, we have:


%
%
%
%\begin{align*}
%&\left[
%\begin{array}{*{7}c|*{7}c}
%x_{1,1} & \cdots & x_{1,a} & \cdots & x_{1,b} & \cdots & x_{1,n} &  z_{1,1} & \cdots & z_{1,a} & \cdots & z_{1,b} & \cdots & z_{1,n} \\-
%\vdots   & \ddots  & \vdots  & \ddots  & \vdots   &  \ddots & \vdots   & \vdots    & \ddots  & \vdots  & \ddots  & \vdots  & \ddots  & \vdots   \\
%x_{n,1} & \cdots & x_{n,a} & \cdots & x_{n,b} & \cdots & x_{n,n} &  z_{n,1} & \cdots & z_{n,a} & \cdots & z_{n,b} & \cdots & z_{n,n}
%\end{array}
%\right]\\
%&\mapsto\\
%&\left[
%\begin{array}{*{7}c|*{7}c}
%x_{1,1} & \cdots & x_{1,a} & \cdots & x_{1,b} - kx_{1,a} & \cdots & x_{1,n} &  z_{1,1} & \cdots & z_{1,a} +k z_{1,b} & \cdots & z_{1,b} & \cdots & z_{1,n} \\
%\vdots   & \ddots  & \vdots  & \ddots  & \vdots                    &  \ddots & \vdots   & \vdots    & \ddots  & \vdots                  & \ddots  & \vdots  & \ddots  & \vdots   \\
%x_{n,1} & \cdots & x_{n,a} & \cdots & x_{n,b} -kx_{n,a} & \cdots & x_{n,n} &  z_{n,1} & \cdots & z_{n,a} +k  z_{n,b}& \cdots & z_{n,b} & \cdots & z_{n,n}
%\end{array}
%\right]
%\end{align*}
%
%
%
%\begin{align*}
%&\left[
%\begin{array}{*{5}c|*{5}c}
%x_{1,1} & \cdots & x_{1,a}  & \cdots & x_{1,n} &  z_{1,1} & \cdots & z_{1,a} & \cdots  & z_{1,n} \\
%\vdots   & \ddots  & \vdots   &  \ddots & \vdots   & \vdots    & \ddots  & \vdots  & \ddots   & \vdots   \\  
%x_{n,1} & \cdots & x_{n,a} & \cdots & x_{n,n} &  z_{n,1} & \cdots & z_{n,a} & \cdots   & z_{n,n}
%\end{array}
%\right]\\
%&\mapsto\\
%&\left[
%\begin{array}{*{7}c|*{7}c}
%x_{1,1} & \cdots & x_{1,a-1} & -z_{1,a} &  x_{1,a+1}   & \cdots & x_{1,n} &  z_{1,1} & \cdots & z_{1,a-1} & x_{1,a} &  z_{1,a+1} & \cdots  & z_{1,n} \\
%\vdots   & \ddots  & \vdots      & \vdots   & \vdots           &  \ddots & \vdots   & \vdots    & \ddots  & \vdots      & \vdots    & \vdots        & \ddots   & \vdots   \\  
%x_{n,1} & \cdots & x_{n,a-1} & -z_{n,a} &  x_{n,a+1} & \cdots & x_{n,n} &  z_{n,1} & \cdots &  z_{n,a-1} & x_{n,a} &  z_{n,a+1} & \cdots   & z_{n,n}
%\end{array}
%\right]\\
%\end{align*}
%
%
%



\begin{theorem}
\label{theorem:generators}
For any field $k$ the maps in $L(\LinRel_k)$ as well as $F$ and $S_a$ for all $a \in k$ generate $\Lag\Rel_k$.
\end{theorem}

\begin{proof}
Consider the matrix $[Z|X]$ of an arbitrary Lagrangian relation over field $k$ seen as a state.
%
%$$
%[X | Z]
%=
%\left[
%\begin{array}{ccc|ccc}
%x_{1,1} & \cdots & x_{n,n} & z_{1,1} & \cdots & z_{1,n}\\
%\vdots    & \ddots & \vdots    & \vdots   & \ddots & \vdots \\
%x_{n,1} & \cdots & x_{n,n} & z_{n,1} & \cdots & z_{n,n}\\
%\end{array}
%\right]
%$$
We show how one can reduce $[Z|X]$ to the block matrix $[I|0]$ by right multiplication with the aforementioned symplectomorphisms.
To do so, we first reduce it to a matrix $[I|X']$
by only applying row operations (keeping the subspace the same) as well as the Fourier transform.
This involve repeatedly do Gaussian elimination and then applying the Fourier transform to wires when the pivot is in the $X$ block.
We are guaranteed to obtain a matrix $[I|X']$ because the dimension of Lagrangian subspace is $n$.
A very similar observation was made in \cite[Lem. 6]{aaronson}.

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (309) at (26.5, 8.75) {};
		\node [style=none] (310) at (26.5, 8) {};
		\node [style=none] (311) at (25.75, 10.25) {};
		\node [style=none] (312) at (27, 9.5) {};
		\node [style=none] (313) at (30.75, 8.25) {};
		\node [style=Z] (314) at (30.75, 9) {};
		\node [style=none] (315) at (30.5, 10) {};
		\node [style=none] (316) at (31.5, 9.5) {};
		\node [style=none] (317) at (32, 8.25) {};
		\node [style=Z] (318) at (28.5, 8.75) {};
		\node [style=none] (319) at (28.5, 8) {};
		\node [style=none] (320) at (28, 9.5) {};
		\node [style=none] (321) at (29.25, 10.25) {};
		\node [style=none] (322) at (27.5, 10) {};
		\node [style=none] (323) at (33.25, 8.25) {};
		\node [style=Z] (324) at (33.25, 9) {};
		\node [style=none] (325) at (32.75, 10) {};
		\node [style=none] (326) at (33.75, 10) {};
		\node [style=none] (327) at (32.5, 9) {,};
		\node [style=none] (328) at (29.75, 9) {,};
		\node [style=none] (329) at (27.5, 11) {(1)};
		\node [style=none] (330) at (31.25, 11) {(2)};
		\node [style=none] (331) at (33.25, 11) {(3)};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (310.center) to (309);
		\draw [in=-90, out=150, looseness=0.75] (309) to (311.center);
		\draw [in=30, out=-90] (312.center) to (309);
		\draw [in=135, out=-90] (315.center) to (314);
		\draw (313.center) to (314);
		\draw [in=45, out=180, looseness=0.75] (316.center) to (314);
		\draw [in=0, out=90, looseness=0.75] (317.center) to (316.center);
		\draw (319.center) to (318);
		\draw [in=-90, out=150] (318) to (320.center);
		\draw [in=30, out=-90] (321.center) to (318);
		\draw [in=0, out=90, looseness=0.75] (320.center) to (322.center);
		\draw [in=90, out=180, looseness=0.75] (322.center) to (312.center);
		\draw [in=150, out=-90] (325.center) to (324);
		\draw (323.center) to (324);
		\draw [in=30, out=-90] (326.center) to (324);
	\end{pgfonlayer}
\end{tikzpicture}
$$

As the Fourier transform is a symplectomorphism $[I|X']$ is isotropic, so that:

$$
0
=
\begin{bmatrix}
I | X'
\end{bmatrix}
\omega
\begin{bmatrix}
I | X'
\end{bmatrix}^T
$$
which holds if and only if 
$$
0=
\begin{bmatrix}
I | X'
\end{bmatrix}
\begin{bmatrix}
X' | -I 
\end{bmatrix}^T
=
{X'}^T-X'
$$

That is to say $X'$ is symmetric, meaning that $X'$ describes the adjacency matrix of a graph coloured by the elements of $k$.
In the language of stabilizer circuits, this is called a {\em graph state}.  In the case of prime fields, this observation was made in \cite[Eq. 18]{gross}.  Graph states were originally discussed in \cite{hein2006entanglement}.


%
%The next part of the algorithm is reducing the second block of the matrix to 0. In the case of $\F_2$, this is reduced to applying controlled-Z gates to the wires which contain an edge in the adjacency matrix of the graph of $Z'$.
%In the case of a general field, we must take a slightly more nuanced approach.
%
%
%
%
%% Input: Matrix representation (X|Z) of Lagrangian subspace
%% Row reduce (X|Z)
%% For all rows i, if the pivot is in the Z block, apply the Fourier transform to row i
%% Because Lagrangian subspaces of k^{2n} have dimension n, this matrix has full rank, 
%%   Therefore, row reduce further until  the X block is the identity
%%Now the Z block is a symmetric matrix
%% For all i from 1 to n
%%   For all j from 1 to i
%%     Apply Fourier transform to row j
%%     Apply C_{z_{i,j}} gate from row i to j
%%    Apply inverse fourier transform to row j


We prove that graph states can be reduced to the subspace $[I|0]$ by induction on the dimension of the subspace.
This base case is trivial.

Suppose we have a $(n+1)$-dimensional Lagrangian subspaces described by a graph state, then:
\newpage

\resizebox{\linewidth}{!}{
  \begin{minipage}{\linewidth}
\begin{align*}
&\left[
\begin{array}{*{5}c|*{6}c}
1         & 0        & 0         & \cdots & 0         & x_{1,1} & x_{1,2} & x_{1,3} & \cdots & x_{1,n}\\
0         & 1        & 0         & \cdots & 0         & x_{1,2} & x_{2,2} & x_{2,3} & \cdots & x_{2,n}\\
0         & 0        & 1         & \ddots & \vdots & x_{1,3} & x_{2,3} & x_{3,3} & \cdots & x_{3,n}\\
\vdots & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots    & \vdots    & \ddots &  \vdots \\
0         & 0         & \cdots & 0        & 1          & x_{1,n} & x_{2,n} & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]
\xmapsto{(F^{(1)})^{-1}}
\left[
\begin{array}{*{5}c|*{6}c}
x_{1,1}         & 0        & 0         & \cdots & 0         & -1 & x_{1,2} & x_{1,3} & \cdots & x_{1,n}\\
x_{1,2}         & 1        & 0         & \cdots & 0         & 0 & x_{2,2} & x_{2,3} & \cdots & x_{2,n}\\
x_{1,3}         & 0        & 1         & \ddots & \vdots & 0 & x_{2,3} & x_{3,3} & \cdots & x_{3,n}\\
\vdots & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots    & \vdots    & \ddots &  \vdots \\
x_{1,n}         & 0         & \cdots & 0        & 1          & 0 & x_{2,n} & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]\\
&\xmapsto{C_{x_{1,2}}^{(2,1)}}\\
&\left[
\begin{array}{*{5}c|*{6}c}
x_{1,1}-0           & 0         & 0         & \cdots & 0         & -1 & x_{1,2}-x_{1,2} & x_{1,3} & \cdots & x_{1,n}\\
x_{1,2}-x_{1,2} & 1         & 0         & \cdots & 0         & 0 & x_{2,2}-0            & x_{2,3} & \cdots & x_{2,n}\\
x_{1,3}-0           & 0         & 1         & \ddots & \vdots & 0 & x_{2,3}-0            & x_{3,3} & \cdots & x_{3,n}\\
\vdots                 & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots        & \vdots    & \ddots &  \vdots \\
x_{1,n}-0           & 0         & \cdots & 0        & 1          & 0 & x_{2,n}-0            & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]
=
\left[
\begin{array}{*{5}c|*{6}c}
x_{1,1}             & 0         & 0         & \cdots & 0         & -1 & 0                         & x_{1,3} & \cdots & x_{1,n}\\
0                       & 1         & 0         & \cdots & 0         & 0 & x_{2,2}                & x_{2,3} & \cdots & x_{2,n}\\
x_{1,3}             & 0         & 1         & \ddots & \vdots & 0 & x_{2,3}                & x_{3,3} & \cdots & x_{3,n}\\
\vdots                & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots        & \vdots    & \ddots &  \vdots \\
x_{1,n}             & 0         & \cdots & 0        & 1          & 0 & x_{2,n}                & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]\\
&\xmapsto{\prod_{i>1}^n C_{x_{1,i}}^{(i,1)}}\\
&\left[
\begin{array}{*{5}c|*{6}c}
x_{1,1}             & 0         & 0         & \cdots & 0         & -1 & 0                         & 0           & \cdots & 0\\
0                       & 1         & 0         & \cdots & 0         & 0 & x_{2,2}                & x_{2,3} & \cdots & x_{2,n}\\
0                       & 0         & 1         & \ddots & \vdots & 0 & x_{2,3}                & x_{3,3} & \cdots & x_{3,n}\\
\vdots               & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots        & \vdots    & \ddots &  \vdots \\
0                       & 0         & \cdots & 0        & 1          & 0 & x_{2,n}                & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]
\xmapsto{F^{(1)}}
\left[
\begin{array}{*{5}c|*{6}c}
1                       & 0         & 0         & \cdots & 0         & x_{1,1} & 0                          & 0           & \cdots & 0\\
0                       & 1         & 0         & \cdots & 0         & 0           & x_{2,2}                & x_{2,3} & \cdots & x_{2,n}\\
0                       & 0         & 1         & \ddots & \vdots & 0           & x_{2,3}                & x_{3,3} & \cdots & x_{3,n}\\
\vdots               & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots                   & \vdots    & \ddots &  \vdots \\
0                       & 0         & \cdots & 0        & 1          & 0           & x_{2,n}                & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]\\
&\xmapsto{S_{-x_{1,1}}^{(1)}  }\\
&\left[
\begin{array}{*{5}c|*{6}c}
1                       & 0         & 0         & \cdots & 0         & 0 & 0                          & 0           & \cdots & 0\\
0                       & 1         & 0         & \cdots & 0         & 0           & x_{2,2}                & x_{2,3} & \cdots & x_{2,n}\\
0                       & 0         & 1         & \ddots & \vdots & 0           & x_{2,3}                & x_{3,3} & \cdots & x_{3,n}\\
\vdots               & \vdots & \ddots & \ddots & 0         & \vdots   & \vdots                   & \vdots    & \ddots &  \vdots \\
0                       & 0         & \cdots & 0        & 1          & 0           & x_{2,n}                & x_{3,n} & \cdots & x_{n,n}\\
\end{array}
\right]\\
\end{align*}
  \end{minipage}
}


Therefore all Lagrangian relations can be reduced to the subspace $[I|0]$ by right multiplication by symplectomorphisms.
In the $n$-dimensional case, this subspace is given by the circuit
$L(
\begin{tikzpicture}[scale=.5]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (6, 3) {};
		\node [style=none] (1) at (6, 3.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
^{\otimes n}$).



Thus, we have already described all the generators of Lagrangian relations. The gates $F$, $C_a$ for all $a \in k$, along with the cup and cap and the zero state generate all Lagrangian relations.  Note that $C_a$ and the zero state are both in the image of the $L$.

\end{proof} 


%
%This is proved by using these symplectomorphisms to reduce a Lagrangian relation by Guassian elimination to the state
%$L(
%\begin{tikzpicture}[scale=.5]
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=X] (0) at (6, 3) {};
%		\node [style=none] (1) at (6, 3.5) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw (0) to (1.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%^{\otimes n}$).
%

We can also give a presentation of this category which is very close to Selinger's CPM construction~\cite{cpm}. There are several equivalent ways to define the CPM construction. For our purposes, the most convenient one is the presentation used in both in~\cite{pqp,cqm1}, which defines $\CPM[\X]$ as the subcategory of a dagger compact closed category $\X$ whose objects are of the form $A^* \otimes A$ for $A \in \X$ and whose morphisms are generated by (i) `pure' morphisms, i.e. morphisms of the form $f_* \otimes f$ for $f \in \X$ and a covariant functor $(\_)_*$, and (ii) a `discard' morphism $d_A$ for every $A \in \X$ given by the counit $d_A := \epsilon_A : A^* \otimes A \to I$ of the compact closed structure on $A$.

We nearly obtain such a presentation for $\Lag\Rel_k$ using the covariant functor $(-)^\perp$ to define pure morphisms, with the only caveat being we need to consider a family of discard morphisms: each discard morphism being parametrised by a field element.

\begin{theorem}
\label{theorem:unbiased}
$\Lag\Rel_k$ is the monoidal subcategory of $\LinRel_k$ whose objects are of the form $k^n \oplus k^n$, for all natural numbers $n$, and whose morphisms are generated by \textit{pure} morphisms of the form $V^\perp \oplus V$ for $V \in \LinRel_k$ and for each $a \in k$, a `discard' morphism:
$$
d_a :=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0, 0.75) {};
		\node [style=scalar] (1) at (0.5, 0) {$a$};
		\node [style=none] (2) at (0.5, -0.75) {};
		\node [style=none] (3) at (-0.5, 0) {};
		\node [style=none] (4) at (-0.5, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-30, out=90] (1) to (0);
		\draw [in=90, out=-150] (0) to (3.center);
		\draw (4.center) to (3.center);
		\draw (2.center) to (1);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{theorem}


\begin{proof}
  We just have to show that $F$ and $S_a$ can be constructed using these generators. The $S_a$ gate and it's colour-reversed version $V_a$ can be obtained by composing a pure morphism with $d_a$ and $d_{-a}$, respectively:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1, -1.25) {};
		\node [style=Z] (1) at (1, -0.75) {};
		\node [style=X] (2) at (-0.75, -0.75) {};
		\node [style=X] (3) at (-0.375, 0.75) {};
		\node [style=none] (4) at (-0.75, -1.25) {};
		\node [style=none] (5) at (-0.75, 1.25) {};
		\node [style=none] (6) at (1, 1.25) {};
		\node [style=scalar] (7) at (0.5, 0) {$a$};
		\node [style=none] (8) at (-1.25, 0) {};
		\node [style=none] (9) at (1.75, 0) {$=$};
		\node [style=none] (10) at (3.5, -1) {};
		\node [style=Z] (11) at (3.5, -0.5) {};
		\node [style=X] (12) at (2.5, 0.5) {};
		\node [style=none] (13) at (2.5, -1) {};
		\node [style=scalar] (14) at (3, 0) {$a$};
		\node [style=none] (15) at (2.5, 1) {};
		\node [style=none] (16) at (3.5, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (0.center);
		\draw (1) to (6.center);
		\draw (2) to (5.center);
		\draw (2) to (4.center);
		\draw [in=-90, out=165] (1) to (7);
		\draw [in=0, out=90] (7) to (3);
		\draw [in=-90, out=150] (2) to (8.center);
		\draw [in=-180, out=90] (8.center) to (3);
		\draw (11) to (10.center);
		\draw [in=-90, out=165] (11) to (14);
		\draw [in=-15, out=90] (14) to (12);
		\draw (13.center) to (12);
		\draw (11) to (16.center);
		\draw (12) to (15.center);
	\end{pgfonlayer}
\end{tikzpicture}
\ = S_a
\qquad\qquad
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1, -1.25) {};
		\node [style=X] (1) at (1, -0.75) {};
		\node [style=Z] (2) at (-0.75, -0.75) {};
		\node [style=Z] (3) at (-0.375, 0.75) {};
		\node [style=none] (4) at (-0.75, -1.25) {};
		\node [style=none] (5) at (-0.75, 1.25) {};
		\node [style=none] (6) at (1, 1.25) {};
		\node [style=scalar] (7) at (0.5, 0) {$a$};
		\node [style=none] (8) at (-1.25, 0) {};
		\node [style=none] (9) at (1.75, 0) {$=$};
		\node [style=none] (10) at (3.5, -1) {};
		\node [style=X] (11) at (3.5, -0.5) {};
		\node [style=Z] (12) at (2.5, 0.5) {};
		\node [style=none] (13) at (2.5, -1) {};
		\node [style=scalar] (14) at (3, 0) {$a$};
		\node [style=none] (15) at (2.5, 1) {};
		\node [style=none] (16) at (3.5, 1) {};
		\node [style=none] (17) at (-2.75, -1.25) {};
		\node [style=X] (18) at (-2.75, -0.75) {};
		\node [style=Z] (19) at (-4.5, -0.75) {};
		\node [style=X] (20) at (-4.125, 0.75) {};
		\node [style=none] (21) at (-4.5, -1.25) {};
		\node [style=none] (22) at (-4.5, 1.25) {};
		\node [style=none] (23) at (-2.75, 1.25) {};
		\node [style=scalar] (24) at (-3.25, 0) {-$a$};
		\node [style=none] (25) at (-5, 0) {};
		\node [style=none] (26) at (-2, 0) {$=$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (0.center);
		\draw (1) to (6.center);
		\draw (2) to (5.center);
		\draw (2) to (4.center);
		\draw [in=-90, out=165] (1) to (7);
		\draw [in=0, out=90] (7) to (3);
		\draw [in=-90, out=150] (2) to (8.center);
		\draw [in=-180, out=90] (8.center) to (3);
		\draw (11) to (10.center);
		\draw [in=-90, out=165] (11) to (14);
		\draw [in=-15, out=90] (14) to (12);
		\draw (13.center) to (12);
		\draw (11) to (16.center);
		\draw (12) to (15.center);
		\draw (18) to (17.center);
		\draw (18) to (23.center);
		\draw (19) to (22.center);
		\draw (19) to (21.center);
		\draw [in=-90, out=165] (18) to (24);
		\draw [in=0, out=90] (24) to (20);
		\draw [in=-90, out=150] (19) to (25.center);
		\draw [in=-180, out=90] (25.center) to (20);
	\end{pgfonlayer}
\end{tikzpicture}
\  =: V_a
$$

We can then obtain $F$ as $S_1 \circ V_1 \circ S_1$, which can be proven as a variation of the familiar `3 CNOT' rule for quantum circuits (see e.g.~\cite[\S 3.2.1]{coecke2008interacting}):
$$
S_1 \circ V_1 \circ S_1
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (3, 1.25) {};
		\node [style=X] (1) at (4, 1.75) {};
		\node [style=Z] (2) at (4, 2.5) {};
		\node [style=X] (3) at (3, 2) {};
		\node [style=Z] (4) at (3, 2.75) {};
		\node [style=X] (5) at (4, 3.25) {};
		\node [style=none] (6) at (3, 4.5) {};
		\node [style=none] (7) at (4, 4.5) {};
		\node [style=none] (8) at (3, 0) {};
		\node [style=none] (9) at (4, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (6.center) to (4);
		\draw (4) to (3);
		\draw (0) to (3);
		\draw (8.center) to (0);
		\draw (9.center) to (1);
		\draw (1) to (2);
		\draw (2) to (5);
		\draw (5) to (7.center);
		\draw (3) to (2);
		\draw (4) to (5);
		\draw (0) to (1);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (3, 1.25) {};
		\node [style=X] (1) at (4, 0.75) {};
		\node [style=Z] (2) at (4, 2.5) {};
		\node [style=X] (3) at (3, 2) {};
		\node [style=Z] (4) at (3, 3.75) {};
		\node [style=X] (5) at (4, 3.25) {};
		\node [style=none] (6) at (3, 4.5) {};
		\node [style=none] (7) at (4, 4.5) {};
		\node [style=none] (8) at (3, 0) {};
		\node [style=none] (9) at (4, 0) {};
		\node [style=s] (10) at (3.5, 3.5) {};
		\node [style=s] (11) at (3.5, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (6.center) to (4);
		\draw (4) to (3);
		\draw (0) to (3);
		\draw (8.center) to (0);
		\draw (9.center) to (1);
		\draw (1) to (2);
		\draw (2) to (5);
		\draw (5) to (7.center);
		\draw (3) to (2);
		\draw (1) to (11);
		\draw (11) to (0);
		\draw (5) to (10);
		\draw (10) to (4);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (28) at (6.5, 0) {};
		\node [style=Z] (31) at (5, 4) {};
		\node [style=none] (33) at (5, 4.5) {};
		\node [style=none] (34) at (6.5, 4.5) {};
		\node [style=none] (35) at (5, -0.5) {};
		\node [style=none] (36) at (6.5, -0.5) {};
		\node [style=s] (37) at (6, 0.5) {};
		\node [style=s] (38) at (5.5, 3.5) {};
		\node [style=X] (39) at (6, 2.25) {};
		\node [style=Z] (40) at (6, 3) {};
		\node [style=X] (41) at (6.5, 2.25) {};
		\node [style=Z] (42) at (6.5, 3) {};
		\node [style=X] (43) at (5, 1) {};
		\node [style=Z] (44) at (5, 1.75) {};
		\node [style=X] (45) at (5.5, 1) {};
		\node [style=Z] (46) at (5.5, 1.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (33.center) to (31);
		\draw (36.center) to (28);
		\draw (28) to (37);
		\draw (31) to (38);
		\draw (40) to (41);
		\draw (41) to (42);
		\draw (40) to (39);
		\draw (39) to (42);
		\draw (44) to (45);
		\draw (45) to (46);
		\draw (44) to (43);
		\draw (43) to (46);
		\draw (34.center) to (42);
		\draw (40) to (38);
		\draw (46) to (39);
		\draw (41) to (28);
		\draw (37) to (45);
		\draw (35.center) to (43);
		\draw (31) to (44);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (67) at (11.5, 0) {};
		\node [style=Z] (68) at (10, 4.25) {};
		\node [style=none] (69) at (10, 4.75) {};
		\node [style=none] (70) at (11.5, 4.75) {};
		\node [style=none] (71) at (10, -0.5) {};
		\node [style=none] (72) at (11.5, -0.5) {};
		\node [style=s] (73) at (11, 0.5) {};
		\node [style=s] (74) at (10.5, 3.75) {};
		\node [style=Z] (75) at (11, 3.25) {};
		\node [style=X] (76) at (11.5, 2.5) {};
		\node [style=Z] (77) at (11.5, 3.25) {};
		\node [style=X] (78) at (10, 1) {};
		\node [style=Z] (79) at (10, 1.75) {};
		\node [style=X] (80) at (10.5, 1) {};
		\node [style=X] (81) at (10.5, 1.75) {};
		\node [style=Z] (82) at (10.5, 2.5) {};
		\node [style=X] (83) at (11, 1.75) {};
		\node [style=Z] (84) at (11, 2.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (69.center) to (68);
		\draw (72.center) to (67);
		\draw (67) to (73);
		\draw (68) to (74);
		\draw (75) to (76);
		\draw (76) to (77);
		\draw (79) to (80);
		\draw (79) to (78);
		\draw (70.center) to (77);
		\draw (75) to (74);
		\draw (76) to (67);
		\draw (73) to (80);
		\draw (71.center) to (78);
		\draw (68) to (79);
		\draw (82) to (83);
		\draw (83) to (84);
		\draw (82) to (81);
		\draw (81) to (84);
		\draw (78) to (81);
		\draw (80) to (83);
		\draw (84) to (77);
		\draw (75) to (82);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (11, 0.75) {};
		\node [style=Z] (1) at (10.25, 4.75) {};
		\node [style=none] (2) at (10.25, 5.25) {};
		\node [style=none] (3) at (11, 5.25) {};
		\node [style=none] (4) at (10.25, 0.25) {};
		\node [style=none] (5) at (11, 0.25) {};
		\node [style=s] (6) at (11, 1.5) {};
		\node [style=s] (7) at (10.25, 4) {};
		\node [style=Z] (8) at (10.25, 3.25) {};
		\node [style=X] (9) at (11, 0.75) {};
		\node [style=Z] (10) at (11, 3.25) {};
		\node [style=X] (11) at (10.25, 2.25) {};
		\node [style=Z] (12) at (10.25, 4.75) {};
		\node [style=X] (13) at (11, 2.25) {};
		\node [style=X] (14) at (10.25, 2.25) {};
		\node [style=Z] (15) at (10.25, 3.25) {};
		\node [style=X] (16) at (11, 2.25) {};
		\node [style=Z] (17) at (11, 3.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (5.center) to (0);
		\draw (0) to (6);
		\draw (1) to (7);
		\draw [in=135, out=-60] (8) to (9);
		\draw [bend right, looseness=1.25] (9) to (10);
		\draw [in=120, out=-45] (12) to (13);
		\draw [bend right, looseness=1.25] (12) to (11);
		\draw (3.center) to (10);
		\draw (8) to (7);
		\draw (6) to (13);
		\draw (4.center) to (11);
		\draw [in=150, out=-30, looseness=0.75] (15) to (16);
		\draw (16) to (17);
		\draw (15) to (14);
		\draw (14) to (17);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (19.5, 1.25) {};
		\node [style=Z] (1) at (18, 4.25) {};
		\node [style=none] (2) at (18, 4.75) {};
		\node [style=none] (3) at (19.5, 4.75) {};
		\node [style=none] (4) at (18, 0.75) {};
		\node [style=none] (5) at (19.5, 0.75) {};
		\node [style=X] (6) at (19.5, 1.25) {};
		\node [style=Z] (7) at (19.5, 4.25) {};
		\node [style=X] (8) at (18, 1.25) {};
		\node [style=Z] (9) at (18, 4.25) {};
		\node [style=X] (10) at (19.5, 1.25) {};
		\node [style=X] (11) at (18, 1.25) {};
		\node [style=X] (12) at (19.5, 1.25) {};
		\node [style=Z] (13) at (19.5, 4.25) {};
		\node [style=s] (14) at (17.75, 3) {};
		\node [style=s] (15) at (18.75, 3) {};
		\node [style=s] (16) at (19.75, 3) {};
		\node [style=s] (17) at (18.25, 3) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (5.center) to (0);
		\draw [bend right=45] (6) to (7);
		\draw [in=120, out=-135, looseness=1.25] (9) to (8);
		\draw (3.center) to (7);
		\draw (4.center) to (8);
		\draw [in=-120, out=15, looseness=0.75] (11) to (13);
		\draw [in=90, out=-105] (9) to (14);
		\draw [in=90, out=-45, looseness=0.75] (9) to (15);
		\draw [in=90, out=-90] (14) to (11);
		\draw [in=-90, out=120, looseness=0.75] (6) to (15);
		\draw [in=-15, out=90] (12) to (9);
		\draw [in=-90, out=150, looseness=0.75] (12) to (17);
		\draw [in=285, out=90] (17) to (9);
		\draw [in=-90, out=75, looseness=0.75] (12) to (16);
		\draw [in=-75, out=90] (16) to (13);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (24, 4.5) {};
		\node [style=none] (1) at (23.5, 4) {};
		\node [style=none] (2) at (24, 2.75) {};
		\node [style=none] (3) at (23.5, 2.75) {};
		\node [style=s] (4) at (24, 4) {};
		\node [style=none] (5) at (23.5, 4.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=90, looseness=1.25] (2.center) to (1.center);
		\draw (1.center) to (5.center);
		\draw (0.center) to (4);
		\draw [in=90, out=-90, looseness=1.25] (4) to (3.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
F
$$
\end{proof}

In the ZX-calculus literature, this decomposition of the Fourier transform is known as {\it Euler decomposition} \cite{duncan2009graph}.
A variant of this decomposition is given in \cite[p.6]{control}; although in the context of plain old linear relations instead of Lagrangian relations, so an antipode is missing in their case.  A similar observation was made in \cite[(34)]{ranchin2014depicting} in terms of qudit controlled boost gates; however, the connection to phase-shift gates and Euler decomposition was not made.

From Theorem~\ref{theorem:generators}, we know that we can build any Lagrangian relation using pure Lagrangian relations and discard maps. Since the former is closed under composition and monoidal product, the following can be shown immediately from string diagram deformation.

\begin{corollary}[Phase purification]\label{cor:pure}
  Any linear Lagrangian relation can be written in the following form, for $V$ a linear relation:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (-0.25, 1.75) {};
		\node [style=scalar] (1) at (1, 0.75) {$a_1$};
		\node [style=none] (2) at (1, 0) {};
		\node [style=none] (3) at (-2.25, 0.5) {};
		\node [style=none] (4) at (-2.25, 0) {};
		\node [style=map, minimum width=2cm, minimum height=1cm] (5) at (-1.5, -0.5) {$V^\perp$};
		\node [style=map, minimum width=2cm, minimum height=1cm] (6) at (1.75, -0.5) {$V$};
		\node [style=X] (7) at (1, 1.75) {};
		\node [style=scalar] (8) at (2, 0.75) {$a_k$};
		\node [style=none] (9) at (2, 0) {};
		\node [style=none] (10) at (-1.25, 0.5) {};
		\node [style=none] (11) at (-1.25, 0) {};
		\node [style=none] (12) at (1.5, 0.25) {...};
		\node [style=none] (13) at (-0.75, 0) {};
		\node [style=none] (14) at (-0.75, 2.25) {};
		\node [style=none] (17) at (2.5, 0) {};
		\node [style=none] (18) at (2.5, 2.25) {};
		\node [style=none] (19) at (-1.75, 0.25) {...};
		\node [style=none] (20) at (-1.5, -1.5) {};
		\node [style=none] (21) at (-1.5, -0.75) {};
		\node [style=none] (22) at (1.75, -1.5) {};
		\node [style=none] (23) at (1.75, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-30, out=90, looseness=0.75] (1) to (0);
		\draw [in=90, out=-165, looseness=0.50] (0) to (3.center);
		\draw (4.center) to (3.center);
		\draw (2.center) to (1);
		\draw [in=-30, out=90, looseness=0.75] (8) to (7);
		\draw [in=90, out=-165, looseness=0.50] (7) to (10.center);
		\draw (11.center) to (10.center);
		\draw (9.center) to (8);
		\draw [in=270, out=90] (13.center) to (14.center);
		\draw [in=270, out=90] (17.center) to (18.center);
		\draw [in=270, out=90] (20.center) to (21.center);
		\draw [in=270, out=90] (22.center) to (23.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{corollary}

In the case when we are working with prime fields, then Lagrangian relations are exactly an instance of the CPM construction. Namely, in the category of linear relations, $(-)^*$ is given by relational converse, so we can define a dagger functor $(-)^\dagger := ((-)^\perp)^*$ such that $(-)_* = (-)^\perp$. It only remains to show that all of the discarding maps arise from a single fixed cap. This can be done as follows, for $k = \F_p$:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (3) at (3, 2) {};
		\node [style=scalar] (7) at (3.5, 1.5) {$n$};
		\node [style=none] (8) at (2.5, 1.5) {};
		\node [style=none] (9) at (2.5, 1) {};
		\node [style=none] (10) at (3.5, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-15, out=90] (7) to (3);
		\draw [in=-165, out=90] (8.center) to (3);
		\draw (9.center) to (8.center);
		\draw (10.center) to (7);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (5.25, 1.75) {};
		\node [style=Z] (1) at (6.25, 0.5) {};
		\node [style=none] (2) at (4.25, 0) {};
		\node [style=none] (3) at (6.25, 0) {};
		\node [style=none] (4) at (5.75, 1.25) {$\iddots$};
		\node [style=none] (5) at (5.9, 1) {$n$};
		\node [style=X] (6) at (4.75, 2.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=0, out=90, looseness=1.25] (1) to (0);
		\draw [in=-90, out=165, looseness=1.25] (1) to (0);
		\draw [in=-120, out=90] (2.center) to (6);
		\draw [in=105, out=-15] (6) to (0);
		\draw (3.center) to (1);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (21) at (6.25, 2) {};
		\node [style=none] (22) at (5.25, 2.25) {};
		\node [style=X] (23) at (5.25, 2.25) {};
		\node [style=Z] (24) at (6.25, 2) {};
		\node [style=none] (25) at (5, 3) {};
		\node [style=none] (26) at (6.5, 2.75) {};
		\node [style=Z] (28) at (6.5, 2.75) {};
		\node [style=none] (30) at (6.25, 0.75) {};
		\node [style=none] (31) at (5.25, 1) {};
		\node [style=X] (32) at (5.25, 1) {};
		\node [style=Z] (33) at (6.25, 0.75) {};
		\node [style=none] (34) at (5.25, 0.25) {};
		\node [style=none] (35) at (6.25, 0.25) {};
		\node [style=none] (36) at (5.7, 1.6) {$\vdots$};
		\node [style=none] (37) at (5.95, 1.55) {$n$};
		\node [style=X] (38) at (5, 3) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=135, looseness=0.75] (23) to (25.center);
		\draw [in=-90, out=60] (24) to (26.center);
		\draw (34.center) to (32);
		\draw (32) to (23);
		\draw (35.center) to (33);
		\draw (33) to (24);
		\draw (24) to (23);
		\draw (33) to (32);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (622) at (274.75, 2.25) {};
		\node [style=none] (623) at (275.5, 1.25) {};
		\node [style=none] (624) at (274.25, 1.25) {};
		\node [style=X] (625) at (274.25, 1.25) {};
		\node [style=Z] (626) at (275.5, 1.25) {};
		\node [style=none] (627) at (274.25, 2.5) {};
		\node [style=none] (628) at (275.5, 2.5) {};
		\node [style=X] (629) at (274.25, 2.5) {};
		\node [style=Z] (630) at (275.5, 2.5) {};
		\node [style=X] (631) at (274.75, 0.75) {};
		\node [style=none] (632) at (275.5, -0.25) {};
		\node [style=none] (633) at (274.25, -0.25) {};
		\node [style=X] (634) at (274.25, -0.25) {};
		\node [style=Z] (635) at (275.5, -0.25) {};
		\node [style=none] (636) at (274.25, -1) {};
		\node [style=none] (637) at (275.5, -1) {};
		\node [style=none] (638) at (274.8, 1.59) {$\vdots$};
		\node [style=none] (639) at (275.05, 1.5) {$n$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-15, out=120] (623.center) to (622);
		\draw [in=-165, out=165, looseness=1.50] (624.center) to (622);
		\draw (625) to (627.center);
		\draw (626) to (628.center);
		\draw [in=-30, out=120] (632.center) to (631);
		\draw [in=-165, out=150, looseness=1.50] (633.center) to (631);
		\draw (636.center) to (634);
		\draw (634) to (625);
		\draw (637.center) to (635);
		\draw (635) to (626);
	\end{pgfonlayer}
\end{tikzpicture}
$$

%
%\begin{definition} \cite{cpm}:
%Given a strongly compact closed category $\X$ equipped with a dagger functor $(\_)^\dag:\X^\op\to\X$, there is a strongly compact closed category, $\CPM(\X,(\_)^\dag)$ with:
%\begin{description}
%\item[Objects:] Same as in $\X$
%\item[Maps:]
%\item[Identity:]
%\item[Composition:]
%\item[Tensor:]
%
%
%\end{description}
%\end{definition}


\begin{corollary}
\label{cor}
For $p$ prime, $\Lag\Rel_{\F_p} \cong \CPM[\LinRel_{\F_p}]$ and  $\Lag\Rel_{\mathbb{Q}} \cong \CPM[\LinRel_{\mathbb{Q}}]$.
\end{corollary}

\section{Affine Lagrangian relations and stabilizer circuits}
\label{sec:aff}

Affine Lagrangian relations are perhaps of more practical interest than plain old Lagrangian relations.  As we will discuss in this section, these give a semantics for qudit stabilizer circuits as well as certain electrical circuits.  We use our universal set of generators for Lagrangian relations as well as the presentation for affine relations to get a universal set of generators for affine Lagrangian relations.


\begin{definition}
Let $\Aff\Lag\Rel_k$ denote the monoidal category whose objects are symplectic vector spaces, whose morphisms are affine subspaces, with tensor product given by the direct sum and composition given by relational composition.
\end{definition}
Because the tensor product is defined in the same way as in $\Lag\Rel_k$, as in Lemma \ref{lemma:strong}, the forgetful functor  $\Aff\Lag\Rel_k\to \Aff\Rel_k$ is faithful, strong monoidal.



\begin{definition}
Let $\alr_k$ denote the monoidal subcategory of $\aih_k$ with objects $2n$, generated by the morphisms in the image of $\Lag\Rel_k\xrightarrow{E} \LinRel_k \cong \ih_k \to \aih_k$ as well as the following generator:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0, 0) {$1$};
		\node [style=Z] (1) at (0.5, 0) {};
		\node [style=none] (2) at (0, 0.75) {};
		\node [style=none] (3) at (0.5, 0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (2.center) to (0);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{definition}

\begin{lemma}
$\alr_k$ is a presentation of $\Aff\Lag\Rel_k$.
\end{lemma}
\begin{proof}
All the affine shifts can be produced from tensoring and composing these two maps on the right:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0, 0) {$1$};
		\node [style=Z] (1) at (0.5, 0) {};
		\node [style=none] (2) at (0, 0.75) {};
		\node [style=none] (3) at (0.5, 0.75) {};
		\node [style=none] (4) at (0.5, 1.5) {};
		\node [style=none] (5) at (0, 1.5) {};
		\node [style=s] (6) at (0.5, 0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (2.center) to (0);
		\draw [in=270, out=90] (3.center) to (5.center);
		\draw [in=270, out=90] (2.center) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 0) {$1$};
		\node [style=Z] (1) at (0, 0) {};
		\node [style=none] (2) at (0.5, 0.75) {};
		\node [style=none] (3) at (0, 0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (2.center) to (0);
	\end{pgfonlayer}
\end{tikzpicture} \hspace*{.1cm} \in  \alr_k
\hspace*{.5cm}
\implies
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (447) at (224.25, 0.75) {};
		\node [style=X] (448) at (222.75, 0.75) {};
		\node [style=none] (449) at (223.75, -0.25) {};
		\node [style=none] (450) at (222.25, -0.25) {};
		\node [style=none] (451) at (224.25, 1.5) {};
		\node [style=none] (452) at (222.75, 1.5) {};
		\node [style=X] (453) at (223.25, -1) {$1$};
		\node [style=Z] (454) at (224.75, -1) {};
		\node [style=scalar] (455) at (223.25, -0.25) {$a$};
		\node [style=scalarop] (456) at (224.75, -0.25) {$a$};
		\node [style=none] (457) at (223.75, -1.5) {};
		\node [style=none] (458) at (222.25, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-150] (447) to (449.center);
		\draw [in=-150, out=90] (450.center) to (448);
		\draw (447) to (451.center);
		\draw (448) to (452.center);
		\draw (457.center) to (449.center);
		\draw (458.center) to (450.center);
		\draw (453) to (455);
		\draw (454) to (456);
		\draw [in=-30, out=90] (456) to (447);
		\draw [in=-30, out=90] (455) to (448);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (17) at (5, 0) {$a$};
		\node [style=none] (18) at (5.5, -1.5) {};
		\node [style=none] (19) at (5, -1.5) {};
		\node [style=none] (20) at (5.5, 1.5) {};
		\node [style=none] (21) at (5, 1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (19.center) to (17);
		\draw (17) to (21.center);
		\draw (18.center) to (20.center);
	\end{pgfonlayer}
\end{tikzpicture},
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (459) at (226.25, 0.75) {};
		\node [style=X] (460) at (227.75, 0.75) {};
		\node [style=none] (461) at (226.75, -0.25) {};
		\node [style=none] (462) at (228.25, -0.25) {};
		\node [style=none] (463) at (226.25, 1.5) {};
		\node [style=none] (464) at (227.75, 1.5) {};
		\node [style=X] (465) at (227.25, -1) {$1$};
		\node [style=Z] (466) at (225.75, -1) {};
		\node [style=scalar] (467) at (227.25, -0.25) {$a$};
		\node [style=scalarop] (468) at (225.75, -0.25) {$a$};
		\node [style=none] (469) at (226.75, -1.5) {};
		\node [style=none] (470) at (228.25, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-30] (459) to (461.center);
		\draw [in=-30, out=90] (462.center) to (460);
		\draw (459) to (463.center);
		\draw (460) to (464.center);
		\draw (469.center) to (461.center);
		\draw (470.center) to (462.center);
		\draw (465) to (467);
		\draw (466) to (468);
		\draw [in=-150, out=90] (468) to (459);
		\draw [in=-150, out=90] (467) to (460);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (1.5, 0) {$a$};
		\node [style=none] (1) at (1, -1.5) {};
		\node [style=none] (2) at (1.5, -1.5) {};
		\node [style=none] (3) at (1, 1.5) {};
		\node [style=none] (4) at (1.5, 1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (0);
		\draw (0) to (4.center);
		\draw (1.center) to (3.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.1cm}\in\alr_k
$$
\end{proof}
Therefore, we are justified in using string diagrams for affine relations to to reason about affine Lagrangian relations.

%We will restate the interpretations given in \cite{affine} of some components for electrical circuits in terms  affine relations  in terms of the generators for graphical calculus for Lagrangian relations.  This interpretation is also explored in \cite{passive,network}; albeit, not enjoying the graphical calculus for affine relations.

Affine Lagrangian relations have been used as a semantics for certain classes of electrical circuits:
\begin{example}
\label{ex:circuits}
TODO: MUCH MORE EXPOSITION, CITATIONS

For any non-negative real $a$, wires, $a$-weighted resistors, inductors and capacitors have the following interpretations in $\Aff\Lag\Rel_{\mathbb{R}(x)}$:
$$
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 4.25) {};
		\node [style=none] (1) at (22, 4.25) {};
		\node [style=none] (2) at (21, 2.75) {};
		\node [style=none] (3) at (22, 2.75) {};
		\node [style=dot] (4) at (21.5, 3.5) {};
		\node [style=none] (5) at (21.5, 4) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90] (0.center) to (4);
		\draw [in=90, out=-150] (4) to (2.center);
		\draw [in=-30, out=90] (3.center) to (4);
		\draw [in=-90, out=30] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (501) at (237.5, 4.25) {};
		\node [style=none] (502) at (238.5, 4.25) {};
		\node [style=none] (503) at (237.5, 2.75) {};
		\node [style=none] (504) at (238.5, 2.75) {};
		\node [style=X] (505) at (238, 3.5) {};
		\node [style=none] (506) at (238, 4) {$\cdots$};
		\node [style=none] (507) at (238, 3) {$\cdots$};
		\node [style=none] (508) at (236.25, 4.25) {};
		\node [style=none] (509) at (237.25, 4.25) {};
		\node [style=none] (510) at (236.25, 2.75) {};
		\node [style=none] (511) at (237.25, 2.75) {};
		\node [style=Z] (512) at (236.75, 3.5) {};
		\node [style=none] (513) at (236.75, 4) {$\cdots$};
		\node [style=none] (514) at (236.75, 3) {$\cdots$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90] (501.center) to (505);
		\draw [in=90, out=-150] (505) to (503.center);
		\draw [in=-30, out=90] (504.center) to (505);
		\draw [in=-90, out=30] (505) to (502.center);
		\draw [in=150, out=-90] (508.center) to (512);
		\draw [in=90, out=-150] (512) to (510.center);
		\draw [in=-30, out=90] (511.center) to (512);
		\draw [in=-90, out=30] (512) to (509.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\left\llbracket
\tikz \draw (0,0) to[R=$a$] (0,2);
\hspace*{,3cm}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (23, 3.75) {};
		\node [style=X] (1) at (22, 5.25) {};
		\node [style=scalar] (2) at (22.5, 4.5) {$a$};
		\node [style=none] (3) at (22, 5.75) {};
		\node [style=none] (4) at (23, 5.75) {};
		\node [style=none] (5) at (23, 3.25) {};
		\node [style=none] (6) at (22, 3.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=135] (0) to (2);
		\draw [in=315, out=90] (2) to (1);
		\draw (1) to (3.center);
		\draw (1) to (6.center);
		\draw (5.center) to (0);
		\draw (4.center) to (0);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\left\llbracket
\tikz \draw (0,0) to[L=$a$] (0,2);
\hspace*{,3cm}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (23, 3.75) {};
		\node [style=X] (1) at (22, 5.25) {};
		\node [style=scalar] (2) at (22.5, 4.5) {$ax$};
		\node [style=none] (3) at (22, 5.75) {};
		\node [style=none] (4) at (23, 5.75) {};
		\node [style=none] (5) at (23, 3.25) {};
		\node [style=none] (6) at (22, 3.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=135] (0) to (2);
		\draw [in=315, out=90] (2) to (1);
		\draw (1) to (3.center);
		\draw (1) to (6.center);
		\draw (5.center) to (0);
		\draw (4.center) to (0);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\left\llbracket
\tikz \draw (0,0) to[C=$a$] (0,2);
\hspace*{,3cm}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (23.25, 3.75) {};
		\node [style=X] (1) at (21.75, 5.25) {};
		\node [style=scalar] (2) at (22.5, 4.5) {$-ax$};
		\node [style=none] (3) at (21.75, 5.75) {};
		\node [style=none] (4) at (23.25, 5.75) {};
		\node [style=none] (5) at (23.25, 3.25) {};
		\node [style=none] (6) at (21.75, 3.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=135] (0) to (2);
		\draw [in=315, out=90] (2) to (1);
		\draw (1) to (3.center);
		\draw (1) to (6.center);
		\draw (5.center) to (0);
		\draw (4.center) to (0);
	\end{pgfonlayer}
\end{tikzpicture}
$$
Similarly for $a$-valued voltage and current sources (again, for $a$ a non-negative real number):
$$
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0, 2) {};
		\node [style=isourceAMshape,rotate=90] (1) at (0, 1) {};
		\node [style=none] (2) at (0, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (1) to (0.center);
		\node [style=none] (3) at (-.7, 1) {$a$};
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{,3cm}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (1) at (22, 5.25) {};
		\node [style=scalar] (2) at (22.5, 4.5) {$ax$};
		\node [style=none] (3) at (22, 5.75) {};
		\node [style=none] (4) at (23, 5.75) {};
		\node [style=none] (5) at (23, 3.25) {};
		\node [style=none] (6) at (22, 3.25) {};
		\node [style=X] (7) at (22.5, 3.75) {$1$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=315, out=90] (2) to (1);
		\draw (1) to (3.center);
		\draw (1) to (6.center);
		\draw (7) to (2);
		\draw (5.center) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (32) at (129.25, -0.25) {$ax$};
		\node [style=none] (33) at (129.25, 1) {};
		\node [style=none] (34) at (129.75, 1) {};
		\node [style=none] (35) at (129.75, -1.5) {};
		\node [style=none] (36) at (129.25, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (32) to (33.center);
		\draw (32) to (36.center);
		\draw (35.center) to (34.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace{,3cm}
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0, 2) {};
		\node [style=vsourceAMshape,rotate=-90] (1) at (0, 1) {};
		\node [style=none] (2) at (0, 0) {};
		\node [style=none] (3) at (-.7, 1) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (1) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{,3cm}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (28) at (9, 1) {};
		\node [style=none] (29) at (10, 1) {};
		\node [style=none] (30) at (10, -1.5) {};
		\node [style=none] (31) at (9, -1.5) {};
		\node [style=Z] (32) at (9, 0.25) {};
		\node [style=Z] (33) at (9, -0.75) {};
		\node [style=X] (34) at (9.5, -1.25) {$1$};
		\node [style=scalar] (35) at (9.5, -0.5) {$a$};
		\node [style=Z] (36) at (10, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (31.center) to (33);
		\draw (32) to (28.center);
		\draw (36) to (29.center);
		\draw [in=90, out=-150] (36) to (35);
		\draw (35) to (34);
		\draw (30.center) to (36);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (37) at (11, 1) {};
		\node [style=none] (38) at (12, 1) {};
		\node [style=none] (39) at (12, -1.5) {};
		\node [style=none] (40) at (11, -1.5) {};
		\node [style=Z] (41) at (11, 0.25) {};
		\node [style=Z] (42) at (11, -0.75) {};
		\node [style=X] (43) at (11.5, -1.25) {$1$};
		\node [style=Z] (45) at (12, -0.25) {};
		\node [style=scalar] (46) at (12, 0.5) {$a$};
		\node [style=scalarop] (47) at (12, -1) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (40.center) to (42);
		\draw (41) to (37.center);
		\draw (45) to (46);
		\draw (46) to (38.center);
		\draw [in=-150, out=90] (43) to (45);
		\draw (39.center) to (47);
		\draw (47) to (45);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (73) at (17, 0.75) {};
		\node [style=none] (74) at (17.75, 0.75) {};
		\node [style=none] (75) at (17.75, -2) {};
		\node [style=none] (76) at (17, -2) {};
		\node [style=Z] (77) at (17, 0.25) {};
		\node [style=Z] (78) at (17, -0.5) {};
		\node [style=X] (79) at (17.75, 0.25) {$a$};
		\node [style=scalarop] (80) at (17.75, -1.5) {$a$};
		\node [style=X] (83) at (17.75, -0.5) {$1$};
		\node [style=s] (84) at (17.75, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (76.center) to (78);
		\draw (77) to (73.center);
		\draw [in=-90, out=90] (75.center) to (80);
		\draw (79) to (74.center);
		\draw (84) to (83);
		\draw [in=-90, out=90] (80) to (84);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (84) at (18.75, 1.25) {};
		\node [style=none] (85) at (19.5, 1.25) {};
		\node [style=none] (86) at (19.5, -1.5) {};
		\node [style=none] (87) at (18.75, -1.5) {};
		\node [style=Z] (88) at (18.75, 0.25) {};
		\node [style=Z] (89) at (18.75, -0.5) {};
		\node [style=X] (90) at (19.5, 0.25) {$1$};
		\node [style=X] (91) at (19.5, -0.5) {$1$};
		\node [style=scalarop] (92) at (19.5, -1) {$-a$};
		\node [style=scalar] (93) at (18.75, -1) {$-a$};
		\node [style=scalar] (94) at (19.5, 0.75) {$a$};
		\node [style=scalarop] (95) at (18.75, 0.75) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (86.center) to (92);
		\draw (92) to (91);
		\draw (89) to (93);
		\draw (87.center) to (93);
		\draw (88) to (95);
		\draw (95) to (84.center);
		\draw (90) to (94);
		\draw (94) to (85.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (602) at (268.25, 1.75) {};
		\node [style=none] (603) at (269, 1.75) {};
		\node [style=none] (604) at (269, -1) {};
		\node [style=none] (605) at (267.25, -1) {};
		\node [style=Z] (606) at (268.25, 0.75) {};
		\node [style=Z] (607) at (267.75, 0.25) {};
		\node [style=X] (608) at (269, 0.75) {$1$};
		\node [style=X] (609) at (269.5, 0.25) {};
		\node [style=scalarop] (610) at (269, -0.5) {$-a$};
		\node [style=scalar] (611) at (267.25, -0.5) {$-a$};
		\node [style=scalar] (612) at (269, 1.25) {$a$};
		\node [style=scalarop] (613) at (268.25, 1.25) {$a$};
		\node [style=Z] (614) at (268.25, -0.5) {};
		\node [style=X] (615) at (270, -0.5) {$1$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (604.center) to (610);
		\draw [in=-150, out=90] (610) to (609);
		\draw [in=90, out=-150] (607) to (611);
		\draw (605.center) to (611);
		\draw (606) to (613);
		\draw (613) to (602.center);
		\draw (608) to (612);
		\draw (612) to (603.center);
		\draw [in=-30, out=90] (615) to (609);
		\draw [in=-30, out=90] (614) to (607);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{example}
Note that these generators do not generate the whole category of Lagrangian relations; for instance, the coefficients are required to be non-negative.

\subsection{Stabilizer circuits and Spekkens' toy model}


In this subsection, we show that, when $p$ is an odd prime, the prop of affine Lagrangian relations over $\F_p$  is isomoprhic to $p$-dimensional qudit stabilizer circuits, modulo invertible scalars.


We can go further with affine Lagrangian relations.  Inspired by the work of Spekkens \cite{spekkens,spekkens2016quasi}:




We first give a review of the qudit stabilizer formalism, All of the material from Definition \ref{definition:begin} to \ref{lemma:end} are contained in \cite{generators}.


\begin{definition}
\label{definition:begin}
Given odd prie qudit dimension $p$, the  {\bf shift and boost operators} 
${\cal Z} := \sum_{a =0}^{p-1} e^{2\pi i a/p} |  a  \hspace*{1cm }{\cal Z} := \sum_{a =0}^{p-1}  |  a+1 \rangle\langle a |$.



An $n$-qudit {\bf Weyl operator} an $p^n$-dimensional unitary generated by the shift and boost operators under tensor product and matrix multiplication. Every single dit Weyl operator is of the following form for $z,x,a \in \F_p$:

$$
e^{\pi \cdot i\cdot a /p} {\cal Z}^z{\cal X}^x
$$

Weyl operators commute with each other according to the symplectic form so that:

$$
({\cal Z}^{z_0}{\cal X}^{x_0}) 
({\cal Z}^{z_1}{\cal X}^{x_1} )
=
e^{\pi\cdot i \cdot \omega((z_0,x_0),(z_1,x_1)) /p}
({\cal Z}^{z_1}{\cal X}^{x_1})
({\cal Z}^{z_0}{\cal X}^{x_0}  )
$$

The $n$-qudit {\bf Weyl group},${\frak P}_p^{ n}$, is generated by the $n$-qudit Weyl operators under matrix multiplication.


An $n$-qudit {\bf Clifford operator} $U$ is an $p^n$-dimensional unitary that preserves the Weyl group, so that $U {\frak P}_p^{ n} U^\dag = {\frak P}_p^{ n}$.

The $n$-qudit {\bf Clifford group} is formed by the $n$-qudit Clifford operators under matrix multiplication.

An $n$-qudit {\bf stabilizer state} is a state $ U |0\rangle^{\otimes n}$ for an $n$-qudit Clifford $U$.

Given any $n$-qudit stabilizer state $|\psi \rangle$,  the {\bf stabilizer group} of $|\psi \rangle$  is the (Abelian) subgroup of ${\frak S}_{|\psi\rangle} \subset {\frak P}_d^{ n}$ whose elements are the $U \in {\frak P}_d^{ n}$ for which $U|\psi \rangle=|\psi \rangle$.
\end{definition}


\begin{lemma}
Two stabilizer states with the same stabilizer groups are the same, up to global phases.
\end{lemma}

TODO semidirect product

\begin{lemma}
\label{lemma:end}
For natural numbers $n,d \geq 2$ the $n$-dimensional qudit stabilizer group modulo invertible scalars is generated under tensor and composition of $I_d$ as well as the boost operator ${\cal X}$, the controlled-boost operator  ${\cal C}$, the Fourier transform ${\cal F}$ and the phase-shift operator ${\cal S}$:
$$
{\cal C}  := \sum_{a,b = 0 }^{d-1} |a,a+b \rangle\langle a, b|
\hspace*{.5cm}
{\cal F}  := \frac{1}{\sqrt d}\sum_{a,b= 0 }^{d-1} e^{2\pi i ab/d} |b \rangle\langle a|
\hspace*{.5cm}
{\cal S} := \sum_{a =0}^{d-1} e^{\pi i a (a+d)/d} |  a  \rangle\langle a |
$$
Notice that the boost operator can be obtained by ${\cal Z }={\cal F}{\cal X} {\cal F}^{2}={\cal F}{\cal X} {\cal F}^{-1}$.
\end{lemma}

%\bar{e^{\pi i a (a+d)/d}}|  a  \rangle\langle a |
%e^{-\pi i a (a+d)/d}|  a  \rangle\langle a |
%e^{-\pi i a (a+d)/d}|  a  \rangle\langle a |


\begin{definition}
Let $\Stab_p$ denote the subcategory of $\Mat(\C)$ generated by the $p$-dimensional qudit Clifford group as well as the vectors $| 0\rangle$, $\langle 0|$, quotiented by invertible scalars.
\end{definition}


The following isomorphism is described in \cite{gross}, when restricted to the nonempty case.  This comes from the projective representation of the $n$ qudit odd-prime-dimensional Clifford group in terms of the affine symplectomorphisms over $\F_p^n$.  However, since there is only one empty relation and one zero matrix of every type, we get the following result immediately:

\begin{lemma}
For every odd prime $p$, there is an isomorphism $G:\Aff\Lag\Rel_{\F_p}(0, n) \to \Stab_p(0,n)$ determined by:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (393) at (206, -2) {$\pi$};
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto 
0
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (389) at (205, -2) {};
		\node [style=none] (390) at (205, -1.5) {};
		\node [style=Z] (391) at (204.5, -2) {};
		\node [style=none] (392) at (204.5, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (389) to (390.center);
		\draw (391) to (392.center);
	\end{pgfonlayer}
\end{tikzpicture}
 \mapsto |0\rangle
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (391) at (206, -1) {};
		\node [style=none] (392) at (206, -2) {};
		\node [style=none] (393) at (206.5, -1) {};
		\node [style=none] (394) at (206.5, -2) {};
		\node [style=X] (395) at (206.5, -1.5) {$1$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (392.center) to (391.center);
		\draw (393.center) to (395);
		\draw (395) to (394.center);
	\end{pgfonlayer}
\end{tikzpicture}
 \mapsto {\cal X}
\hspace*{.5cm}
C_1 \mapsto {\cal C}
\hspace*{.5cm}
F \mapsto {\cal F}
\hspace*{.5cm}
S_1 \mapsto {\cal S}
$$
\end{lemma}

We extend this isomorphim of states to an isomorphism of props using a symplectic notion of Weyl groups and stabilizers.


\begin{definition}
Given a field $k$ and natural number $n$, the {\bf symplectic Pauli group} on $n$ wires, $P_k^n$ is generated by the following affine Lagrangian relations under tensor product, for $z,x \in k$:

$$
W(a,b):=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0, 1) {$a$};
		\node [style=none] (1) at (0, 2) {};
		\node [style=none] (2) at (0, 0) {};
		\node [style=none] (3) at (1, 2) {};
		\node [style=none] (4) at (1, 0) {};
		\node [style=X] (5) at (1, 1) {$b$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (4.center) to (5.center);
		\draw (5.center) to (3.center);
		\draw (1.center) to (0.center);
		\draw (0.center) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

Call elements of the generalized Pauli group {\bf symplectic Weyl operators}.
Given a tuple $$((z_1,\cdots, z_n),(x_1,\cdots, x_n)) \in (k^n)^2$$ define a Weyl operator $$W((z_1,\cdots, z_n),(x_1,\cdots, x_n) )= W(z_1,x_1)\oplus \cdots \oplus W(z_n,x_n)$$
\end{definition}



\begin{definition}
Given some affine Lagrangian subspace $f$ of $\F_k^{2n}$, the {\bf symplectic stabilizer group} of $f$ is the subgroup of the generalized Pauli group generated by the Weyl operators $a \in P_k^n$ so that $f; a =f$ under relational composition.
\end{definition}

\begin{lemma}
Two affine Lagrangian subspaces are equal if and only if they have the same symplectic stabilizer group.
\end{lemma}

\begin{proof}
Take a state $f:0\to n$ in $\Aff\Lag\Rel_k$.  Then $(z,x) \in f$ if and only if $W(z,x)$ is stabilized by $f$.  Since subspaces are equal if and only if they have the same elements, this proves the claim.
\end{proof}




\begin{theorem}
\label{theorem:spekkens}
When $p$ is an odd prime, the mapping $H:\Aff\Lag\Rel_{\F_p} \to \Stab_p$ defined by:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (21) at (2, -2) {$f$};
		\node [style=none] (22) at (1.75, -1.25) {};
		\node [style=none] (23) at (2.25, -1.25) {};
		\node [style=none] (24) at (1.75, -2.75) {};
		\node [style=none] (25) at (2.25, -2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (21) to (22.center);
		\draw [in=90, out=-120] (21) to (24.center);
		\draw [in=-60, out=90] (25.center) to (21);
		\draw [in=-90, out=60] (21) to (23.center);
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (7) at (12, 0) {$G\left(\hat f\right)$};
		\node [style=none] (8) at (11.25, 1.5) {};
		\node [style=map] (10) at (13, 1) {$\eta$};
		\node [style=none] (12) at (13.5, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (8.center) to (7);
		\draw [in=-150, out=60, looseness=0.75] (7) to (10);
		\draw [in=-45, out=90] (12.center) to (10);
	\end{pgfonlayer}
\end{tikzpicture}
$$
is a symmetric monoidal isomorphism, where $\eta$ is the cap of the compact closed structure induced by the $Z$ observable.
\end{theorem}

%
%%See Appendix \ref{proof:theorem:spekkens} for the proof.  
%The main difficulty in proving this is to show that $H$ is a functor.  This is shown by observing that stabilizer states with the same stabilizer group only differ by a global scalar.


\begin{proof}
Consider some composable pair in $\Aff\Lag\Rel_{\F_p}$:
$$
\F_p^n \xrightarrow{f} \F_p^m \xrightarrow{g} \F_p^\ell
$$
If the composite is empty, then the result follows immediately.  Suppose otherwise.
We know that:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (189) at (103, 0) {$\hat {f;g}$};
		\node [style=none] (190) at (102.25, 1.5) {};
		\node [style=none] (191) at (103.25, 1.5) {};
		\node [style=none] (192) at (102.75, 1.5) {};
		\node [style=none] (193) at (103.75, 1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (190.center) to (189);
		\draw [in=-90, out=75] (189) to (191.center);
		\draw [in=-90, out=45] (189) to (193.center);
		\draw [in=105, out=-90] (192.center) to (189);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (163) at (96.5, -2.25) {$f;g$};
		\node [style=none] (164) at (96.75, -1.5) {};
		\node [style=none] (165) at (95.75, -1.5) {};
		\node [style=Z] (166) at (96.25, -3) {};
		\node [style=X] (167) at (95.75, -3) {};
		\node [style=none] (168) at (95.75, -2.25) {};
		\node [style=none] (169) at (95.25, -2.25) {};
		\node [style=none] (170) at (96.25, -1.5) {};
		\node [style=none] (171) at (95.25, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=60] (163) to (164.center);
		\draw [in=-90, out=120] (163) to (165.center);
		\draw [in=-120, out=30] (167) to (163);
		\draw [in=30, out=-60, looseness=1.25] (163) to (166);
		\draw [in=-90, out=150] (166) to (168.center);
		\draw [in=-90, out=135] (167) to (169.center);
		\draw (169.center) to (171.center);
		\draw [in=-90, out=90] (168.center) to (170.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (211) at (110.5, -2.25) {$g$};
		\node [style=none] (212) at (110.75, -1.5) {};
		\node [style=none] (213) at (109.75, -1.5) {};
		\node [style=Z] (214) at (110.25, -3) {};
		\node [style=X] (215) at (109.75, -3) {};
		\node [style=none] (216) at (109.75, -2.25) {};
		\node [style=none] (217) at (109.25, -2.25) {};
		\node [style=none] (218) at (110.25, -1.5) {};
		\node [style=none] (219) at (109.25, -1.5) {};
		\node [style=map] (220) at (112.5, -2.25) {$f$};
		\node [style=none] (221) at (112.75, -1.5) {};
		\node [style=none] (222) at (111.75, -1.5) {};
		\node [style=Z] (223) at (112.25, -3) {};
		\node [style=X] (224) at (111.75, -3) {};
		\node [style=none] (225) at (111.75, -2.25) {};
		\node [style=none] (226) at (111.25, -2.25) {};
		\node [style=none] (227) at (112.25, -1.5) {};
		\node [style=none] (228) at (111.25, -1.5) {};
		\node [style=Z] (229) at (111.5, -0.5) {};
		\node [style=X] (230) at (110.5, -0.5) {};
		\node [style=none] (231) at (110.5, 0.25) {};
		\node [style=none] (232) at (111.5, 0.25) {};
		\node [style=none] (233) at (109.25, 0.25) {};
		\node [style=none] (234) at (112.75, 0.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=60] (211) to (212.center);
		\draw [in=-90, out=120] (211) to (213.center);
		\draw [in=-120, out=30] (215) to (211);
		\draw [in=30, out=-60, looseness=1.25] (211) to (214);
		\draw [in=-90, out=150] (214) to (216.center);
		\draw [in=-90, out=135] (215) to (217.center);
		\draw (217.center) to (219.center);
		\draw [in=-90, out=90] (216.center) to (218.center);
		\draw [in=-90, out=60] (220) to (221.center);
		\draw [in=-90, out=120] (220) to (222.center);
		\draw [in=-120, out=30] (224) to (220);
		\draw [in=30, out=-60, looseness=1.25] (220) to (223);
		\draw [in=-90, out=150] (223) to (225.center);
		\draw [in=-90, out=135] (224) to (226.center);
		\draw (226.center) to (228.center);
		\draw [in=-90, out=90] (225.center) to (227.center);
		\draw [in=-30, out=90] (227.center) to (229);
		\draw [in=90, out=-150] (229) to (212.center);
		\draw [in=-30, out=90] (228.center) to (230);
		\draw [in=90, out=-150] (230) to (213.center);
		\draw (219.center) to (233.center);
		\draw [in=-90, out=90] (218.center) to (232.center);
		\draw [in=-90, out=90, looseness=0.75] (222.center) to (231.center);
		\draw (221.center) to (234.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (64) at (28.75, 0) {$\hat g$};
		\node [style=none] (65) at (28, 1.25) {};
		\node [style=X] (66) at (29.25, 1) {};
		\node [style=Z] (67) at (29.75, 1) {};
		\node [style=none] (68) at (28.75, 1.25) {};
		\node [style=map] (69) at (30.25, 0) {$\hat f$};
		\node [style=none] (70) at (30.25, 1.25) {};
		\node [style=none] (71) at (31, 1.25) {};
		\node [style=none] (72) at (30.25, 2.5) {};
		\node [style=none] (73) at (28.75, 2.5) {};
		\node [style=none] (74) at (31, 2.5) {};
		\node [style=none] (75) at (28, 2.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (65.center) to (64);
		\draw [in=-150, out=45] (64) to (67);
		\draw [in=-165, out=105, looseness=1.25] (64) to (66);
		\draw [in=-90, out=60] (64) to (68.center);
		\draw [in=-30, out=60, looseness=1.25] (69) to (67);
		\draw [in=135, out=-30] (66) to (69);
		\draw [in=-90, out=120] (69) to (70.center);
		\draw [in=45, out=-90] (71.center) to (69);
		\draw (65.center) to (75.center);
		\draw [in=270, out=90] (68.center) to (72.center);
		\draw (71.center) to (74.center);
		\draw [in=270, out=90] (70.center) to (73.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

We have the following equality of diagrams in $\Stab_p$, 
We draw the wires exiting $G$ to be connected to the corresponding wires in the $X$ block of the subspace.
\begin{align*}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (29) at (23, 0) {$G\left(\hat {f;g}\right)$};
		\node [style=none] (30) at (22.25, 1.5) {};
		\node [style=none] (33) at (23.75, 1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (30.center) to (29);
		\draw [in=-90, out=45] (29) to (33.center);
	\end{pgfonlayer}
\end{tikzpicture}
&=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (244) at (170.75, -4.5) {$\hat g$};
		\node [style=none] (245) at (170, -3.25) {};
		\node [style=X] (246) at (171.25, -3.5) {};
		\node [style=Z] (247) at (171.75, -3.5) {};
		\node [style=none] (248) at (170.75, -3.25) {};
		\node [style=map] (249) at (172.25, -4.5) {$\hat f$};
		\node [style=none] (250) at (172.25, -3.25) {};
		\node [style=none] (251) at (173, -3.25) {};
		\node [style=none] (252) at (172.25, -2) {};
		\node [style=none] (253) at (170.75, -2) {};
		\node [style=none] (254) at (173, -2) {};
		\node [style=none] (255) at (170, -2) {};
		\node [style=none] (256) at (169.75, -2) {};
		\node [style=none] (257) at (173.25, -2) {};
		\node [style=none] (258) at (173.25, -5) {};
		\node [style=none] (259) at (169.75, -5) {};
		\node [style=none] (260) at (170, -4.75) {$G$};
		\node [style=none] (261) at (170.75, -2) {};
		\node [style=none] (262) at (170, -2) {};
		\node [style=none] (263) at (170.75, -1.25) {};
		\node [style=none] (264) at (170, -1.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (245.center) to (244);
		\draw [in=-150, out=45] (244) to (247);
		\draw [in=-165, out=105, looseness=1.25] (244) to (246);
		\draw [in=-90, out=60] (244) to (248.center);
		\draw [in=-30, out=60, looseness=1.25] (249) to (247);
		\draw [in=135, out=-30] (246) to (249);
		\draw [in=-90, out=120] (249) to (250.center);
		\draw [in=45, out=-90] (251.center) to (249);
		\draw (245.center) to (255.center);
		\draw [in=270, out=90] (248.center) to (252.center);
		\draw (251.center) to (254.center);
		\draw [in=270, out=90] (250.center) to (253.center);
		\draw (257.center) to (256.center);
		\draw (256.center) to (259.center);
		\draw (259.center) to (258.center);
		\draw (258.center) to (257.center);
		\draw (262.center) to (264.center);
		\draw (261.center) to (263.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (12) at (200, -1.75) {$\hat g$};
		\node [style=none] (13) at (199.25, -0.25) {};
		\node [style=none] (14) at (199.75, -0.25) {};
		\node [style=map] (15) at (202, -1.75) {$\hat f$};
		\node [style=none] (16) at (202.25, -0.25) {};
		\node [style=none] (17) at (202.75, -0.25) {};
		\node [style=none] (18) at (199, -0.25) {};
		\node [style=none] (19) at (203, -0.25) {};
		\node [style=none] (20) at (203, -2.25) {};
		\node [style=none] (21) at (199, -2.25) {};
		\node [style=none] (22) at (199.25, -2) {$G$};
		\node [style=none] (23) at (200.75, -0.25) {};
		\node [style=none] (24) at (199.25, -0.25) {};
		\node [style=none] (25) at (200.75, 1) {};
		\node [style=none] (26) at (199.25, 1) {};
		\node [style=none] (27) at (201.25, -0.25) {};
		\node [style=none] (28) at (201.75, -0.25) {};
		\node [style=none] (29) at (200.75, -0.25) {};
		\node [style=none] (30) at (200.25, -0.25) {};
		\node [style=none] (31) at (199.75, -0.25) {};
		\node [style=none] (32) at (200.25, -0.25) {};
		\node [style=map] (33) at (200, 0.5) {$\eta$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (13.center) to (12);
		\draw [in=-90, out=105] (12) to (14.center);
		\draw [in=-90, out=75] (15) to (16.center);
		\draw [in=45, out=-90] (17.center) to (15);
		\draw (19.center) to (18.center);
		\draw (18.center) to (21.center);
		\draw (21.center) to (20.center);
		\draw (20.center) to (19.center);
		\draw (24.center) to (26.center);
		\draw (23.center) to (25.center);
		\draw [in=-90, out=45] (12) to (28.center);
		\draw [in=-90, out=75] (12) to (27.center);
		\draw [in=-90, out=105] (15) to (29.center);
		\draw [in=-90, out=135] (15) to (30.center);
		\draw [in=90, out=-120] (33) to (31.center);
		\draw [in=90, out=-60] (33) to (32.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (34) at (204.75, 0) {$G\left(\hat g\right)$};
		\node [style=none] (35) at (204, 1.25) {};
		\node [style=map] (36) at (205.5, 1) {$\eta$};
		\node [style=map] (37) at (206.25, 0) {$G\left(\hat f\right)$};
		\node [style=none] (38) at (207, 1.25) {};
		\node [style=none] (39) at (207, 2.5) {};
		\node [style=none] (40) at (204, 2.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (35.center) to (34);
		\draw [in=-120, out=45, looseness=0.75] (34) to (36);
		\draw [in=-60, out=135, looseness=0.75] (37) to (36);
		\draw [in=45, out=-90] (38.center) to (37);
		\draw (35.center) to (40.center);
		\draw (38.center) to (39.center);
	\end{pgfonlayer}
\end{tikzpicture}
\end{align*}

This second equality is the only nontrivial part.  It follows by observing that both stabilizer states have the same symplectic stabilizers groups.  This is because  the generalized Pauli operators can be pulled through $G$, by \cite[Lemma 4]{gross}, where they act the same on the caps of Lagrangian relations and in matrices.
%More explicitly, each white cap acting on the $i$th and $j$ wire is just removing vectors $[X_k|Z_k]$ from the stabilizer subspace which $X_{i.k}\neq -X_{i.k}$ or $Z_{i.k}\neq Z_{i.k}$ and then projecting out the $i$th and $j$th columns.

Explicity, the boost and shift operators commute with the cap as follows:
$$
\begin{tabular}{c}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (515) at (241, -0.25) {};
		\node [style=none] (516) at (241, -1) {};
		\node [style=none] (517) at (239.5, -1) {};
		\node [style=X] (518) at (240, 0.75) {};
		\node [style=Z] (519) at (241.5, 0.75) {};
		\node [style=none] (520) at (240.5, -0.25) {};
		\node [style=none] (521) at (242, -0.25) {};
		\node [style=none] (522) at (240.5, -1) {};
		\node [style=none] (523) at (242, -1) {};
		\node [style=none] (524) at (239.5, -0.25) {};
		\node [style=X] (525) at (239.5, -0.25) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (516.center) to (515.center);
		\draw [in=-165, out=90] (515.center) to (519);
		\draw [in=-15, out=90] (520.center) to (518);
		\draw [in=-15, out=90] (521.center) to (519);
		\draw (523.center) to (521.center);
		\draw (520.center) to (522.center);
		\draw (517.center) to (524.center);
		\draw [in=-165, out=90] (524.center) to (518);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (526) at (244.25, -0.25) {};
		\node [style=none] (527) at (244.25, -1) {};
		\node [style=none] (528) at (242.75, -1) {};
		\node [style=X] (529) at (243.25, 0.75) {$a$};
		\node [style=Z] (530) at (244.75, 0.75) {};
		\node [style=none] (531) at (243.75, -0.25) {};
		\node [style=none] (532) at (245.25, -0.25) {};
		\node [style=none] (533) at (243.75, -1) {};
		\node [style=none] (534) at (245.25, -1) {};
		\node [style=none] (535) at (242.75, -0.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (527.center) to (526.center);
		\draw [in=-165, out=90] (526.center) to (530);
		\draw [in=-15, out=90] (531.center) to (529);
		\draw [in=-15, out=90] (532.center) to (530);
		\draw (534.center) to (532.center);
		\draw (531.center) to (533.center);
		\draw (528.center) to (535.center);
		\draw [in=-165, out=90] (535.center) to (529);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (536) at (247.5, -0.25) {};
		\node [style=none] (537) at (247.5, -1) {};
		\node [style=none] (538) at (246, -1) {};
		\node [style=X] (539) at (246.5, 0.75) {};
		\node [style=Z] (540) at (248, 0.75) {};
		\node [style=none] (541) at (247, -0.25) {};
		\node [style=none] (542) at (248.5, -0.25) {};
		\node [style=none] (543) at (247, -1) {};
		\node [style=none] (544) at (248.5, -1) {};
		\node [style=none] (545) at (246, -0.25) {};
		\node [style=X] (546) at (247, -0.25) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (537.center) to (536.center);
		\draw [in=-165, out=90] (536.center) to (540);
		\draw [in=-15, out=90] (541.center) to (539);
		\draw [in=-15, out=90] (542.center) to (540);
		\draw (544.center) to (542.center);
		\draw (541.center) to (543.center);
		\draw (538.center) to (545.center);
		\draw [in=-165, out=90] (545.center) to (539);
	\end{pgfonlayer}
\end{tikzpicture}\\
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (547) at (249.25, -3.75) {};
		\node [style=none] (548) at (249.25, -4.5) {};
		\node [style=none] (549) at (247.75, -4.5) {};
		\node [style=X] (550) at (248.25, -2.75) {};
		\node [style=Z] (551) at (249.75, -2.75) {};
		\node [style=none] (552) at (248.75, -3.75) {};
		\node [style=none] (553) at (250.25, -3.75) {};
		\node [style=none] (554) at (248.75, -4.5) {};
		\node [style=none] (555) at (250.25, -4.5) {};
		\node [style=none] (556) at (247.75, -3.75) {};
		\node [style=X] (557) at (249.25, -3.75) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (548.center) to (547.center);
		\draw [in=-165, out=90] (547.center) to (551);
		\draw [in=-15, out=90] (552.center) to (550);
		\draw [in=-15, out=90] (553.center) to (551);
		\draw (555.center) to (553.center);
		\draw (552.center) to (554.center);
		\draw (549.center) to (556.center);
		\draw [in=-165, out=90] (556.center) to (550);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (558) at (253, -4.5) {};
		\node [style=none] (559) at (251.5, -4.5) {};
		\node [style=X] (560) at (252, -2) {};
		\node [style=none] (561) at (252.5, -3) {};
		\node [style=none] (562) at (252.5, -4.5) {};
		\node [style=none] (563) at (254, -3) {};
		\node [style=none] (564) at (251.5, -3) {};
		\node [style=X] (565) at (253, -3.75) {$a$};
		\node [style=X] (566) at (253.5, -2) {};
		\node [style=s] (567) at (253, -3) {};
		\node [style=none] (568) at (254, -4.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-15, out=90] (561.center) to (560);
		\draw [in=90, out=-90] (561.center) to (562.center);
		\draw (559.center) to (564.center);
		\draw [in=-165, out=90] (564.center) to (560);
		\draw [in=-15, out=90] (563.center) to (566);
		\draw (558.center) to (565);
		\draw (565) to (567);
		\draw [in=-165, out=90] (567) to (566);
		\draw (568.center) to (563.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (569) at (256.75, -4.5) {};
		\node [style=none] (570) at (255.25, -4.5) {};
		\node [style=X] (571) at (255.75, -2) {};
		\node [style=none] (572) at (256.25, -3) {};
		\node [style=none] (573) at (256.25, -4.5) {};
		\node [style=none] (574) at (257.75, -3) {};
		\node [style=none] (575) at (255.25, -3) {};
		\node [style=X] (576) at (257.25, -2) {};
		\node [style=none] (577) at (257.75, -4.5) {};
		\node [style=s] (578) at (256.75, -3.75) {};
		\node [style=X] (579) at (256.75, -3) {$-a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-15, out=90] (572.center) to (571);
		\draw [in=90, out=-90] (572.center) to (573.center);
		\draw (570.center) to (575.center);
		\draw [in=-165, out=90] (575.center) to (571);
		\draw [in=-15, out=90] (574.center) to (576);
		\draw (577.center) to (574.center);
		\draw (569.center) to (578);
		\draw (578) to (579);
		\draw [in=-165, out=90] (579) to (576);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (580) at (261.25, -3.75) {};
		\node [style=none] (581) at (259.75, -3.75) {};
		\node [style=X] (582) at (260.25, -2) {};
		\node [style=none] (583) at (260.75, -3) {};
		\node [style=none] (584) at (260.75, -3.75) {};
		\node [style=none] (585) at (262.25, -3) {};
		\node [style=none] (586) at (259.75, -3) {};
		\node [style=X] (587) at (261.75, -2) {};
		\node [style=none] (588) at (262.25, -3.75) {};
		\node [style=s] (589) at (261.25, -3) {};
		\node [style=X] (590) at (262.25, -3) {$-a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-15, out=90] (583.center) to (582);
		\draw [in=90, out=-90] (583.center) to (584.center);
		\draw (581.center) to (586.center);
		\draw [in=-165, out=90] (586.center) to (582);
		\draw [in=-15, out=90] (585.center) to (587);
		\draw (588.center) to (585.center);
		\draw (580.center) to (589);
		\draw [in=-165, out=90] (589) to (587);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (591) at (265.25, -3) {};
		\node [style=none] (592) at (265.25, -3.75) {};
		\node [style=none] (593) at (263.75, -3.75) {};
		\node [style=X] (594) at (264.25, -2) {};
		\node [style=Z] (595) at (265.75, -2) {};
		\node [style=none] (596) at (264.75, -3) {};
		\node [style=none] (597) at (266.25, -3) {};
		\node [style=none] (598) at (264.75, -3.75) {};
		\node [style=none] (599) at (266.25, -3.75) {};
		\node [style=none] (600) at (263.75, -3) {};
		\node [style=X] (601) at (266.25, -3) {$-a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (592.center) to (591.center);
		\draw [in=-165, out=90] (591.center) to (595);
		\draw [in=-15, out=90] (596.center) to (594);
		\draw [in=-15, out=90] (597.center) to (595);
		\draw (599.center) to (597.center);
		\draw (596.center) to (598.center);
		\draw (593.center) to (600.center);
		\draw [in=-165, out=90] (600.center) to (594);
	\end{pgfonlayer}
\end{tikzpicture}
\end{tabular}
$$
Which are analagous to the following commutations in  stabilizer circuits:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (161) at (151.25, 6) {$\eta$};
		\node [style=none] (162) at (150.75, 5.25) {};
		\node [style=none] (163) at (151.75, 5.25) {};
		\node [style=none] (164) at (150.75, 4.5) {};
		\node [style=none] (165) at (151.75, 4.5) {};
		\node [style=map] (166) at (150.75, 5.25) {${\cal Z}^a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (165.center) to (163.center);
		\draw [in=-30, out=90] (163.center) to (161);
		\draw [in=90, out=-150] (161) to (162.center);
		\draw (162.center) to (164.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (155) at (153.5, 6) {$\eta$};
		\node [style=none] (156) at (153, 5.25) {};
		\node [style=none] (157) at (154, 5.25) {};
		\node [style=none] (158) at (153, 4.5) {};
		\node [style=none] (159) at (154, 4.5) {};
		\node [style=map] (160) at (154, 5.25) {${\cal Z}^a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (159.center) to (157.center);
		\draw [in=-30, out=90] (157.center) to (155);
		\draw [in=90, out=-150] (155) to (156.center);
		\draw (156.center) to (158.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (167) at (151.25, 3.75) {$\eta$};
		\node [style=none] (168) at (150.75, 3) {};
		\node [style=none] (169) at (151.75, 3) {};
		\node [style=none] (170) at (150.75, 2.25) {};
		\node [style=none] (171) at (151.75, 2.25) {};
		\node [style=map] (172) at (150.75, 3) {${\cal X}^a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (171.center) to (169.center);
		\draw [in=-30, out=90] (169.center) to (167);
		\draw [in=90, out=-150] (167) to (168.center);
		\draw (168.center) to (170.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (173) at (153.5, 4) {$\eta$};
		\node [style=none] (174) at (153, 3.25) {};
		\node [style=none] (175) at (154, 3.25) {};
		\node [style=none] (176) at (153, 2.5) {};
		\node [style=none] (177) at (154, 2.5) {};
		\node [style=map] (178) at (154, 3.25) {${\cal X}^{-a}$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (177.center) to (175.center);
		\draw [in=-30, out=90] (175.center) to (173);
		\draw [in=90, out=-150] (173) to (174.center);
		\draw (174.center) to (176.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
Where moreover, for any Lagrangian relation $V$ and  $a,b \in \F_p$:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (294) at (183.25, -0.75) {};
		\node [style=none] (295) at (185.75, -0.75) {};
		\node [style=none] (296) at (185.75, -3) {};
		\node [style=none] (297) at (183.25, -3) {};
		\node [style=none] (298) at (183.5, -2.75) {$G$};
		\node [style=map] (299) at (184.5, -2.5) {$V$};
		\node [style=none] (300) at (183.5, -0.75) {};
		\node [style=none] (301) at (184, -0.75) {};
		\node [style=none] (302) at (185, -0.75) {};
		\node [style=none] (303) at (185.5, -0.75) {};
		\node [style=X] (304) at (183.5, -1.5) {$a$};
		\node [style=X] (305) at (185, -1.5) {$b$};
		\node [style=none] (306) at (184, -1.5) {};
		\node [style=none] (307) at (185.5, -1.5) {};
		\node [style=none] (308) at (184, -0.25) {};
		\node [style=none] (309) at (183.5, -0.25) {};
		\node [style=none] (310) at (184, -0.75) {};
		\node [style=none] (311) at (183.5, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (295.center) to (294.center);
		\draw (294.center) to (297.center);
		\draw (297.center) to (296.center);
		\draw (296.center) to (295.center);
		\draw [in=-90, out=45] (299) to (307.center);
		\draw (307.center) to (303.center);
		\draw (302.center) to (305);
		\draw [in=75, out=-90] (305) to (299);
		\draw [in=-90, out=105] (299) to (306.center);
		\draw (306.center) to (301.center);
		\draw (300.center) to (304);
		\draw [in=135, out=-90] (304) to (299);
		\draw (311.center) to (309.center);
		\draw (308.center) to (310.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (351) at (195, -0.75) {};
		\node [style=none] (352) at (198, -0.75) {};
		\node [style=none] (353) at (198, -2.25) {};
		\node [style=none] (354) at (195, -2.25) {};
		\node [style=none] (355) at (195.25, -2) {$G$};
		\node [style=map] (356) at (196.5, -1.75) {$V$};
		\node [style=none] (357) at (195.25, -0.75) {};
		\node [style=none] (358) at (196.5, -0.75) {};
		\node [style=none] (359) at (197.25, -0.75) {};
		\node [style=none] (360) at (197.75, -0.75) {};
		\node [style=none] (361) at (196.5, 0.25) {};
		\node [style=none] (362) at (196.5, -0.75) {};
		\node [style=none] (363) at (195.25, -0.75) {};
		\node [style=map] (364) at (195.25, 0.25) {${\cal Z}^a {\cal X}^b$};
		\node [style=none] (365) at (195.25, 1) {};
		\node [style=none] (366) at (196.5, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (352.center) to (351.center);
		\draw (351.center) to (354.center);
		\draw (354.center) to (353.center);
		\draw (353.center) to (352.center);
		\draw (361.center) to (362.center);
		\draw [in=270, out=90] (364) to (365.center);
		\draw [in=90, out=-90] (364) to (363.center);
		\draw [in=-90, out=135, looseness=0.75] (356) to (357.center);
		\draw [in=105, out=-90, looseness=0.75] (358.center) to (356);
		\draw [in=-90, out=75] (356) to (359.center);
		\draw [in=45, out=-90, looseness=0.75] (360.center) to (356);
		\draw (361.center) to (366.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

Therefore, functoriality follows by uncurrying the left and right hand sides of the previous equation.
\end{proof}



TODO FULLY INTRODUCE SPEKKENS TOY MODEL



\begin{theorem}
For odd prime $p$, $\Aff\Lag\Rel_{\F_p}$ is isomorphic to $\Stab_p$ and 
$\Aff\Lag\Rel_{\F_2}$ is isomorphic to Spekkens toy model.
\end{theorem}

\begin{corollary}
For odd prime $p$, $\Lag\Rel_{\F_p}$ is a presentation for stabilizer circuits without shift of boost operators.
\end{corollary}

\begin{theorem}
$\Aff\Lag\Rel_{k}$ is generated by two spiders both decorated by the additive group of $k^2$:
$$
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 5) {};
		\node [style=none] (1) at (22, 5) {};
		\node [style=none] (2) at (21, 2.5) {};
		\node [style=none] (3) at (22, 2.5) {};
		\node [style=Z] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
		\node [style=none] (7) at (21.5, 4.75) {};
		\node [style=none] (8) at (21.5, 2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (9) at (231.75, 0.5) {};
		\node [style=none] (10) at (231.75, -3) {};
		\node [style=Z] (11) at (231, -2) {};
		\node [style=none] (12) at (231.32, -1.25) {$\cdots$};
		\node [style=none] (13) at (231, -2.5) {$\cdots$};
		\node [style=none] (14) at (230.75, 0.5) {};
		\node [style=none] (15) at (229.25, -3) {};
		\node [style=X] (16) at (230, -0.5) {$n$};
		\node [style=none] (17) at (230, 0) {$\cdots$};
		\node [style=none] (18) at (229.72, -1.25) {$\cdots$};
		\node [style=none] (19) at (230, -3) {};
		\node [style=none] (20) at (230.25, -3) {};
		\node [style=none] (21) at (229.25, 0.5) {};
		\node [style=none] (22) at (231, 0.5) {};
		\node [style=scalar] (23) at (230.5, -1.25) {$m$};
		\node [style=none] (24) at (230, 0.25) {};
		\node [style=none] (25) at (231, -2.75) {};
		\node [style=none] (26) at (229.7, -1.5) {};
		\node [style=none] (27) at (231.3, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-30, out=90] (10.center) to (11);
		\draw [in=-90, out=30, looseness=0.75] (11) to (9.center);
		\draw [in=90, out=-150] (16) to (15.center);
		\draw [in=-90, out=30] (16) to (14.center);
		\draw (19.center) to (16);
		\draw [in=-150, out=90] (20.center) to (11);
		\draw [in=-90, out=150] (16) to (21.center);
		\draw (11) to (22.center);
		\draw [in=-75, out=150] (11) to (23);
		\draw [in=330, out=90] (23) to (16);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 5) {};
		\node [style=none] (1) at (22, 5) {};
		\node [style=none] (2) at (21, 2.5) {};
		\node [style=none] (3) at (22, 2.5) {};
		\node [style=X] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
		\node [style=none] (7) at (21.5, 4.75) {};
		\node [style=none] (8) at (21.5, 2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
:=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (232.75, 0.5) {};
		\node [style=none] (1) at (232.75, -3) {};
		\node [style=Z] (2) at (233.5, -2) {};
		\node [style=none] (3) at (233.25, -1.25) {$\cdots$};
		\node [style=none] (4) at (233.5, -2.5) {$\cdots$};
		\node [style=none] (5) at (233.75, 0.5) {};
		\node [style=none] (6) at (235.25, -3) {};
		\node [style=X] (7) at (234.5, -0.5) {$n$};
		\node [style=none] (8) at (234.5, 0) {$\cdots$};
		\node [style=none] (9) at (234.82, -1.25) {$\cdots$};
		\node [style=none] (10) at (234.5, -3) {};
		\node [style=none] (11) at (234.25, -3) {};
		\node [style=none] (12) at (235.25, 0.5) {};
		\node [style=none] (13) at (233.5, 0.5) {};
		\node [style=scalar] (14) at (234, -1.25) {$m$};
		\node [style=none] (15) at (233.25, -1) {};
		\node [style=none] (16) at (234.5, 0.25) {};
		\node [style=none] (17) at (233.5, -2.75) {};
		\node [style=none] (18) at (234.78, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-150, out=90] (1.center) to (2);
		\draw [in=-90, out=150, looseness=0.75] (2) to (0.center);
		\draw [in=90, out=-30] (7) to (6.center);
		\draw [in=-90, out=150] (7) to (5.center);
		\draw (10.center) to (7);
		\draw [in=-30, out=90] (11.center) to (2);
		\draw [in=-90, out=30] (7) to (12.center);
		\draw (2) to (13.center);
		\draw [in=-105, out=30] (2) to (14);
		\draw [in=-150, out=90] (14) to (7);
	\end{pgfonlayer}
\end{tikzpicture}
$$

The Fourier transform is derived by Euler composition:
$$
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.25, -1) {};
		\node [style=map] (1) at (1.25, -1.5) {$F$};
		\node [style=none] (2) at (1.25, -2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (1) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0.5, 1) {};
		\node [style=none] (1) at (0.5, -0.25) {};
		\node [style=none] (2) at (1, -0.25) {};
		\node [style=none] (3) at (1, 1) {};
		\node [style=s] (4) at (1, 0.5) {};
		\node [style=none] (5) at (0.5, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (4) to (3.center);
		\draw [in=90, out=-90] (4) to (1.center);
		\draw [in=-90, out=90] (2.center) to (5.center);
		\draw (5.center) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (19.5, 1.25) {};
		\node [style=Z] (1) at (18, 4.25) {};
		\node [style=none] (2) at (18, 4.75) {};
		\node [style=none] (3) at (19.5, 4.75) {};
		\node [style=none] (4) at (18, 0.75) {};
		\node [style=none] (5) at (19.5, 0.75) {};
		\node [style=X] (6) at (19.5, 1.25) {};
		\node [style=Z] (7) at (19.5, 4.25) {};
		\node [style=X] (8) at (18, 1.25) {};
		\node [style=Z] (9) at (18, 4.25) {};
		\node [style=X] (10) at (19.5, 1.25) {};
		\node [style=X] (11) at (18, 1.25) {};
		\node [style=X] (12) at (19.5, 1.25) {};
		\node [style=Z] (13) at (19.5, 4.25) {};
		\node [style=s] (14) at (17.75, 3) {};
		\node [style=s] (15) at (18.75, 3) {};
		\node [style=s] (16) at (19.75, 3) {};
		\node [style=s] (17) at (18.25, 3) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (1);
		\draw (5.center) to (0);
		\draw [bend right=45] (6) to (7);
		\draw [in=135, out=-135, looseness=1.25] (9) to (8);
		\draw (3.center) to (7);
		\draw (4.center) to (8);
		\draw [in=-120, out=15, looseness=0.75] (11) to (13);
		\draw [in=90, out=-105] (9) to (14);
		\draw [in=90, out=-45, looseness=0.75] (9) to (15);
		\draw [in=90, out=-90] (14) to (11);
		\draw [in=-90, out=120, looseness=0.75] (6) to (15);
		\draw [in=-15, out=90] (12) to (9);
		\draw [in=-90, out=150, looseness=0.75] (12) to (17);
		\draw [in=285, out=90] (17) to (9);
		\draw [in=-90, out=75, looseness=0.75] (12) to (16);
		\draw [in=-75, out=90] (16) to (13);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0, 0.75) {};
		\node [style=none] (1) at (0.75, 0.75) {};
		\node [style=none] (2) at (0, 3.25) {};
		\node [style=none] (3) at (0.75, 3.25) {};
		\node [style=Z] (4) at (0.75, 1.25) {};
		\node [style=X] (5) at (0, 1.75) {};
		\node [style=Z] (6) at (0.75, 2.25) {};
		\node [style=X] (7) at (0, 2.75) {};
		\node [style=Z] (8) at (0, 2.25) {};
		\node [style=X] (9) at (0.75, 1.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (4) to (5);
		\draw (6) to (7);
		\draw (8) to (9);
		\draw (1.center) to (4);
		\draw (4) to (9);
		\draw (9) to (6);
		\draw (6) to (3.center);
		\draw (2.center) to (7);
		\draw (7) to (8);
		\draw (8) to (5);
		\draw (5) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\left\llbracket
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.25, 0) {};
		\node [style=none] (1) at (1.25, -3.5) {};
		\node [style=Z] (2) at (1.25, -2.75) {$\hspace*{.05cm}0,1\hspace*{.05cm}$};
		\node [style=Z] (3) at (1.25, -0.75) {$\hspace*{.05cm}0,1\hspace*{.05cm}$};
		\node [style=X] (4) at (1.25, -1.75) {$\hspace*{.05cm}0,-1\hspace*{.05cm}$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (2);
		\draw (2) to (4);
		\draw (4) to (3);
		\draw (3) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right\rrbracket
$$



%Transporting the complex conjugation along the isomorphism $\Aff\Lag\Rel_k \cong \Stab_p$ yields a conjugation functor $\Aff\Lag\Rel_k\to \Aff\Lag\Rel_k$ such that:

%In $\Stab_p$ the spiders are linear maps:
%
%$$
%\left\llbracket
%\begin{tikzpicture}
%	\begin{pgfonlayer}{nodelayer}
%		\node [style=none] (0) at (21, 5) {};
%		\node [style=none] (1) at (22, 5) {};
%		\node [style=none] (2) at (21, 2.5) {};
%		\node [style=none] (3) at (22, 2.5) {};
%		\node [style=Z] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
%		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
%		\node [style=none] (6) at (21.5, 3) {$\cdots$};
%		\node [style=none] (7) at (21.5, 4.75) {};
%		\node [style=none] (8) at (21.5, 2.75) {};
%	\end{pgfonlayer}
%	\begin{pgfonlayer}{edgelayer}
%		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
%		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
%		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
%		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
%	\end{pgfonlayer}
%\end{tikzpicture}
%\right\rrbracket
%=
%\sum{}
%$$
%
%
%
%GIVE ACTION OF COMPLEX CONJUGATION
\end{theorem}






The spider fusion is pointwise  where $(a,b)=(n+k,m+\ell)$:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.5, -0.5) {};
		\node [style=none] (1) at (0.5, -0.5) {};
		\node [style=none] (2) at (1, -0.5) {$\cdots$};
		\node [style=none] (3) at (0.5, -2.75) {};
		\node [style=Z] (4) at (1, -1.25) {$n,m$};
		\node [style=none] (5) at (2, -0.5) {};
		\node [style=none] (6) at (1.5, -2.75) {$\cdots$};
		\node [style=none] (7) at (1, -2.75) {};
		\node [style=Z] (8) at (1.5, -2) {$k,\ell$};
		\node [style=none] (9) at (2, -2.75) {};
		\node [style=none] (10) at (1.25, -1.5) {\reflectbox{$\ddots$}};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-124, out=90] (3.center) to (4);
		\draw [in=-90, out=56] (4) to (0.center);
		\draw [in=124, out=-90] (1.center) to (4);
		\draw [in=-124, out=90] (7.center) to (8);
		\draw [in=90, out=-56] (8) to (9.center);
		\draw [in=-90, out=56] (8) to (5.center);
		\draw [bend left=45, looseness=1.25] (8) to (4);
		\draw [bend left=45, looseness=1.25] (4) to (8);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (11) at (4, -0.5) {};
		\node [style=none] (12) at (3, -0.5) {};
		\node [style=none] (13) at (3.5, -0.5) {$\cdots$};
		\node [style=none] (14) at (2.5, -2) {};
		\node [style=none] (15) at (3.5, -1.25) {};
		\node [style=none] (16) at (4.5, -0.5) {};
		\node [style=none] (17) at (3.5, -2) {$\cdots$};
		\node [style=none] (18) at (3, -2) {};
		\node [style=Z] (19) at (3.5, -1.25) {$a,b$};
		\node [style=none] (20) at (4, -2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-150, out=90] (14.center) to (15);
		\draw [in=-90, out=56] (15) to (11.center);
		\draw [in=124, out=-90] (12.center) to (15);
		\draw [in=-124, out=90] (18.center) to (19);
		\draw [in=90, out=-56] (19) to (20.center);
		\draw [in=-90, out=30] (19) to (16.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{1cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.5, -0.5) {};
		\node [style=none] (1) at (0.5, -0.5) {};
		\node [style=none] (2) at (1, -0.5) {$\cdots$};
		\node [style=none] (3) at (0.5, -2.75) {};
		\node [style=X] (4) at (1, -1.25) {$n,m$};
		\node [style=none] (5) at (2, -0.5) {};
		\node [style=none] (6) at (1.5, -2.75) {$\cdots$};
		\node [style=none] (7) at (1, -2.75) {};
		\node [style=X] (8) at (1.5, -2) {$k,\ell$};
		\node [style=none] (9) at (2, -2.75) {};
		\node [style=none] (10) at (1.25, -1.5) {\reflectbox{$\ddots$}};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-124, out=90] (3.center) to (4);
		\draw [in=-90, out=56] (4) to (0.center);
		\draw [in=124, out=-90] (1.center) to (4);
		\draw [in=-124, out=90] (7.center) to (8);
		\draw [in=90, out=-56] (8) to (9.center);
		\draw [in=-90, out=56] (8) to (5.center);
		\draw [bend left=45, looseness=1.25] (8) to (4);
		\draw [bend left=45, looseness=1.25] (4) to (8);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (11) at (4, -0.5) {};
		\node [style=none] (12) at (3, -0.5) {};
		\node [style=none] (13) at (3.5, -0.5) {$\cdots$};
		\node [style=none] (14) at (2.5, -2) {};
		\node [style=none] (15) at (3.5, -1.25) {};
		\node [style=none] (16) at (4.5, -0.5) {};
		\node [style=none] (17) at (3.5, -2) {$\cdots$};
		\node [style=none] (18) at (3, -2) {};
		\node [style=X] (19) at (3.5, -1.25) {$a,b$};
		\node [style=none] (20) at (4, -2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-150, out=90] (14.center) to (15);
		\draw [in=-90, out=56] (15) to (11.center);
		\draw [in=124, out=-90] (12.center) to (15);
		\draw [in=-124, out=90] (18.center) to (19);
		\draw [in=90, out=-56] (19) to (20.center);
		\draw [in=-90, out=30] (19) to (16.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

Call the first component of the phase group the {\bf affine phase} and the second component the {\bf linear phase}.  The white spider corresponds to the $Z$ basis and the grey spider corresponds to the $X$ basis.


As stabilizer circuits, the black spider is interpreted as follows (the white spiders are the same, but in the Fourier basis):

$$
\left\llbracket\
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 5) {};
		\node [style=none] (1) at (22, 5) {};
		\node [style=none] (2) at (21, 2.5) {};
		\node [style=none] (3) at (22, 2.5) {};
		\node [style=Z] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
		\node [style=none] (7) at (21.5, 4.75) {};
		\node [style=none] (8) at (21.5, 2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket
\propto
\sum_{j=0}^{p-1}  e^{ \pi \cdot i \cdot j \cdot m\cdot (m+p)/ p} | j+n,\ldots,j+n \rangle\langle j, \ldots, j|
$$

Notice that this implies that the phase groups of the frobenius algebras in odd prime dimensional stabilizer generating spiders are now the torus $(\Z/p\Z)^2$; this is in contrast to the qubit case where the phase groups are $\Z/4\Z$.


\begin{definition}
There is a monoidal conjugation functor $\bar{(\_)}:\Aff\Lag\Rel_k\to \Aff\Lag\Rel_k$ given by:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 5) {};
		\node [style=none] (1) at (22, 5) {};
		\node [style=none] (2) at (21, 2.5) {};
		\node [style=none] (3) at (22, 2.5) {};
		\node [style=Z] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
		\node [style=none] (7) at (21.5, 4.75) {};
		\node [style=none] (8) at (21.5, 2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (20.75, 5) {};
		\node [style=none] (1) at (22.25, 5) {};
		\node [style=none] (2) at (20.75, 2.5) {};
		\node [style=none] (3) at (22.25, 2.5) {};
		\node [style=Z] (4) at (21.5, 3.75) {};
		\node [style=none] (5) at (21.5, 4.75) {$\cdots$};
		\node [style=none] (6) at (21.5, 2.75) {$\cdots$};
		\node [style=Z] (9) at (21.5, 3.75) {$\hspace*{.05cm}-n,-m\hspace*{.05cm}$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{1cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (21, 5) {};
		\node [style=none] (1) at (22, 5) {};
		\node [style=none] (2) at (21, 2.5) {};
		\node [style=none] (3) at (22, 2.5) {};
		\node [style=X] (4) at (21.5, 3.75) {$\hspace*{.05cm}n,m\hspace*{.05cm}$};
		\node [style=none] (5) at (21.5, 4.5) {$\cdots$};
		\node [style=none] (6) at (21.5, 3) {$\cdots$};
		\node [style=none] (7) at (21.5, 4.75) {};
		\node [style=none] (8) at (21.5, 2.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (20.75, 5) {};
		\node [style=none] (1) at (22.25, 5) {};
		\node [style=none] (2) at (20.75, 2.5) {};
		\node [style=none] (3) at (22.25, 2.5) {};
		\node [style=X] (4) at (21.5, 3.75) {};
		\node [style=none] (5) at (21.5, 4.75) {$\cdots$};
		\node [style=none] (6) at (21.5, 2.75) {$\cdots$};
		\node [style=X] (9) at (21.5, 3.75) {$\hspace*{.05cm}n,-m\hspace*{.05cm}$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=150, out=-90, looseness=0.75] (0.center) to (4);
		\draw [in=90, out=-150, looseness=0.75] (4) to (2.center);
		\draw [in=-30, out=90, looseness=0.75] (3.center) to (4);
		\draw [in=-90, out=30, looseness=0.75] (4) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{definition}
In the case of $k=\F_p$ for $p$ an odd prime, this is transported to the complex conjugation along $\Aff\Lag\Rel_{\F_p} \cong \Stab_p$.  Therefore, composing the conjugation functor with the transpose, we can talk about which affine Lagrangian relations are unitary, isometries and so on over arbitrary fields.  This is very important for the following section.

In the quantum setting, a basis for the affine Lagrangian subspace corresponds to the stabilizer tableau for a pure stabilizer state (ie a stabilizer tableau on $n$ qudits with dimension $n$).
The novelty in interpreting stabilizer states in this categorical framework is that it reveals that the relational composition of tableaus is the composition of stabilizer circuits.


\section{Affine coisotropic relations and stabilizer codes}
\label{sec:coisotrel}


In this section we show that by only requiring that the morphisms are affine {\em coisotropic} subspaces   (subspaces $V$ so that $V^\omega \subseteq V$) instead of affine Lagrangian subspaces (where $V^\omega= V$), we can capture the maximally mixed state/discarding; with which we can recover state preparation and measurement compositionally.


\begin{theorem}[Relational purification]~\\
The prop $\Isot\Rel_k$ of isotropic relations is generated by adding the doubled zero relation to the image of the forgetful functor $\Lag\Rel_k\to\LinRel_k$, ie. the following generator in $\LinRel_k$:
$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 0.5) {};
		\node [style=X] (1) at (1, 0.5) {};
		\node [style=none] (2) at (0.5, 0) {};
		\node [style=none] (3) at (1, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
$
\end{theorem}
\begin{proof}
This generator is an isotropic subspace of $(k^{2n},\omega)$ since:
$$
\left(
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 0.5) {};
		\node [style=X] (1) at (1, 0.5) {};
		\node [style=none] (2) at (0.5, 0) {};
		\node [style=none] (3) at (1, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
\right)^\omega
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (0.5, 0.5) {};
		\node [style=Z] (1) at (1, 0.5) {};
		\node [style=none] (2) at (0.5, 0) {};
		\node [style=none] (3) at (1, 0) {};
		\node [style=s] (4) at (1, 0) {};
		\node [style=none] (5) at (1, -0.75) {};
		\node [style=none] (7) at (0.5, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (0) to (2.center);
		\draw [in=270, out=90] (7.center) to (4.center);
		\draw [in=90, out=-90] (2.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (0.5, 0.5) {};
		\node [style=Z] (1) at (1, 0.5) {};
		\node [style=none] (2) at (0.5, 0) {};
		\node [style=none] (3) at (1, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
\supset
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 0.5) {};
		\node [style=X] (1) at (1, 0.5) {};
		\node [style=none] (2) at (0.5, 0) {};
		\node [style=none] (3) at (1, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (3.center);
		\draw (0) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$



Suppose that we have an isotropic subspace $V$ of $(k^{2n},\omega)$ with dimension $n-1$. 

By applying Fourier transforms, we obtain a symplectomorphic subspace generated by a matrix whose pivots are all in the $Z$ block.  Therefore, we can row reduce this matrix to obtain one of the following form:

$$
\left[\begin{array}{cc|cc}
I_{n-1} & Z_B & X_A & X_B 
\end{array}\right]
$$

By applying controlled shift gates from the first $n-1$ wires to the last wire, we obtain an isotropic subspace $V'\cong V$ generated by a matrix of the following form:


$$
\left[\begin{array}{cc|cc}
I_{n-1} & 0 & X_A' & X_B' 
\end{array}\right]
$$

Since all of the rows of this subspace are orthogonal with respect to the symplectic form, we have:

\begin{align*}
0 &=
\left[\begin{array}{cc|cc}
I_{n-1} & 0 & X_A' & X_B' 
\end{array}\right]
\omega
\left[\begin{array}{cc|cc}
I_{n-1} & 0 & X_A' & X_B' 
\end{array}\right]^T\\
&=
\left[\begin{array}{cc|cc}
I_{n-1} & 0 & X_A' & X_B' 
\end{array}\right]
\left[\begin{array}{cc|cc}
 -X_A' & -X_B'  & I_{n-1} & 0
\end{array}\right]^T\\
&=
I_{n-1}(-X_A')^T +  0( -X_B' )^T +X_A'I_{n-1} + X_B' 0 \\
&=
(-X_A')^T +X_A'
\end{align*}
Which holds if and only if $X_A'=(X_A')^T$ is symmetric.

Therefore, the following matrix generates a Lagrangian subspace of $k^{2(n+1)}$ because the $Z$ block is the identity and the $X$ block is symmetric:
$$
\left[\begin{array}{ccc|ccc}
I_{n-1} & 0    & 0 & X_A'       & X_B' & 0\\
0           & 1 & 0 & (X_B')^T & 0     & 1 \\
0           & 0    & 1  & 0            & 1 & 0
\end{array}\right]
$$
Let $W$ be the Lagrangian subspace generated by this matrix.  Then
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, 0.5) {};
		\node [style=X] (1) at (1.5, 0.5) {};
		\node [style=map] (8) at (0.75, -0.5) {$W$};
		\node [style=none] (9) at (1, 0.5) {};
		\node [style=none] (10) at (0, 0.5) {};
		\node [style=none] (11) at (0, 1) {};
		\node [style=none] (12) at (1, 1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [bend left, looseness=0.75] (8) to (10.center);
		\draw [bend left=15] (8) to (0);
		\draw [bend right=15] (8) to (9.center);
		\draw [bend right, looseness=0.75] (8) to (1);
		\draw (11.center) to (10.center);
		\draw (9.center) to (12.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (15) at (3.25, -0.5) {$V'$};
		\node [style=none] (16) at (3.5, 0.25) {};
		\node [style=none] (17) at (3, 0.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [bend left=15, looseness=0.75] (15) to (17.center);
		\draw [bend right=15, looseness=0.75] (15) to (16.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
This follows because composing $W$ with the cozero maps on the last wire of the $X$ and $Z$ blocks picks out the rows where the last entries of the  $Z$ and $X$ blocks are both postselected to be $0$; that is, those of the generator matrix of $V'$. Then by applying the inverse controlled shift and inverse Fourier transform, to $V'$ we get back $V'$ again.  This yields a Lagrangian dilation of $V$.

Suppose that we have an isotropic subspace $V$ of $(k^{2n},\omega)$ with dimension $n-k$; by induction, $V$ can be purified to a  Lagrangian subspace of $k^{2(n+k)}$.
\end{proof}

Since, the symplectic complement reverses the order of inclusion, it extends to an isomorphism $\Co\Isot\Rel_k\cong \Isot\Rel_k$ so that we get a dual purification result:


\begin{corollary}
The prop $\Co\Isot\Rel_k$ of affine coisotropic relations is generated by adding the doubled discard relation to the image of the embedding $\Lag\Rel_k\to\LinRel_k$, ie. the linear relation
$
\begin{tikzpicture}[yscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (0, 0) {};
		\node [style=Z] (1) at (0.5, 0) {};
		\node [style=none] (2) at (0, 0.5) {};
		\node [style=none] (3) at (0.5, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (3.center);
		\draw (0.center) to (2.center);
	\end{pgfonlayer}
\end{tikzpicture}
$

\end{corollary}


From the same argument that yields $\Aff\Lag\Rel_k$ from $\Lag\Rel_k$ in \cite{lagrel}:

\begin{lemma}
The props $\Aff\Isot\Rel_k$ and $\Aff\Co\Isot\Rel_k$ are generated by adding the generator $X$ to $\Isot\Rel_k$ and $\Co\Isot\Rel_k$ respectively seen as categories of affine relations with trivial affine shift.
\end{lemma}


\begin{remark}
\label{rem:xdisc}
Unlike in the linear case, these two props are not isomorphic, as the doubled discard and  doubled cozero maps interact differently with the $X$ gate.  For example:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (1.75, -0.75) {$1$};
		\node [style=Z] (3) at (1.75, 0) {};
		\node [style=Z] (4) at (0.75, 0) {};
		\node [style=none] (9) at (1.75, -1.5) {};
		\node [style=none] (10) at (0.75, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0) to (9.center);
		\draw (0) to (3);
		\draw (10.center) to (4);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (3) at (1.75, 0) {};
		\node [style=Z] (4) at (0.75, 0) {};
		\node [style=none] (9) at (1.75, -1.5) {};
		\node [style=none] (10) at (0.75, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (10.center) to (4);
		\draw (9.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
\text{but}
\hspace*{.5cm}
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (1.75, -0.75) {$1$};
		\node [style=X] (3) at (1.75, 0) {};
		\node [style=X] (4) at (0.75, 0) {};
		\node [style=none] (9) at (1.75, -1.5) {};
		\node [style=none] (10) at (0.75, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0) to (9.center);
		\draw (0) to (3);
		\draw (10.center) to (4);
	\end{pgfonlayer}
\end{tikzpicture}
\neq
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (3) at (1.75, 0) {};
		\node [style=X] (4) at (0.75, 0) {};
		\node [style=none] (9) at (1.75, -1.5) {};
		\node [style=none] (10) at (0.75, -1.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (10.center) to (4);
		\draw (9.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
$$

\end{remark}

We extend the notion of a symplectic stabilizer group to the mixed setting:

\begin{definition}
Given some state $f:0\to n$ in $\CPM(\Aff\Lag\Rel_k)$ the (mixed)  {\bf symplectic stabilizer group} of $f$ is the subgroup of the generalized Pauli group generated by the Weyl operators $a \in P_k^n$ so that:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (2.25, 3.25) {};
		\node [style=none] (1) at (3.75, 3.25) {};
		\node [style=map] (2) at (3, 2.25) {$f$};
		\node [style=map] (3) at (3.75, 3.25) {$a$};
		\node [style=none] (4) at (3.75, 3.75) {};
		\node [style=none] (5) at (2.25, 3.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=45] (2) to (1.center);
		\draw [in=-90, out=135] (2) to (0.center);
		\draw (0.center) to (5.center);
		\draw (3) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (4, 3.25) {$a$};
		\node [style=none] (1) at (2.5, 3.25) {};
		\node [style=Z] (2) at (3, 2.75) {};
		\node [style=map] (3) at (3.75, 2) {$g$};
		\node [style=map] (4) at (2.25, 2) {$\bar g$};
		\node [style=none] (5) at (2.5, 3.25) {};
		\node [style=none] (6) at (4, 3.75) {};
		\node [style=none] (7) at (2.5, 3.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [bend right] (3) to (2);
		\draw [in=120, out=180, looseness=1.50] (2) to (4);
		\draw [in=-90, out=60] (4) to (1.center);
		\draw [in=-90, out=60] (3) to (0);
		\draw (5.center) to (7.center);
		\draw (0) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (4, 3.25) {};
		\node [style=none] (1) at (2.5, 3.25) {};
		\node [style=Z] (2) at (3, 2.75) {};
		\node [style=map] (3) at (3.75, 2) {$g$};
		\node [style=map] (4) at (2.25, 2) {$\bar g$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [bend right] (3) to (2);
		\draw [in=120, out=180, looseness=1.50] (2) to (4);
		\draw [in=-90, out=60] (4) to (1.center);
		\draw [in=-90, out=60] (3) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (19) at (11.75, 3.25) {};
		\node [style=none] (20) at (10.25, 3.25) {};
		\node [style=map] (21) at (11, 2.25) {$f$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=135] (21) to (20.center);
		\draw [in=-90, out=45] (21) to (19.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$


\end{definition}


This is needed to prove the essential uniqueness of purification for $\CPM(\Aff\Lag\Rel_k)$, generalizing the case for stabilizers:

\begin{proposition}[Essential uniqueness of quantum purification]~\\
\label{prop:uniqueness}
States in $\CPM(\Aff\Lag\Rel_k)$ are uniquely determined by their stabilizer groups.
\end{proposition}
\begin{proof}

Take dilations of two parallel maps in $\CPM(\Aff\Lag\Rel_k)$:

$$
(m,f:0\to n+m) \hspace*{.2cm}  
\text{of} \hspace*{.2cm} \hat f:0\to m 
\hspace*{.5cm}
\text{and}
\hspace*{.5cm}
(g:0\to n+\ell)
\hspace*{.2cm}  \text{of} \hspace*{.2cm}
\hat g:0\to m
$$ 

Take  $\hat f$ and $\hat g$ to have the same stabilizer groups, and without loss of generality take $m\geq \ell$. 

Consider the unitary  $u:m\to m$  and isometry $v:\ell\to m$, which perform Gaussian elimination on the ancillary space of $f$ and $g$.  Compose $u$ and $v$ on the ancillary spaces of $f$ and $g$, respectively; and then regard them as pure states.  These pure states both have the same stabilizer groups.  Therefore they span the same affine subspace:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, 2.25) {$f$};
		\node [style=none] (1) at (1.75, 4.25) {};
		\node [style=none] (2) at (2.75, 4.25) {};
		\node [style=map] (3) at (2.5, 3.25) {$u$};
		\node [style=none] (4) at (2.25, 4.25) {};
		\node [style=none] (5) at (3.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=255, out=105] (0) to (3);
		\draw [in=-90, out=120] (3) to (4.center);
		\draw [in=-45, out=30, looseness=1.25] (0) to (3);
		\draw [in=75, out=-90] (5.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, 2.25) {$g$};
		\node [style=none] (1) at (1.75, 4.25) {};
		\node [style=none] (2) at (2.75, 4.25) {};
		\node [style=map] (3) at (2.5, 3.25) {$v$};
		\node [style=none] (4) at (2.25, 4.25) {};
		\node [style=none] (5) at (3.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=255, out=105] (0) to (3);
		\draw [in=-90, out=120] (3) to (4.center);
		\draw [in=-45, out=30, looseness=1.25] (0) to (3);
		\draw [in=75, out=-90] (5.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
$$


Therefore:


$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (3.75, 2.25) {$f$};
		\node [style=none] (1) at (4.75, 4.25) {};
		\node [style=none] (2) at (4, 4.25) {};
		\node [style=map] (3) at (2, 2.25) {$\bar f$};
		\node [style=Z] (4) at (3.5, 3.75) {};
		\node [style=X] (5) at (1.75, 3.75) {};
		\node [style=none] (6) at (4.75, 4.25) {};
		\node [style=none] (7) at (4, 4.25) {};
		\node [style=none] (8) at (3, 4.25) {};
		\node [style=none] (9) at (2.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=45, out=-90] (1.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw [in=-15, out=75, looseness=1.25] (0) to (4);
		\draw [in=-135, out=150, looseness=1.50] (3) to (5);
		\draw [in=-90, out=105] (3) to (9.center);
		\draw [in=-90, out=30, looseness=0.75] (3) to (8.center);
		\draw [in=-165, out=75] (3) to (4);
		\draw [in=-15, out=150, looseness=1.25] (0) to (5);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (7.75, 2.25) {$f$};
		\node [style=none] (1) at (9, 3.5) {};
		\node [style=none] (2) at (8.5, 3.5) {};
		\node [style=map] (3) at (6, 2.25) {$\bar f$};
		\node [style=Z] (4) at (8, 4.25) {};
		\node [style=X] (5) at (5.75, 4.25) {};
		\node [style=none] (6) at (6.75, 4.75) {};
		\node [style=none] (7) at (6.25, 4.75) {};
		\node [style=map] (8) at (8, 3.5) {$u$};
		\node [style=map] (9) at (5.5, 3.25) {$\bar u$};
		\node [style=none] (10) at (9, 4.75) {};
		\node [style=none] (11) at (8.5, 4.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=45, out=-90] (1.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw [in=-90, out=105] (3) to (7.center);
		\draw [in=-90, out=30, looseness=0.75] (3) to (6.center);
		\draw [in=-15, out=75, looseness=1.25] (3) to (9);
		\draw [bend right, looseness=0.75] (9) to (3);
		\draw [bend left=45] (9) to (5);
		\draw [in=180, out=60, looseness=0.75] (9) to (4);
		\draw [in=120, out=0, looseness=0.50] (5) to (8);
		\draw [bend left=15] (8) to (0);
		\draw [in=-150, out=135, looseness=1.25] (0) to (8);
		\draw [bend right] (8) to (4);
		\draw (2.center) to (11.center);
		\draw (1.center) to (10.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (7.75, 2.25) {$g$};
		\node [style=none] (1) at (9, 3.5) {};
		\node [style=none] (2) at (8.5, 3.5) {};
		\node [style=map] (3) at (6, 2.25) {$\bar g$};
		\node [style=Z] (4) at (8, 4.25) {};
		\node [style=X] (5) at (5.75, 4.25) {};
		\node [style=none] (6) at (6.75, 4.75) {};
		\node [style=none] (7) at (6.25, 4.75) {};
		\node [style=map] (8) at (8, 3.5) {$v$};
		\node [style=map] (9) at (5.5, 3.25) {$\bar v$};
		\node [style=none] (10) at (9, 4.75) {};
		\node [style=none] (11) at (8.5, 4.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=45, out=-90] (1.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw [in=-90, out=105] (3) to (7.center);
		\draw [in=-90, out=30, looseness=0.75] (3) to (6.center);
		\draw [in=-15, out=75, looseness=1.25] (3) to (9);
		\draw [bend right, looseness=0.75] (9) to (3);
		\draw [bend left=45] (9) to (5);
		\draw [in=180, out=60, looseness=0.75] (9) to (4);
		\draw [in=120, out=0, looseness=0.50] (5) to (8);
		\draw [bend left=15] (8) to (0);
		\draw [in=-150, out=135, looseness=1.25] (0) to (8);
		\draw [bend right] (8) to (4);
		\draw (2.center) to (11.center);
		\draw (1.center) to (10.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (3.75, 2.25) {$g$};
		\node [style=none] (1) at (4.75, 4.25) {};
		\node [style=none] (2) at (4, 4.25) {};
		\node [style=map] (3) at (2, 2.25) {$\bar g$};
		\node [style=Z] (4) at (3.5, 3.75) {};
		\node [style=X] (5) at (1.75, 3.75) {};
		\node [style=none] (6) at (4.75, 4.25) {};
		\node [style=none] (7) at (4, 4.25) {};
		\node [style=none] (8) at (3, 4.25) {};
		\node [style=none] (9) at (2.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=45, out=-90] (1.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw [in=-15, out=75, looseness=1.25] (0) to (4);
		\draw [in=-135, out=150, looseness=1.50] (3) to (5);
		\draw [in=-90, out=105] (3) to (9.center);
		\draw [in=-90, out=30, looseness=0.75] (3) to (8.center);
		\draw [in=-165, out=75] (3) to (4);
		\draw [in=-15, out=150, looseness=1.25] (0) to (5);
	\end{pgfonlayer}
\end{tikzpicture}
$$

\end{proof}




\begin{theorem}[Essential uniqueness of relational purification]~\\
\label{them:dilation}
 $\CPM(\Aff\Lag\Rel_k) \cong \Aff\Co\Isot\Rel_k$
\end{theorem}


\begin{proof}

Because both categories are compact closed, it suffices to exhibit a functorial bijection between the states of both categories.
Consider the map $\CPM(\Aff\Lag\Rel_k) \cong \Aff\Co\Isot\Rel_k$, sending:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (3.75, 2.25) {$f$};
		\node [style=none] (1) at (4.75, 4.25) {};
		\node [style=none] (2) at (4, 4.25) {};
		\node [style=map] (3) at (2, 2.25) {$\bar f$};
		\node [style=Z] (4) at (3.5, 3.75) {};
		\node [style=X] (5) at (1.75, 3.75) {};
		\node [style=none] (6) at (4.75, 4.25) {};
		\node [style=none] (7) at (4, 4.25) {};
		\node [style=none] (8) at (3, 4.25) {};
		\node [style=none] (9) at (2.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=45, out=-90] (1.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw [in=-15, out=75, looseness=1.25] (0) to (4);
		\draw [in=-135, out=150, looseness=1.50] (3) to (5);
		\draw [in=-90, out=105] (3) to (9.center);
		\draw [in=-90, out=30, looseness=0.75] (3) to (8.center);
		\draw [in=-165, out=75] (3) to (4);
		\draw [in=-15, out=150, looseness=1.25] (0) to (5);
	\end{pgfonlayer}
\end{tikzpicture}
\mapsto
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, 2.25) {$f$};
		\node [style=none] (1) at (1.75, 4.25) {};
		\node [style=none] (2) at (2.75, 4.25) {};
		\node [style=Z] (10) at (2.25, 3.5) {};
		\node [style=Z] (11) at (3.25, 3.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=-90, out=105] (0) to (10);
		\draw [in=-90, out=45] (0) to (11);
	\end{pgfonlayer}
\end{tikzpicture}
$$
By Proposition \ref{prop:uniqueness}, this mapping is a full functor. For faithfulness, take maps $\hat f$ and $\hat g$ sent to the same affine coisotropic relation with dilations $(m,f:0\to n\oplus m)$ and  $(\ell,g:0\to n\oplus \ell )$ where $m\geq \ell$.
Then there is a unitary  $u:m\to m$  and isometry $v:\ell\to m$, which perform Gaussian elimination on the ancillary systems of $f$ and $g$ so that:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, 2.25) {$f$};
		\node [style=none] (1) at (1.75, 4.25) {};
		\node [style=none] (2) at (2.75, 4.25) {};
		\node [style=map] (3) at (2.5, 3.25) {$u$};
		\node [style=none] (4) at (2.25, 4.25) {};
		\node [style=none] (5) at (3.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=255, out=105] (0) to (3);
		\draw [in=-90, out=120] (3) to (4.center);
		\draw [in=-45, out=30, looseness=1.25] (0) to (3);
		\draw [in=75, out=-90] (5.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (2.5, 2.25) {$g$};
		\node [style=none] (1) at (1.75, 4.25) {};
		\node [style=none] (2) at (2.75, 4.25) {};
		\node [style=map] (3) at (2.5, 3.25) {$v$};
		\node [style=none] (4) at (2.25, 4.25) {};
		\node [style=none] (5) at (3.25, 4.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=135, out=-90] (1.center) to (0);
		\draw [in=-90, out=60] (0) to (2.center);
		\draw [in=255, out=105] (0) to (3);
		\draw [in=-90, out=120] (3) to (4.center);
		\draw [in=-45, out=30, looseness=1.25] (0) to (3);
		\draw [in=75, out=-90] (5.center) to (3);
	\end{pgfonlayer}
\end{tikzpicture}
$$

So that, as before, they are both dilations of $\hat f = \hat g$.
\end{proof}

\begin{corollary}
\label{cor:stabcode}
For odd prime $p$, $\Aff\Co\Isot\Rel_{\F_p}\cong \CPM(\Aff\Lag\Rel_{\F_p})\cong \CPM(\Stab_p)$.  That is, adding the discard relation to $\Aff\Lag\Rel_{\F_p}$ gives a semantics for {\bf mixed stabilizer circuits/stabilizer codes}, graphically:
$$
\left\llbracket \
\begin{tikzpicture}[yscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (0.25, 0) {};
		\node [ground] (1) at (0.25, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (2) at (4, 0) {};
		\node [style=Z] (3) at (4.5, 0) {};
		\node [style=none] (4) at (4, -1) {};
		\node [style=none] (5) at (4.5, -1) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (4.center) to (2);
		\draw (3) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\left\{ 
\left(
\begin{pmatrix}
z\\x
\end{pmatrix},
*
\right)
:\forall z,x \in \F_p
\right\}
$$
\end{corollary}

This formalizes the relationship between mixed stabilizer circuits and stabilizer tableaux with not-necessarily-full rank in  a compositional way. This presentation is similar in spirit to the way in which adding quantum discarding can often be presented by adding a generator which freely discarding the isometries, formalized by the discard construction \cite{discard}. Although in our case the quantum discarding is interpreted as the literal discard relation, therefore our semantics is still in affine relations.



Every stabilizer code has an associated affine isotropic subspace and affine coisotropic subspace taking the symplectic complement of the linear component of the affine subspace. However, as remarked earlier, their compositions as affine relations are different. The interpretation of the doubled zero postselection as the quantum discard map is not sound with respect to the composition of stabilizer circuits (see Remark \ref{rem:xdisc})
 Even though pure stabilizer states have larger stabilizer groups than mixed stabilizer states (stabilizer codes); the corresponding $\F_p$-linear subspaces have smaller dimensions.


\begin{corollary}
Moreover, $\Aff\Co\Isot\Rel_{\F_2}\cong \CPM(\Aff\Lag\Rel_{\F_2})$ is Spekkens' toy model with mixed states.
\end{corollary}

Recall for $p$ prime, $\Aff\Isot\Rel_{\F_p} \not \cong \Aff\Co\Isot\Rel_{\F_p}$. Therefore affine isotropic relations provides another epistemically restricted {\em toy theory} which is neither Spekkens' qubit toy model, nor qudit stabilizer quantum mechanics.

{\em Absolutely remarkably}, and seemingly out of nowhere, the odd prime $p$-dimensional qudit  stabilizer codes with trivial affine phase (no Pauli gates) can be expressed, modulo invertible phase, in terms of an iterated $\CPM$ construction with respect to the orthogonal complement at the inner level, and the complex conjugation at the outer level:
\begin{corollary}
For a prime number $p$, $\Isot\Rel_{\F_p}\cong\Co\Isot\Rel_{\F_p}\cong \CPM(\CPM(\LinRel_{\F_p},\perp),\bar{(\_)})$.
\end{corollary}
The astounding symmetry involved here begs the question if iterating the $\CPM$ construction more times yields anything physically interesting. Perhaps the work of \cite{CPMho} can shed some light on this question. 


To add classical types to the symplectic picture we need the following machinery:

\begin{definition}{\cite{idempotent}}
Fix  a $\dag$-compact closed category $\X$.
A {\bf projector} in $\X$ (also known as a $\dag$-idempotent) is an endomorphism $e$ such that $e;e=e$ and $e^\dag=e$.


Consider a class of projectors $\mathcal I$ in $\X$.  Then the {\bf $\dag$-Karoubi envelope} at $\mathcal I$, ${\sf Split}_{\mathcal I}^{\dag}(\X)$, is a $\dag$-compact closed category with:
\begin{description}
\item[\ \ Objects:] Pairs $(X,e)$ where $X$ is an object of $\X$ and $e$ is a projector on $X$.
\item[\ \ Maps:] A map $(e,f,m):(X,e)\to (Y,m)$ is a map $f:X\to Y$ in $\X$ such that $e;f;m=f$.
\item[\ \ Composition:] $(e,f,m);(m,g,\ell) = (e,f;g,\ell)$.
\item[\ \ Identities:] $1_{(X,e)}=(1_X,e,1_X)$.
\item[\ \ Dagger compact structure:] Pointwise.
\end{description}



Given any class of projectors $\mathcal I$, there is a $\dag$-compact closed embedding 
$\X\to{\sf Split}_{\mathcal I}^{\dag}(\X)$.

Let ${\sf Split}^{\dag}(\X):={\sf Split}_{\mathcal I}^{\dag}(\X)$ where $I$ is the class of all projectors in $\X$.
\end{definition}

Given  any projector $e:X\to X$, then the map $(e,1_X, 1_x) :(X,e)\to (X,1_X)$ is an isometry with adjoint $(1_X,1_X, e) :(X,1_X)\to (X,e)$ .
Because the projectors now factor through the identity, they are said to be {\bf split}. Moreover, 
${\sf Split}_{{\mathcal I }\cup \{ 1_X | X \in \X\}}^{\dag}(\X)$ is said to be the category obtained by {\bf splitting the projectors in $\mathcal I$}.


In \cite{idempotent}, they show that splitting projectors in $\CPM(\FHilb)$ yields a category where the the split projectors can be interpreted as classical types: the isometry  $(e,1_X, 1_x) :(X,e)\to (X,1_X)$ is regarded as the state preparation map and its adjoint $(1_X,1_X, e) :(X,1_X)\to (X,e)$  as measurement.


In order to add measurement and state preparation in the symplectic setting, we do the same:

\begin{definition}
The $X$ and $Z$ projectors are defined as follows in $\Aff\Co\Isot\Rel_{\F_p}$:
$$
p_X:=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=X] (0) at (0.5, -0.75) {};
		\node [style=none] (2) at (0.25, 0) {};
		\node [style=none] (4) at (1.25, 0.5) {};
		\node [style=Z] (5) at (0.75, 0) {};
		\node [style=Z] (6) at (1.75, 0) {};
		\node [style=Z] (7) at (1.5, -0.75) {};
		\node [style=none] (8) at (0.75, 0) {};
		\node [style=none] (9) at (1.25, 0) {};
		\node [style=none] (10) at (1.75, 0) {};
		\node [style=none] (11) at (0.5, -1.5) {};
		\node [style=none] (13) at (1.5, -1.5) {};
		\node [style=none] (14) at (0.25, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (7) to (9.center);
		\draw (7) to (13.center);
		\draw [in=60, out=-90] (10.center) to (7);
		\draw [in=60, out=-90] (8.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw (0) to (11.center);
		\draw (9.center) to (4.center);
		\draw (2.center) to (14.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (4) at (1, 0.5) {};
		\node [style=Z] (5) at (0.25, 0) {};
		\node [style=none] (9) at (1, -1.25) {};
		\node [style=none] (11) at (0.25, -1.25) {};
		\node [style=none] (14) at (0.25, 0.5) {};
		\node [style=Z] (15) at (0.25, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (9.center) to (4.center);
		\draw (14.center) to (5);
		\draw (11.center) to (15);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}
p_Z:=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (0.5, -0.75) {};
		\node [style=none] (2) at (0.25, 0) {};
		\node [style=none] (4) at (1.25, 0.5) {};
		\node [style=Z] (5) at (0.75, 0) {};
		\node [style=Z] (6) at (1.75, 0) {};
		\node [style=X] (7) at (1.5, -0.75) {};
		\node [style=none] (8) at (0.75, 0) {};
		\node [style=none] (9) at (1.25, 0) {};
		\node [style=none] (10) at (1.75, 0) {};
		\node [style=none] (11) at (0.5, -1.5) {};
		\node [style=none] (13) at (1.5, -1.5) {};
		\node [style=none] (14) at (0.25, 0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (7) to (9.center);
		\draw (7) to (13.center);
		\draw [in=60, out=-90] (10.center) to (7);
		\draw [in=60, out=-90] (8.center) to (0);
		\draw [in=-90, out=120] (0) to (2.center);
		\draw (0) to (11.center);
		\draw (9.center) to (4.center);
		\draw (2.center) to (14.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}[scale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (4) at (1, 0.5) {};
		\node [style=Z] (5) at (0.25, 0) {};
		\node [style=none] (9) at (1, -1.25) {};
		\node [style=none] (11) at (0.25, -1.25) {};
		\node [style=none] (14) at (0.25, 0.5) {};
		\node [style=Z] (15) at (0.25, -0.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (9.center) to (4.center);
		\draw (14.center) to (5);
		\draw (11.center) to (15);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{definition}


The $X$ projector discards and then codiscards the $Z$-gradient: cutting the $Z$ gradient in two so that no information is preserved, while acting trivially on the $X$ gradient.  Dually for the $Z$ projector. 

We will split only one of these projectors for simplicity:

\begin{definition}
Let $\Aff\Co\Isot\Rel_k^M= {\sf Split}_{\{p_Z^{\otimes n}, 1_n | n \in \N \}}^\dag(\Aff\Co\Isot\Rel_k)$ denote the two-coloured prop generated by splitting $p_Z$ in $\Aff\Co\Isot\Rel_k$.
Let $Q=(1_1,1_1)$ denote the original generating object and $C=(1_1,p_Z)$ the object obtained by splitting $p_Z$.
\end{definition}

We could have instead split $p_X$, or split both $p_X$ and $p_Z$; however, all three of these multicoloured props are equivalent.  This equivalence is witnessed via the Fourier transform. Indeed this suffices to split all nonzero projectors up to isomorphism because all projectors of the same dimension are isomorphic as affine coisotropic subspaces.  Therefore we can construct a nonzero projector of each possible dimension by composition with $p_X$ and affine symplectomorphisms.  
It is important to remark that the choice of projectors which are split effects the code-distance, because code-distance is basis dependent, and not invariant under equivalence.
We chose not to split the zero projector for the same reason why we did not chose to have it as an object in $\Aff\Rel_k$: for ease of notation.

\begin{remark}
The object $Q$ can be interpreted as a quantum channel and the object $C$ as a classical channel. Or equivalently, $C^{\otimes n}$ is interpreted as the space of logical qubits and  $Q^{\otimes m}$  as the space of physical qubits.
\end{remark}

This category has a nice presentation;  adding the affine relations to  $\Aff\Co\Isot\Rel_k$ obtained by cutting /splitting the $Z$ projector in two:


\begin{theorem}
The full subcategory of $\Aff\Co\Isot\Rel_k^M$ generated by tensor powers of $C$ is isomorphic to $\Aff\Rel_k$.
Therefore $\Aff\Co\Isot\Rel_k^M$ is isomorphic to adding the following linear relations to the image of $\Aff\Co\Isot\Rel_k^M\to \Aff\Co\Isot\Rel_k$ in the way which makes this into a two-coloured prop:
$$
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
\hspace*{.5cm}\text{and}\hspace*{.5cm}
\begin{tikzpicture}[scale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

\end{theorem}

We draw the classical wire in red to indicate the type, (although the colour is just syntactic sugar).

 The classical state ``lives'' on a single wire and the stabilizer state ``lives'' on the doubled wires.
Because of this, the  aforementioned circuits are interpreted in terms of state preparation (which we denote by the box labelled ``$a\mapsto|a\rangle$'') and measurement in the $Z$ basis:

$$
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[style=map,fill=white] at (0,0) {$ a \mapsto |a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,0) to (.1,-1);
		\draw (-.1,0) to (-.1,-1);
		\draw (0,1) to (0,0);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket 
=
\begin{tikzpicture}[xscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}\,\hspace*{1cm}
\left\llbracket \
\begin{circuitikz}
\node[meter] (meter) at (0,0) {};
\draw (.1,.5) to (.1,1);
\draw (-.1,.5) to (-.1,1);
\draw (0,-1) to (0,-.5);
\end{circuitikz} \ 
\right\rrbracket 
=
\begin{tikzpicture}[scale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$


For example, given any classical dit $x \in \F_p$, to prepare the state $|x\rangle$ is to take the composite:

$$
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[style=map,fill=white] at (0,0) {$ a \mapsto |a \rangle$};
		\node at (0,-1.2) {$a$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,0) to (.1,-1);
		\draw (-.1,0) to (-.1,-1);
		\draw (0,1) to (0,0);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket 
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.25, 0.75) {};
		\node [style=Z] (1) at (0.5, 0) {};
		\node [style=none] (3) at (0.5, 0.75) {};
		\node [style=X] (4) at (1.25, -0.75) {$x$};
		\node [style=none] (5) at (1.25, 0) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (3.center) to (1);
		\draw [style=red] (4) to (5.center);
		\draw (5.center) to (0.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1.25, 0.5) {};
		\node [style=Z] (1) at (0.5, 0) {};
		\node [style=none] (2) at (1.25, 0) {};
		\node [style=none] (3) at (0.5, 0.5) {};
		\node [style=X] (4) at (1.25, 0) {$x$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (2.center) to (0.center);
		\draw (3.center) to (1);
	\end{pgfonlayer}
\end{tikzpicture}
=
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (23, 2) {};
		\node [style=none] (1) at (23, 3) {};
		\node [style=none] (2) at (23, 1.75) {$|a\rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (1.center);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket 
$$

The state preparation and discarding in the $Z$ basis are obtained by composition of these morphisms with the Fourier transform; yielding morphisms which discard the $X$ wire instead of the $Z$ wire:

$$
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[meter] (meter) at (0,0) {};
		\node[style=map,fill=white] at (0,-1) {$\mathcal{F}^\dag$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,.5) to (.1,1);
		\draw (-.1,.5) to (-.1,1);
		\draw (0,-2) to (0,-.5);
	\end{pgfonlayer} 
\end{tikzpicture}\
\right\rrbracket 
=
\begin{tikzpicture}[yscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}\ ,
\hspace*{.8cm}
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[style=map,fill=white] at (0,0) {$ a \mapsto \mathcal{F}|a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,0) to (.1,-1);
		\draw (-.1,0) to (-.1,-1);
		\draw (0,1) to (0,0);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket 
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (3) at (24, 0.5) {};
		\node [style=Z] (4) at (24.75, 0) {};
		\node [style=none] (5) at (24, 0) {};
		\node [style=none] (6) at (24.75, 0.5) {};
		\node [style=none] (7) at (24, -0.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5.center) to (3.center);
		\draw (6.center) to (4);
		\draw [style=red] (7.center) to (5.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

\begin{remark}
In $\FHilb$, the state preparation and measurement in the $Z$ and $X$ bases are given by the following ZX-diagrams:

$$
\left\llbracket \
\begin{circuitikz}
\node[meter] (meter) at (0,0) {};
\draw (.1,.5) to (.1,1);
\draw (-.1,.5) to (-.1,1);
\draw (0,-1) to (0,-.5);
\end{circuitikz} \ 
\right\rrbracket =
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (182) at (49, 6) {};
		\node [style=none] (183) at (48.75, 7) {};
		\node [style=Z] (184) at (49.5, 6.75) {};
		\node [style=none] (185) at (49, 5.25) {};
		\node [style=none] (186) at (49.75, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (183.center) to (182);
		\draw (182) to (184);
		\draw (185.center) to (182);
		\draw [in=-60, out=90, looseness=0.75] (186.center) to (184);
	\end{pgfonlayer}
\end{tikzpicture},
\hspace*{.5cm}
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[style=map,fill=white] at (0,0) {$ a \mapsto |a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,0) to (.1,-1);
		\draw (-.1,0) to (-.1,-1);
		\draw (0,1) to (0,0);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket =
\begin{tikzpicture}[yscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (182) at (49, 6) {};
		\node [style=none] (183) at (48.75, 7) {};
		\node [style=Z] (184) at (49.5, 6.75) {};
		\node [style=none] (185) at (49, 5.25) {};
		\node [style=none] (186) at (49.75, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (183.center) to (182);
		\draw (182) to (184);
		\draw (185.center) to (182);
		\draw [in=-60, out=90, looseness=0.75] (186.center) to (184);
	\end{pgfonlayer}
\end{tikzpicture},
\hspace*{.5cm}
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[style=map,fill=white] at (0,0) {$ a \mapsto \mathcal{F}|a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,0) to (.1,-1);
		\draw (-.1,0) to (-.1,-1);
		\draw (0,1) to (0,0);
	\end{pgfonlayer}
\end{tikzpicture}\
\right\rrbracket 
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (188) at (50.75, 7) {};
		\node [style=Z] (189) at (51.5, 6.75) {};
		\node [style=none] (190) at (51, 5.25) {};
		\node [style=none] (191) at (51.75, 5.25) {};
		\node [style=X] (192) at (51, 6) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-60, out=90, looseness=0.75] (191.center) to (189);
		\draw (192) to (190.center);
		\draw [in=-90, out=120] (192) to (188.center);
		\draw (192) to (189);
	\end{pgfonlayer}
\end{tikzpicture},
\hspace*{.5cm}
\left\llbracket \
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[meter] (meter) at (0,0) {};
		\node[style=map,fill=white] at (0,-1) {$\mathcal{F}^\dag$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,.5) to (.1,1);
		\draw (-.1,.5) to (-.1,1);
		\draw (0,-2) to (0,-.5);
	\end{pgfonlayer} 
\end{tikzpicture}\
\right\rrbracket
=
\begin{tikzpicture}[yscale=-1]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (188) at (50.75, 7) {};
		\node [style=Z] (189) at (51.5, 6.75) {};
		\node [style=none] (190) at (51, 5.25) {};
		\node [style=none] (191) at (51.75, 5.25) {};
		\node [style=X] (192) at (51, 6) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-60, out=90, looseness=0.75] (191.center) to (189);
		\draw (192) to (190.center);
		\draw [in=-90, out=120] (192) to (188.center);
		\draw (192) to (189);
	\end{pgfonlayer}
\end{tikzpicture}
$$

The strong complementarity of the $X$ and $Z$ bases in this setting follows from the fact that their corresponding Frobenius algebras interact to form a Hopf algebra (see \cite{coecke2008interacting,pqp}):
$$
\left\llbracket\
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[meter] (meter) at (0,0) {};
		\node[style=map,fill=white] at (0,-1.1) {$\mathcal{F}^\dag$};
		\node[style=map,fill=white] at (0,-2) {$ a \mapsto |a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,.5) to (.1,1);
		\draw (-.1,.5) to (-.1,1);
		\draw (0,-.5) to (0,-2);
		\draw (.1,-2) to (.1,-3);
		\draw (-.1,-2) to (-.1,-3);
	\end{pgfonlayer} 
\end{tikzpicture}\
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (285) at (77.25, 6) {};
		\node [style=none] (286) at (77, 7) {};
		\node [style=Z] (287) at (77.75, 6.75) {};
		\node [style=none] (288) at (77, 4.5) {};
		\node [style=Z] (289) at (77.75, 4.75) {};
		\node [style=X] (290) at (77.25, 5.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=120, out=-90] (286.center) to (285);
		\draw (285) to (287);
		\draw [in=90, out=-120] (290) to (288.center);
		\draw (290) to (289);
		\draw (290) to (285);
		\draw [bend left] (287) to (289);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (291) at (78.75, 6.5) {};
		\node [style=none] (292) at (78.75, 7) {};
		\node [style=none] (293) at (78.75, 4.5) {};
		\node [style=X] (294) at (78.75, 5) {};
		\node [style=s] (295) at (79, 5.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (292.center) to (291);
		\draw (294) to (293.center);
		\draw [bend left] (294) to (291);
		\draw [in=90, out=-60] (291) to (295);
		\draw [in=-90, out=60] (294) to (295);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (297) at (79.75, 6) {};
		\node [style=none] (298) at (79.75, 7) {};
		\node [style=none] (299) at (79.75, 4.5) {};
		\node [style=X] (300) at (79.75, 5.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (298.center) to (297);
		\draw (300) to (299.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
The wire separates showing that preparing a state in the $X$ basis and measuring in the $Z$ basis preserves no information. However, in the symplectic picture, this result is purely topological:

$$
\left\llbracket\
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node[meter] (meter) at (0,0) {};
		\node[style=map,fill=white] at (0,-1.1) {$\mathcal{F}^\dag$};
		\node[style=map,fill=white] at (0,-2) {$ a \mapsto |a \rangle$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (.1,.5) to (.1,1);
		\draw (-.1,.5) to (-.1,1);
		\draw (0,-.5) to (0,-2);
		\draw (.1,-2) to (.1,-3);
		\draw (-.1,-2) to (-.1,-3);
	\end{pgfonlayer} 
\end{tikzpicture}\
\right\rrbracket
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (59, 6.25) {};
		\node [style=none] (1) at (59, 7) {};
		\node [style=Z] (2) at (59.5, 7) {};
		\node [style=none] (3) at (59.5, 6.25) {};
		\node [style=none] (4) at (59, 7.5) {};
		\node [style=none] (5) at (59.5, 5.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (0);
		\draw (3.center) to (2);
		\draw [style=red] (1.center) to (4.center);
		\draw [style=red] (5.center) to (3.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (219) at (59, 6.25) {};
		\node [style=none] (220) at (59, 6.75) {};
		\node [style=Z] (221) at (59, 5.75) {};
		\node [style=none] (222) at (59, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw[style=red]  (220.center) to (219);
		\draw[style=red]  (222.center) to (221);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{remark}


For this reason, we can prove the correctness of the quantum teleportation algorithm using only spider fusion (compare to the proofs given in \cite{abramsky,pqp}):


\begin{example}
\label{ex:teleportation}
Given any prime $p$, the following string diagram in $\Aff\Co\Isot\Rel_{\F_p}^M$ depicts the $p$-dimensional qudit quantum teleportation protocol where Alice on the left teleports a qudit to Bob, on the right. They share an EPR pair (on the bottom of the diagram)  and two classical dits (drawn in red).  


$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (223) at (62.5, 1.75) {};
		\node [style=none] (224) at (63, 3.25) {};
		\node [style=none] (225) at (62, 3.25) {};
		\node [style=none] (226) at (61.5, 1.75) {};
		\node [style=Z] (227) at (63, 4.75) {};
		\node [style=Z] (228) at (61.5, 4.75) {};
		\node [style=none] (229) at (66.75, 3.25) {};
		\node [style=none] (230) at (67.25, 3.25) {};
		\node [style=none] (231) at (66.75, 9) {};
		\node [style=none] (232) at (67.25, 9) {};
		\node [style=Z] (233) at (61.5, 3.25) {};
		\node [style=X] (234) at (62, 3.75) {};
		\node [style=Z] (235) at (63, 3.75) {};
		\node [style=X] (236) at (62.5, 3.25) {};
		\node [style=none] (237) at (62, 4.75) {};
		\node [style=none] (238) at (62.5, 4.75) {};
		\node [style=X] (239) at (64, 2.25) {};
		\node [style=Z] (240) at (65.5, 2.25) {};
		\node [style=Z] (241) at (66.75, 7.75) {};
		\node [style=X] (242) at (67.25, 7.75) {};
		\node [style=X] (243) at (66.75, 8.5) {};
		\node [style=Z] (244) at (67.25, 8.5) {};
		\node [style=Z] (245) at (65.5, 6.75) {};
		\node [style=Z] (246) at (66, 6.75) {};
		\node [style=none] (247) at (66.5, 6.75) {};
		\node [style=none] (248) at (65, 6.75) {};
		\node [style=none] (249) at (64.5, 9) {};
		\node [style=none] (250) at (64.5, 1.75) {};
		\node [style=none] (251) at (63.5, 9) {Alice};
		\node [style=none] (252) at (65.5, 9) {Bob};
		\node [style=none] (254) at (61, 4.75) {};
		\node [style=none] (255) at (67.75, 4.75) {};
		\node [style=none] (256) at (61, 6.75) {};
		\node [style=none] (257) at (67.75, 6.75) {};
		\node [style=none] (258) at (59, 6.75) {Phase correction};
		\node [style=none] (259) at (59, 4.75) {Measurement};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (234) to (233);
		\draw (236) to (235);
		\draw (224.center) to (235);
		\draw (235) to (227);
		\draw (226.center) to (233);
		\draw (233) to (228);
		\draw (225.center) to (234);
		\draw (223.center) to (236);
		\draw (236) to (238.center);
		\draw (234) to (237.center);
		\draw [in=15, out=-90, looseness=0.75] (229.center) to (239);
		\draw [in=-90, out=165, looseness=0.50] (239) to (225.center);
		\draw [in=165, out=-90, looseness=0.50] (224.center) to (240);
		\draw [in=-90, out=15, looseness=0.75] (240) to (230.center);
		\draw (244) to (242);
		\draw (243) to (241);
		\draw (229.center) to (241);
		\draw (243) to (231.center);
		\draw (232.center) to (244);
		\draw (242) to (230.center);
		\draw [in=-150, out=90, looseness=0.75] (245) to (244);
		\draw [in=-150, out=90] (246) to (241);
		\draw [color=red, in=-90, out=90, looseness=0.50] (238.center) to (247.center);
		\draw [color=red, in=-90, out=90] (237.center) to (248.center);
		\draw [in=210, out=90, looseness=0.75] (248.center) to (243);
		\draw [in=-150, out=90] (247.center) to (242);
		\draw [style=dotted] (250.center) to (249.center);
		\draw [style=dotted] (255.center) to (254.center);
		\draw [style=dotted] (257.center) to (256.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (301) at (81.75, 1.5) {};
		\node [style=none] (302) at (81.25, 3) {};
		\node [style=none] (303) at (80.75, 1.5) {};
		\node [style=none] (304) at (84.5, 3) {};
		\node [style=none] (305) at (85, 3) {};
		\node [style=none] (306) at (84.5, 8.5) {};
		\node [style=none] (307) at (85, 8.5) {};
		\node [style=X] (308) at (81.25, 4.5) {};
		\node [style=X] (309) at (82.75, 1.75) {};
		\node [style=Z] (310) at (83.75, 1.75) {};
		\node [style=X] (311) at (85, 7.25) {};
		\node [style=X] (312) at (84.5, 7.25) {};
		\node [style=Z] (313) at (83, 5) {};
		\node [style=X] (314) at (82, 4.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (302.center) to (308);
		\draw [in=15, out=-90, looseness=0.75] (304.center) to (309);
		\draw [in=-90, out=165, looseness=0.50] (309) to (302.center);
		\draw [in=-90, out=15, looseness=0.75] (310) to (305.center);
		\draw (312) to (306.center);
		\draw (311) to (305.center);
		\draw (311) to (307.center);
		\draw (304.center) to (312);
		\draw [in=90, out=-120] (308) to (303.center);
		\draw [color=red, in=225, out=90, looseness=0.75] (308) to (312);
		\draw [in=225, out=120, looseness=0.50, color=red] (314) to (311);
		\draw [in=15, out=-165] (313) to (314);
		\draw [in=270, out=90] (301.center) to (314);
		\draw [in=-60, out=135, looseness=0.75] (310) to (313);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (166) at (42.5, 1.5) {};
		\node [style=none] (167) at (42, 1.5) {};
		\node [style=none] (168) at (43.5, 8.5) {};
		\node [style=none] (169) at (44, 8.5) {};
		\node [style=X] (170) at (42, 4.5) {};
		\node [style=X] (171) at (42.5, 3.5) {};
		\node [style=X] (172) at (44, 6.25) {};
		\node [style=X] (173) at (43.5, 7.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-120, out=90, looseness=0.75] (166.center) to (171);
		\draw [in=270, out=60] (173) to (168.center);
		\draw [in=270, out=60, looseness=0.75] (172) to (169.center);
		\draw [color=red, bend left=15, looseness=0.50] (171) to (172);
		\draw [in=90, out=-120, looseness=0.50] (170) to (167.center);
		\draw [bend right=15, looseness=0.50] (171) to (172);
		\draw [bend left=15, looseness=0.50] (173) to (170);
		\draw [color=red, bend left=15, looseness=0.50] (170) to (173);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (174) at (45.5, 1.5) {};
		\node [style=none] (175) at (45, 1.5) {};
		\node [style=none] (176) at (45, 8.5) {};
		\node [style=none] (177) at (45.5, 8.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (177.center) to (174.center);
		\draw (175.center) to (176.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

\end{example}

Because $\Aff\Co\Isot\Rel_{\F_p}^M$ is a subcategory of relations, composable maps are ordered by subspace inclusion (ie, it is poset-enriched). Moreover, since all possible outcomes are equally likely we can identify when the measurement statistics of one process arise from the marginalization of of the measurement statistics of another process:

\begin{remark}
Take two odd-prime dimensional qudit stabilizer circuits with state preparations and measurement $f,g$ interpreted as parallel maps in  $\Aff\Co\Isot\Rel_{\F_p}^M$.
Then $f$ is a coarse-graining of $g$ when $f \subset g$ is a (strict)  affine subspace.
\end{remark}


\begin{example}
For an extreme example, the identity circuit on a classical wire is contained within  the circuit obtained by preparing in the $Z$ basis and measuring in the $X$:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (220) at (59, 6.75) {};
		\node [style=none] (222) at (59, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [style=red] (220.center) to (222);
	\end{pgfonlayer}
\end{tikzpicture}
\subset
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (219) at (59, 6.25) {};
		\node [style=none] (220) at (59, 6.75) {};
		\node [style=Z] (221) at (59, 5.75) {};
		\node [style=none] (222) at (59, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [style=red] (220.center) to (219);
		\draw [style=red] (222.center) to (221);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (59, 6.25) {};
		\node [style=none] (1) at (59, 7) {};
		\node [style=Z] (2) at (59.5, 7) {};
		\node [style=none] (3) at (59.5, 6.25) {};
		\node [style=none] (4) at (59, 7.75) {};
		\node [style=none] (5) at (59.5, 5.5) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (0);
		\draw (3.center) to (2);
		\draw [style=red] (5.center) to (3.center);
		\draw [style=red] (1.center) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

This is because, given any input state, the circuit on the right hand side can produce any output state; however, the identity circuit forces the inputs to be the same as the outputs.
\end{example}


\begin{example}
Similarly, the identity on a quantum wire is a coarse graining of the decoherence map:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (261) at (69.25, 6.75) {};
		\node [style=none] (263) at (69.25, 5.25) {};
		\node [style=none] (264) at (69.75, 6.75) {};
		\node [style=none] (265) at (69.75, 5.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (265.center) to (264.center);
		\draw (263.center) to (261.center);
	\end{pgfonlayer}
\end{tikzpicture}
\subset
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=Z] (0) at (69.25, 6.25) {};
		\node [style=none] (1) at (69.25, 6.75) {};
		\node [style=Z] (2) at (69.25, 5.75) {};
		\node [style=none] (3) at (69.25, 5.25) {};
		\node [style=none] (4) at (69.75, 6.75) {};
		\node [style=none] (5) at (69.75, 5.25) {};
		\node [style=none] (6) at (69.75, 6.25) {};
		\node [style=none] (7) at (69.75, 5.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (1.center) to (0);
		\draw (3.center) to (2);
		\draw [style=red] (7.center) to (6.center);
		\draw (5.center) to (7.center);
		\draw (6.center) to (4.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$
\end{example}

This two coloured prop also has a semantics in terms of electrical circuits, when changing the field from $\F_p$ to the field of fractions of real polynomials $\R(x)$.  It gives a well-structured semantics for a large fragment of the impedance calculus \cite{impedence}:

\begin{remark}
\label{rem:electrical}
$\Aff\Co\Isot\Rel_{\R(x)}^M$ is a semantics for the fragment of the impedance calculus generated by resistors, inductors, capacitors, controlled and uncontrolled voltage/current sources.
\end{remark}

This can be verified by factoring the generators in \cite{impedence} into the appropriate form. 


\section{Error correction}
\label{sec:qec}

%Recall the observation from Corollary \ref{cor:stabcode} that nonempty states in $\Aff\Co\Isot\Rel_{\F_p}$ correspond to stabilizer codes. Moreover an affine coisotropic subspace of $\F_p^{2n}$ with dimension $m$  interpreted as a state in $\CPM(\Stab_p)$ encodes $m-n$ logical qubits in $n$ physical qubits.  In the literature, these are the $[n,m-n]$ odd prime dimensional qudit stabilizer codes \cite{????}.  In this section we show how to model error correction protocols within this framework.  Starting with stabilizer codes and then extending this interpretation to topological stabilizer codes by looking at the quantized Weinstein category.

Quantum channels are inherently noisy, and it is an active area of study to protect quantum channels against errors.  Quantum error detection/correction protocols are often performed using stabilizer circuits, which is amenable to the symplectic formalism.  We will use our newfound categorical semantics for stabilier codes to describe quantum error correction protocols. 

\subsection{Stabilizer codes}


In this section, we show how to implement quantum error correction protocols for stabilizer codes using the string diagrams we developed in the previous section.   This generalizes the $\F_2$-linear subspace semantics of CSS codes in \cite{grok} to odd prime qudit dimensional stabilizer codes (as well as for qubit CSS codes).


Fix an odd prime $p$.
Consider an affine coisotropic subspace $S=L+a \subseteq \F_p^{2n}$ where $L$ has dimension $n+k$.  Then the associated projector on $n$-qudits is called a $[n,k]$-stabilizer code, as it encodes $k$ logical qudits into $n$ physical qudits. 
The relationship between logical and physical qubits can be understood in terms of pictures.
Fix a unitary purification $U$ of $S$:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (249) at (105.1, 3.25) {$S$};
		\node [style=none] (250) at (104.85, 4) {};
		\node [style=none] (251) at (105.35, 4) {};
		\node [style=none] (256) at (104.85, 4.25) {$n$};
		\node [style=none] (257) at (105.35, 4.25) {$n$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (249) to (250.center);
		\draw [in=-90, out=60] (249) to (251.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (249) at (105.1, 3.25) {$U$};
		\node [style=none] (250) at (104.85, 4) {};
		\node [style=none] (251) at (105.35, 4) {};
		\node [style=none] (252) at (103.85, 2) {};
		\node [style=none] (253) at (105.6, 2) {};
		\node [style=Z] (254) at (103.85, 2) {};
		\node [style=none] (255) at (106.35, 1.55) {$n-k$};
		\node [style=none] (256) at (104.85, 4.25) {$n$};
		\node [style=none] (257) at (105.35, 4.25) {$n$};
		\node [style=X] (258) at (106.35, 2) {};
		\node [style=Z] (259) at (104.6, 2) {};
		\node [style=none] (260) at (105.6, 1.5) {$k$};
		\node [style=none] (261) at (103.75, 1.5) {$k$};
		\node [style=none] (262) at (104.6, 1.5) {$n-k$};
		\node [style=Z] (263) at (105.6, 2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (249) to (250.center);
		\draw [in=-90, out=60] (249) to (251.center);
		\draw [in=-60, out=90] (253.center) to (249);
		\draw [in=90, out=-150] (249) to (252.center);
		\draw [in=-30, out=90] (258) to (249);
		\draw [in=90, out=-120] (249) to (259);
	\end{pgfonlayer}
\end{tikzpicture}
$$


The Lagrangian dilation of $S$, the {\bf encoder}, embeds $k$ logical qudits into $n$ physical qudits:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (249) at (105.1, 3.25) {$U$};
		\node [style=none] (250) at (104.85, 4) {};
		\node [style=none] (251) at (105.35, 4) {};
		\node [style=none] (252) at (103.85, 1.75) {};
		\node [style=none] (253) at (105.6, 1.75) {};
		\node [style=none] (255) at (106.35, 1.55) {$n-k$};
		\node [style=none] (256) at (104.85, 4.25) {$n$};
		\node [style=none] (257) at (105.35, 4.25) {$n$};
		\node [style=X] (258) at (106.35, 2) {};
		\node [style=Z] (259) at (104.6, 2) {};
		\node [style=none] (260) at (105.6, 1.25) {$k$};
		\node [style=none] (262) at (104.6, 1.5) {$n-k$};
		\node [style=none] (265) at (103.85, 1.25) {$k$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (249) to (250.center);
		\draw [in=-90, out=60] (249) to (251.center);
		\draw [in=-60, out=90] (253.center) to (249);
		\draw [in=90, out=-150] (249) to (252.center);
		\draw [in=-30, out=90] (258) to (249);
		\draw [in=90, out=-120] (249) to (259);
	\end{pgfonlayer}
\end{tikzpicture}
$$



Splitting this projector fixes a basis $\{b_1,\ldots, b_{n-k}\}$ for $L^\omega$, where the elements of the basis are pairwise orthogonal with respect to the symplectic form.  That is to say, they commute, which fixes the possible measurement outcomes:
$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (266) at (108.7, 3.25) {$U$};
		\node [style=none] (267) at (108.45, 4) {};
		\node [style=none] (268) at (108.95, 4) {};
		\node [style=none] (269) at (107.45, 2) {};
		\node [style=none] (270) at (109.2, 2) {};
		\node [style=Z] (271) at (107.45, 2) {};
		\node [style=none] (272) at (109.95, 1.05) {$n-k$};
		\node [style=none] (273) at (108.45, 4.25) {$n$};
		\node [style=none] (274) at (108.95, 4.25) {$n$};
		\node [style=Z] (276) at (108.2, 2) {};
		\node [style=none] (277) at (109.2, 1.5) {$k$};
		\node [style=none] (278) at (107.35, 1.5) {$k$};
		\node [style=none] (279) at (108.2, 1.5) {$n-k$};
		\node [style=none] (280) at (109.95, 1.5) {};
		\node [style=none] (281) at (109.95, 2) {};
		\node [style=Z] (282) at (109.2, 2) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-90, out=120] (266) to (267.center);
		\draw [in=-90, out=60] (266) to (268.center);
		\draw [in=-60, out=90] (270.center) to (266);
		\draw [in=90, out=-150] (266) to (269.center);
		\draw [in=90, out=-120] (266) to (276);
		\draw [in=-30, out=90] (281.center) to (266);
		\draw [style=red] (280.center) to (281.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

Suppose that Alice encodes a state and sends it to Bob on a noisy quantum channel with Pauli error $W(e)$.  To detect the error apply the non-destructive measurement with respect to our chosen basis on the last $n-k$ wires in the $Z$ basis conjugated by U:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (206) at (95, 2.75) {$U$};
		\node [style=none] (207) at (94, 1.25) {};
		\node [style=none] (208) at (95.25, 1.25) {};
		\node [style=X] (209) at (95.75, 1.5) {};
		\node [style=Z] (210) at (94.5, 1.5) {};
		\node [style=none] (211) at (96.75, 6) {};
		\node [style=none] (212) at (97.25, 6) {};
		\node [style=none] (213) at (98.75, 6) {};
		\node [style=none] (214) at (99.25, 6) {};
		\node [style=Z] (215) at (97.75, 6.25) {};
		\node [style=X] (216) at (97.25, 6) {};
		\node [style=Z] (217) at (97.75, 5.5) {};
		\node [style=none] (218) at (98, 8) {};
		\node [style=none] (219) at (98, 8) {};
		\node [style=Z] (220) at (99.25, 6) {};
		\node [style=X] (221) at (99.75, 6.25) {};
		\node [style=X] (222) at (99.75, 5.5) {};
		\node [style=none] (223) at (98, 8) {};
		\node [style=none] (224) at (98, 8) {};
		\node [style=Z] (225) at (97.75, 7) {};
		\node [style=none] (226) at (99.75, 9) {};
		\node [style=none] (227) at (99.75, 7) {};
		\node [style=map] (228) at (96.25, 3.75) {$W(e)$};
		\node [style=map] (229) at (98, 4.75) {$U^\dag$};
		\node [style=map] (230) at (98, 8) {$U$};
		\node [style=none] (231) at (97, 9) {};
		\node [style=none] (232) at (97.5, 9) {};
		\node [style=none] (233) at (98.5, 9) {};
		\node [style=none] (234) at (99, 9) {};
		\node [style=none] (235) at (96.25, 9) {};
		\node [style=none] (236) at (96.25, 1.25) {};
		\node [style=none] (237) at (100.25, 7) {};
		\node [style=none] (238) at (93.25, 7) {};
		\node [style=none] (239) at (100.25, 1.5) {};
		\node [style=none] (240) at (93.5, 1.5) {};
		\node [style=none] (241) at (92, 7.25) {Syndrome};
		\node [style=none] (242) at (92.25, 1.5) {Encoding};
		\node [style=none] (243) at (92.75, 2.75) {Alice};
		\node [style=none] (244) at (98.5, 2.75) {Bob};
		\node [style=none] (245) at (100.25, 3.75) {};
		\node [style=none] (246) at (93.25, 3.75) {};
		\node [style=none] (247) at (92.5, 3.75) {Error};
		\node [style=none] (248) at (92, 6.75) {Measurement};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-60, out=90, looseness=0.75] (208.center) to (206);
		\draw [in=90, out=-165] (206) to (207.center);
		\draw [in=-30, out=90] (209) to (206);
		\draw [in=90, out=-135] (206) to (210);
		\draw (215) to (216);
		\draw (217) to (215);
		\draw [in=-150, out=90] (211.center) to (219.center);
		\draw [in=-120, out=90, looseness=1.25] (216) to (218.center);
		\draw [in=-60, out=90, looseness=0.75] (213.center) to (224.center);
		\draw [in=90, out=-30, looseness=0.75] (223.center) to (220);
		\draw (220) to (221);
		\draw (221) to (222);
		\draw [style=red] (227.center) to (226.center);
		\draw (215) to (225);
		\draw (221) to (227.center);
		\draw [in=270, out=75, looseness=0.75] (206) to (228);
		\draw [in=-105, out=90, looseness=0.50] (228) to (229);
		\draw [in=-90, out=150] (229) to (211.center);
		\draw [in=135, out=-90] (212.center) to (229);
		\draw [in=-90, out=60] (229) to (213.center);
		\draw [in=30, out=-90, looseness=0.75] (214.center) to (229);
		\draw [in=-90, out=135] (230) to (231.center);
		\draw [in=-90, out=105] (230) to (232.center);
		\draw [in=-90, out=75] (230) to (233.center);
		\draw [in=-90, out=45] (230) to (234.center);
		\draw [style=dotted] (236.center) to (235.center);
		\draw [style=dotted] (238.center) to (237.center);
		\draw [style=dotted] (240.center) to (239.center);
		\draw [style=dotted] (246.center) to (245.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (68) at (53.25, 4) {};
		\node [style=none] (69) at (54.75, 4) {};
		\node [style=X] (70) at (55.25, 4.25) {};
		\node [style=Z] (71) at (53.75, 4.25) {};
		\node [style=none] (72) at (54.25, 7) {};
		\node [style=none] (73) at (54.25, 7) {};
		\node [style=none] (74) at (54.25, 7) {};
		\node [style=Z] (75) at (55, 6.25) {};
		\node [style=none] (76) at (54.25, 7) {};
		\node [style=none] (77) at (54.25, 7) {};
		\node [style=none] (78) at (56, 8) {};
		\node [style=none] (79) at (55, 6.25) {};
		\node [style=map] (80) at (54.25, 5.5) {$U;W(e);U^\dag$};
		\node [style=map] (81) at (54.25, 7) {$U$};
		\node [style=none] (82) at (53.25, 8) {};
		\node [style=none] (83) at (53.75, 8) {};
		\node [style=none] (84) at (54.75, 8) {};
		\node [style=none] (85) at (55.25, 8) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-30, looseness=0.75] (76.center) to (75);
		\draw [style=red, in=-90, out=45] (79.center) to (78.center);
		\draw [in=-90, out=135] (81) to (82.center);
		\draw [in=-90, out=105] (81) to (83.center);
		\draw [in=-90, out=75] (81) to (84.center);
		\draw [in=-90, out=45] (81) to (85.center);
		\draw [in=-90, out=45, looseness=0.75] (80) to (79.center);
		\draw [bend left=60, looseness=1.25] (80) to (81);
		\draw [in=90, out=-30] (80) to (70);
		\draw [bend left] (80) to (81);
		\draw [bend left] (81) to (80);
		\draw [in=-60, out=90] (69.center) to (80);
		\draw [in=-120, out=90] (71) to (80);
		\draw [in=-150, out=90] (68.center) to (80);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (86) at (57, 4.25) {};
		\node [style=none] (87) at (58.5, 4.25) {};
		\node [style=X] (88) at (59, 4.5) {};
		\node [style=Z] (89) at (57.5, 4.5) {};
		\node [style=none] (90) at (58, 7) {};
		\node [style=none] (91) at (58, 7) {};
		\node [style=none] (92) at (58, 7) {};
		\node [style=none] (94) at (58, 7) {};
		\node [style=none] (95) at (58, 7) {};
		\node [style=none] (96) at (59.75, 8) {};
		\node [style=none] (97) at (59.75, 6.25) {};
		\node [style=map] (98) at (58, 5.75) {$U;W(e);U^\dag$};
		\node [style=map] (99) at (58, 7) {$U$};
		\node [style=none] (100) at (57, 8) {};
		\node [style=none] (101) at (57.5, 8) {};
		\node [style=none] (102) at (58.5, 8) {};
		\node [style=none] (103) at (59, 8) {};
		\node [style=X] (104) at (59.75, 6.25) {$t$};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [style=red] (97.center) to (96.center);
		\draw [in=-90, out=135] (99) to (100.center);
		\draw [in=-90, out=105] (99) to (101.center);
		\draw [in=-90, out=75] (99) to (102.center);
		\draw [in=-90, out=45] (99) to (103.center);
		\draw [bend left=60] (98) to (99);
		\draw [in=90, out=-30] (98) to (88);
		\draw [bend left] (98) to (99);
		\draw [bend left] (99) to (98);
		\draw [in=-60, out=90] (87.center) to (98);
		\draw [in=-120, out=90] (89) to (98);
		\draw [in=-150, out=90] (86.center) to (98);
		\draw [bend right=60] (98) to (99);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (105) at (61.25, 4.25) {};
		\node [style=none] (106) at (62.75, 4.25) {};
		\node [style=X] (107) at (63.25, 4.5) {};
		\node [style=Z] (108) at (61.75, 4.5) {};
		\node [style=none] (114) at (64, 8) {};
		\node [style=none] (115) at (64, 6.25) {};
		\node [style=map] (116) at (62.25, 5.75) {$U$};
		\node [style=X] (122) at (64, 6.25) {$t$};
		\node [style=map] (123) at (62.25, 6.5) {$W(e)$};
		\node [style=none] (124) at (61.25, 8) {};
		\node [style=none] (125) at (61.75, 8) {};
		\node [style=none] (126) at (62.75, 8) {};
		\node [style=none] (127) at (63.25, 8) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [style=red] (115.center) to (114.center);
		\draw [in=90, out=-30] (116) to (107);
		\draw [in=-60, out=90] (106.center) to (116);
		\draw [in=-120, out=90] (108) to (116);
		\draw [in=-150, out=90] (105.center) to (116);
		\draw (116) to (123);
		\draw [in=-90, out=135] (123) to (124.center);
		\draw [in=-90, out=45] (123) to (127.center);
		\draw [in=60, out=-90] (126.center) to (123);
		\draw [in=-90, out=120] (123) to (125.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$

The tuple $t \in \F_p^{n-k}$ is called the {\bf syndrome}. The syndrome measures the displacement of the basis elements $b_i$ by errors.
An error $W(e)$ is {\bf undetectable} if and only if the syndrome is the zero vector; this is because $e$ commutes with everything in $L+a$ meaning that $e \in L^\omega+a$.  In particular, the trivial error is undetectable; so undetectable errors are indistinguishable from having no errors at all.


To correct errors, we construct am operation classically controlled from the syndrome register.
Given any syndrome measurement $t\in \F_p^{n-k}$, pick an error $W(e)$ which one wishes to correct, where additionally, the trivial syndrome corrects nothing.  This determines a function $f:\F_p^{n-k}\to\F_p^{2n}$ sending $t\mapsto e$.


If $f$ is an affine transformation, then we can construct the classically controlled error correction operation $c_f$ so that given a syndrome $t$, it applies the operation $W(-f(t))$ to $n$ qudits.  This restriction requiring the function to affine comes from the fact that within the model we have constructed, only affine classical processing is allowed.  The final error correction protocol is as follows:

$$
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=map] (0) at (145.75, 2.75) {$U$};
		\node [style=none] (1) at (144.75, 1.25) {};
		\node [style=none] (2) at (146, 1.25) {};
		\node [style=X] (3) at (146.5, 1.5) {};
		\node [style=Z] (4) at (145.25, 1.5) {};
		\node [style=none] (5) at (147.5, 6) {};
		\node [style=none] (6) at (148, 6) {};
		\node [style=none] (7) at (149.5, 6) {};
		\node [style=none] (8) at (150, 6) {};
		\node [style=Z] (9) at (148.5, 6.25) {};
		\node [style=X] (10) at (148, 6) {};
		\node [style=Z] (11) at (148.5, 5.5) {};
		\node [style=none] (12) at (148.75, 8) {};
		\node [style=none] (13) at (148.75, 8) {};
		\node [style=Z] (14) at (150, 6) {};
		\node [style=X] (15) at (150.5, 6.25) {};
		\node [style=X] (16) at (150.5, 5.5) {};
		\node [style=none] (17) at (148.75, 8) {};
		\node [style=none] (18) at (148.75, 8) {};
		\node [style=Z] (19) at (148.5, 7) {};
		\node [style=none] (20) at (150.25, 8.5) {};
		\node [style=none] (21) at (150.5, 7) {};
		\node [style=map] (22) at (147, 3.75) {$W(e)$};
		\node [style=map] (23) at (148.75, 4.75) {$U^\dag$};
		\node [style=map] (24) at (148.75, 8) {$U$};
		\node [style=none] (25) at (147, 11) {};
		\node [style=none] (26) at (147, 1.25) {};
		\node [style=none] (27) at (151, 7) {};
		\node [style=none] (28) at (144, 7) {};
		\node [style=none] (29) at (151, 1.5) {};
		\node [style=none] (30) at (144.25, 1.5) {};
		\node [style=none] (31) at (142.75, 7.25) {Syndrome};
		\node [style=none] (32) at (143, 1.5) {Encoding};
		\node [style=none] (33) at (143.5, 2.75) {Alice};
		\node [style=none] (34) at (149.25, 2.75) {Bob};
		\node [style=none] (35) at (151, 3.75) {};
		\node [style=none] (36) at (144, 3.75) {};
		\node [style=none] (37) at (143.25, 3.75) {Error};
		\node [style=none] (38) at (142.75, 6.75) {Measurement};
		\node [style=Z] (39) at (149.75, 8.5) {};
		\node [style=map] (40) at (148.75, 10) {$c_f$};
		\node [style=none] (41) at (147.75, 11) {};
		\node [style=none] (42) at (148.25, 11) {};
		\node [style=none] (43) at (149.25, 11) {};
		\node [style=none] (44) at (149.75, 11) {};
		\node [style=none] (45) at (151, 10) {};
		\node [style=none] (46) at (144, 10) {};
		\node [style=none] (47) at (142.5, 10) {Error correction};
		\node [style=Z] (48) at (150.5, 7.75) {};
		\node [style=none] (49) at (150.75, 11) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=-60, out=90, looseness=0.75] (2.center) to (0);
		\draw [in=90, out=-165] (0) to (1.center);
		\draw [in=-30, out=90] (3) to (0);
		\draw [in=90, out=-135] (0) to (4);
		\draw (9) to (10);
		\draw (11) to (9);
		\draw [in=-150, out=90] (5.center) to (13.center);
		\draw [in=-120, out=90, looseness=1.25] (10) to (12.center);
		\draw [in=-60, out=90, looseness=0.75] (7.center) to (18.center);
		\draw [in=90, out=-30, looseness=0.75] (17.center) to (14);
		\draw (14) to (15);
		\draw (15) to (16);
		\draw (9) to (19);
		\draw (15) to (21.center);
		\draw [in=270, out=75, looseness=0.75] (0) to (22);
		\draw [in=-105, out=90, looseness=0.50] (22) to (23);
		\draw [in=-90, out=150] (23) to (5.center);
		\draw [in=135, out=-90] (6.center) to (23);
		\draw [in=-90, out=60] (23) to (7.center);
		\draw [in=30, out=-90, looseness=0.75] (8.center) to (23);
		\draw [style=dotted] (26.center) to (25.center);
		\draw [style=dotted] (28.center) to (27.center);
		\draw [style=dotted] (30.center) to (29.center);
		\draw [style=dotted] (36.center) to (35.center);
		\draw [in=-90, out=120, looseness=0.75] (40) to (42.center);
		\draw [in=135, out=-90] (41.center) to (40);
		\draw [in=-90, out=60, looseness=0.75] (40) to (43.center);
		\draw [in=-90, out=45, looseness=0.75] (40) to (44.center);
		\draw [in=-165, out=150] (24) to (40);
		\draw [in=30, out=-30, looseness=1.25] (40) to (24);
		\draw [bend right=45] (24) to (40);
		\draw [bend right=45, looseness=0.75] (40) to (24);
		\draw [in=-15, out=90, looseness=0.75] (20.center) to (40);
		\draw [in=-105, out=90, looseness=0.75] (39) to (40);
		\draw [style=dotted] (46.center) to (45.center);
		\draw [style=red, in=-90, out=120] (48) to (20.center);
		\draw [style=red] (21.center) to (48);
		\draw [style=red, in=-90, out=60, looseness=0.50] (48) to (49.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (491) at (163.25, 6) {};
		\node [style=none] (492) at (164.75, 6) {};
		\node [style=X] (493) at (165.25, 6.25) {};
		\node [style=Z] (494) at (163.75, 6.25) {};
		\node [style=map] (495) at (164.25, 7.5) {$U$};
		\node [style=X] (496) at (165.25, 9) {$t$};
		\node [style=map] (497) at (164.25, 8.25) {$W(e)$};
		\node [style=none] (498) at (164.25, 10) {};
		\node [style=none] (499) at (164.25, 10) {};
		\node [style=none] (500) at (164.25, 10) {};
		\node [style=none] (501) at (164.25, 10) {};
		\node [style=none] (502) at (165.25, 9) {};
		\node [style=Z] (503) at (164, 9) {};
		\node [style=map] (504) at (164.25, 10) {$c_f$};
		\node [style=none] (505) at (163.25, 11) {};
		\node [style=none] (506) at (163.75, 11) {};
		\node [style=none] (507) at (164.75, 11) {};
		\node [style=none] (508) at (165.25, 11) {};
		\node [style=X] (509) at (166, 9) {$t$};
		\node [style=none] (510) at (166, 11) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-30] (495) to (493);
		\draw [in=-60, out=90] (492.center) to (495);
		\draw [in=-120, out=90] (494) to (495);
		\draw [in=-150, out=90] (491.center) to (495);
		\draw (495) to (497);
		\draw [in=-165, out=165, looseness=1.50] (497) to (498.center);
		\draw [in=-15, out=30] (497) to (501.center);
		\draw [in=60, out=-30] (500.center) to (497);
		\draw [in=-150, out=150, looseness=1.25] (497) to (499.center);
		\draw [in=-90, out=120, looseness=0.75] (504) to (506.center);
		\draw [in=135, out=-90] (505.center) to (504);
		\draw [in=-90, out=60, looseness=0.75] (504) to (507.center);
		\draw [in=-90, out=45, looseness=0.75] (504) to (508.center);
		\draw [in=0, out=90] (502.center) to (504);
		\draw [in=-120, out=90, looseness=1.25] (503) to (504);
		\draw [style=red] (509) to (510.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (466) at (155.75, 6) {};
		\node [style=none] (467) at (157.25, 6) {};
		\node [style=X] (468) at (157.75, 6.25) {};
		\node [style=Z] (469) at (156.25, 6.25) {};
		\node [style=map] (470) at (156.75, 7.5) {$U$};
		\node [style=map] (471) at (156.75, 8.25) {$W(e)$};
		\node [style=none] (472) at (155.75, 10.25) {};
		\node [style=none] (473) at (157.25, 10.25) {};
		\node [style=none] (474) at (156.25, 10.25) {};
		\node [style=none] (475) at (157.75, 10.25) {};
		\node [style=map] (476) at (156.75, 9) {$W(-f(t))$};
		\node [style=X] (477) at (158.5, 9) {$t$};
		\node [style=none] (478) at (158.5, 10.25) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-30] (470) to (468);
		\draw [in=-60, out=90] (467.center) to (470);
		\draw [in=-120, out=90] (469) to (470);
		\draw [in=-150, out=90] (466.center) to (470);
		\draw (470) to (471);
		\draw (471) to (476);
		\draw [in=-90, out=60] (476) to (473.center);
		\draw [in=-90, out=30, looseness=0.75] (476) to (475.center);
		\draw [in=-90, out=120] (476) to (474.center);
		\draw [in=-90, out=150, looseness=0.75] (476) to (472.center);
		\draw [style=red] (477) to (478.center);
	\end{pgfonlayer}
\end{tikzpicture}
=
\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (479) at (159.5, 6.25) {};
		\node [style=none] (480) at (161, 6.25) {};
		\node [style=X] (481) at (161.5, 6.5) {};
		\node [style=Z] (482) at (160, 6.5) {};
		\node [style=map] (483) at (160.5, 7.75) {$U$};
		\node [style=none] (484) at (159.5, 10) {};
		\node [style=none] (485) at (161, 10) {};
		\node [style=none] (486) at (160, 10) {};
		\node [style=none] (487) at (161.5, 10) {};
		\node [style=map] (488) at (160.5, 8.75) {$W(e-f(t))$};
		\node [style=X] (489) at (162.25, 8.75) {$t$};
		\node [style=none] (490) at (162.25, 10) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [in=90, out=-30] (483) to (481);
		\draw [in=-60, out=90] (480.center) to (483);
		\draw [in=-120, out=90] (482) to (483);
		\draw [in=-150, out=90] (479.center) to (483);
		\draw [in=-90, out=60] (488) to (485.center);
		\draw [in=-90, out=30, looseness=0.75] (488) to (487.center);
		\draw [in=-90, out=120] (488) to (486.center);
		\draw [in=-90, out=150, looseness=0.75] (488) to (484.center);
		\draw (483) to (488);
		\draw [style=red] (489) to (490.center);
	\end{pgfonlayer}
\end{tikzpicture}
$$


Note that this all works for $p=2$ when the stabilizer code has trivial phases: ie, it is a CSS code.


\begin{example}
TODO stabilizer code with affine correction
\end{example}


\begin{example}
TODO stabilizer code with nonaffine correction
\end{example}

